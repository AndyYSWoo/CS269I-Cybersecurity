{
    "abilities": {
        "can_manage_common_responses?": false, 
        "can_manage_collaborators?": false, 
        "can_reopen?": false, 
        "can_ban_researcher?": false, 
        "can_create_severity?": false, 
        "can_assign_to_h1_triage?": false, 
        "can_agree_on_going_public?": false, 
        "assignable_team_member_groups": [], 
        "can_view_credential_account_details?": false, 
        "can_export?": false, 
        "can_create_retest?": false, 
        "can_assign_to_user?": false, 
        "can_use_common_responses?": false, 
        "can_hide_timeline?": false, 
        "can_be_manually_disclosed?": false, 
        "assignable_team_members": [], 
        "can_clone?": false, 
        "can_be_publicly_disclosed?": false, 
        "can_close_comments?": false, 
        "can_view_bounty_weights?": false, 
        "can_suggest_bounty_amount?": false, 
        "can_cancel_disclosure_request?": false, 
        "can_redact?": false, 
        "can_change_structured_scope?": false, 
        "can_post_internal_comments?": false, 
        "can_change_state?": false, 
        "can_change_weakness?": false, 
        "can_add_comment?": false, 
        "can_reassign_to_team?": false, 
        "can_change_title?": false, 
        "can_award_bounty?": false, 
        "can_award_swag?": false, 
        "can_close?": false, 
        "can_manage?": false
    }, 
    "comments_closed?": false, 
    "substate": "resolved", 
    "bug_reporter_agreed_on_going_public_at": "2016-12-17T02:30:48.705Z", 
    "voters": [
        "eveeez", 
        "madrobot", 
        "mpz", 
        "japz", 
        "spetr0x", 
        "janhacker", 
        "bvdbijl", 
        "hackerjuan", 
        "xcom"
    ], 
    "facebook_team?": false, 
    "has_bounty?": true, 
    "bounty_amount": "10000.0", 
    "rejected_anc_report_that_can_be_sent_back_to_anc_triagers?": false, 
    "original_report_id": null, 
    "id": 181874, 
    "can_view_team": true, 
    "team_member_agreed_on_going_public_at": "2016-12-16T19:51:25.211Z", 
    "vulnerability_information": "There is an invalid memory read on mruby when calling to `remove_method` with invalid arguments which causes a SIGSEGV which leads into denial of service.\n\n## Sample\n\nThe following code tries to remove a method using a `nil` as argument\n```ruby\nclass Child\n   remove_method nil\nend\n```\n\nThere are many other variants, such as using a float, an integer, a string, a Class, etc... Which obviously are non valid method symbols.\n```ruby\nclass Child\n   remove_method 1\n   remove_method 2.123\n   remove_method 'aaaa'\n   remove_method Child\nend\n```\n\n## Crash\n\nHere we can see the crash (full crash output attached)\n```\n$ ruby bin/sandbox ../triage/uniq/min/segv/mrb_type > /tmp/full-crash.log\nbin/sandbox:20: [BUG] Segmentation fault at 0x0000000000000e\nruby 2.3.1p112 (2016-04-26) [x86_64-linux-gnu]\n\n-- Control frame information -----------------------------------------------\nc:0003 p:---- s:0010 e:000009 CFUNC  :sandbox_eval\nc:0002 p:0201 s:0005 E:001e48 EVAL   bin/sandbox:20 [FINISH]\nc:0001 p:0000 s:0002 E:001e00 (none) [FINISH]\n\n-- Ruby level backtrace information ----------------------------------------\nbin/sandbox:20:in `<main>'\nbin/sandbox:20:in `sandbox_eval'\n\n-- Machine register context ------------------------------------------------\n RIP: 0x00007f8c4d77d554 RBP: 0x00007f8c4c2fe4e0 RSP: 0x00007f8c4c2fc898\n RAX: 0x000000000000008f RBX: 0x0000000000000006 RCX: 0x00007f8c4d7fbf83\n RDX: 0x000000000000008f RDI: 0x00007f8c4c2fe4e0 RSI: 0x0000000000000006\n  R8: 0x00007f8c4d7f842f  R9: 0x00007f8c4c2fe010 R10: 0x0000000000000191\n R11: 0x00007f8c4d77d540 R12: 0x0000000000000010 R13: 0x000000000000008f\n R14: 0x00007f8c4c306160 R15: 0x00007f8c4c306100 EFL: 0x0000000000010246\n\n-- C level backtrace information -------------------------------------------\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a96ea5]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a970dc]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51971364]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a22dbe]\n/lib/x86_64-linux-gnu/libpthread.so.0 [0x7f8c516f5ed0]\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_respond_to+0x14) [0x7f8c4d77d554] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/boxing_word.h:71\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_check_convert_type+0x6b) [0x7f8c4d78c63b] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:310\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_check_string_type+0x1c) [0x7f8c4d7897cc] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/string.c:1743\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(join_ary+0xad) [0x7f8c4d78fe0d] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1007\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_ary_join+0x2e) [0x7f8c4d790dbe] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1031\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vformat+0x14b) [0x7f8c4d7a28cb] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:345\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_name_error+0x92) [0x7f8c4d7a2ae2] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:382\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_mod_remove_method+0x137) [0x7f8c4d77c3c7] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1985\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vm_exec+0x762) [0x7f8c4d795cf2] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1165\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vm_run+0x57) [0x7f8c4d79b567] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:766\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mruby_engine_monitored_eval+0x113) [0x7f8c4d76f173] ../../../../ext/mruby_engine/eval_monitored.c:68\n/lib/x86_64-linux-gnu/libpthread.so.0 [0x7f8c516ec464]\n/lib/x86_64-linux-gnu/libc.so.6(__clone+0x6d) [0x7f8c50a6830d]\n\n```\n\n## Crash debug\n\n```\n(gdb) r\nStarting program: /usr/bin/ruby bin/sandbox /tmp/crasher.rb\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\n[New Thread 0x7ffff7ff5700 (LWP 21707)]\n[New Thread 0x7ffff2348700 (LWP 21758)]\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2348700 (LWP 21758)]\nmrb_class (v=..., mrb=mrb@entry=0x7ffff23494e0) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/class.h:50\n50          return mrb_obj_ptr(v)->c;\n(gdb) x/1i $rip\n=> 0x7ffff37c8554 <mrb_respond_to+20>:  mov    rsi,QWORD PTR [rsi+0x8]\n(gdb) i r rsi\nrsi            0x6      6\n(gdb) x/1xg $rsi+0x8\n0xe:    Cannot access memory at address 0xe\n```\n\nThe crash happens at `ext/mruby_engine/mruby/include/mruby/class.h:50`\n```c\nstatic inline struct RClass*\nmrb_class(mrb_state *mrb, mrb_value v)\n{\n  switch (mrb_type(v)) {\n  case MRB_TT_FALSE:\n    if (mrb_fixnum(v))\n      return mrb->false_class;\n    return mrb->nil_class;\n  case MRB_TT_TRUE:\n    return mrb->true_class;\n  case MRB_TT_SYMBOL:\n    return mrb->symbol_class;\n  case MRB_TT_FIXNUM:\n    return mrb->fixnum_class;\n  case MRB_TT_FLOAT:\n    return mrb->float_class;\n  case MRB_TT_CPTR:\n    return mrb->object_class;\n  case MRB_TT_ENV:\n    return NULL;\n  default:\n    return mrb_obj_ptr(v)->c;  /* BUG: Bad memory access */\n  }\n}\n```\n\nIf we check the vale `v`:\n```\n(gdb) print v\n$1 = {\n  value = {\n    p = 0x6,\n    {\n      i_flag = 0,\n      i = 3\n    },\n    {\n      sym_flag = 6,\n      sym = 0\n    },\n    bp = 0x6,\n    fp = 0x6,\n    vp = 0x6\n  },\n  w = 6\n}\n```\n`mrb_obj_ptr` is the following macro\n```c\n#define mrb_obj_ptr(v)   ((struct RObject*)(mrb_ptr(v)))\n```\n\nSo `mrb_obj_ptr(v)->c` would be equivalent to this:\n```\n(gdb) print ((struct RObject*)v)->c\nCannot access memory at address 0xe\n(gdb) print &((struct RObject*)v)->c\n$2 = (struct RClass **) 0xe\n```\n\nIf we check the backtrace:\n```\n(gdb) bt\n#0  mrb_class (v=..., mrb=mrb@entry=0x7ffff23494e0) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/class.h:50\n#1  mrb_respond_to (mrb=mrb@entry=0x7ffff23494e0, obj=obj@entry=..., mid=mid@entry=143)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1492\n#2  0x00007ffff37d763b in convert_type (raise=0 '\\000', method=0x7ffff384342f \"to_str\", tname=0x7ffff3844446 \"String\", val=..., mrb=0x7ffff23494e0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:310\n#3  mrb_check_convert_type (mrb=mrb@entry=0x7ffff23494e0, val=..., type=type@entry=MRB_TT_STRING, tname=tname@entry=0x7ffff3844446 \"String\",\n    method=method@entry=0x7ffff384342f \"to_str\") at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:352\n#4  0x00007ffff37d47cc in mrb_check_string_type (mrb=mrb@entry=0x7ffff23494e0, str=..., str@entry=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/string.c:1743\n#5  0x00007ffff37dae0d in join_ary (mrb=mrb@entry=0x7ffff23494e0, ary=ary@entry=..., sep=sep@entry=..., list=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1007\n#6  0x00007ffff37dbdbe in mrb_ary_join (mrb=mrb@entry=0x7ffff23494e0, ary=ary@entry=..., sep=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1031\n#7  0x00007ffff37ed8cb in mrb_vformat (mrb=mrb@entry=0x7ffff23494e0, format=0x7ffff3843547 \"method '%S' not defined in %S\", ap=ap@entry=0x7ffff23479a8)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:345\n#8  0x00007ffff37edae2 in mrb_name_error (mrb=mrb@entry=0x7ffff23494e0, id=id@entry=0, fmt=fmt@entry=0x7ffff3843547 \"method '%S' not defined in %S\")\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:382\n#9  0x00007ffff37c73c7 in remove_method (mid=0, mod=..., mrb=0x7ffff23494e0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1985\n#10 mrb_mod_remove_method (mrb=0x7ffff23494e0, mod=...) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:2006\n#11 0x00007ffff37e0cf2 in mrb_vm_exec (mrb=mrb@entry=0x7ffff23494e0, proc=<optimized out>, proc@entry=0x7ffff2351520, pc=<optimized out>)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1165\n#12 0x00007ffff37e6567 in mrb_vm_run (mrb=0x7ffff23494e0, proc=0x7ffff2351520, self=..., stack_keep=stack_keep@entry=0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:766\n#13 0x00007ffff37ba173 in mruby_engine_monitored_eval (data=0x7ffff23493e0) at ../../../../ext/mruby_engine/eval_monitored.c:68\n#14 0x00007ffff7737464 in start_thread (arg=0x7ffff2348700) at pthread_create.c:333\n#15 0x00007ffff6ab330d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\n(gdb)\n```\n\nWe can see that whenever the desired method to delete is not found, mruby will raise an error. This is handled by `remove_method()` at `ext/mruby_engine/mruby/src/class.c:1985`:\n```c\nstatic void\nremove_method(mrb_state *mrb, mrb_value mod, mrb_sym mid)\n{\n  struct RClass *c = mrb_class_ptr(mod);\n  khash_t(mt) *h = find_origin(c)->mt;\n  khiter_t k;\n\n  if (h) {\n    k = kh_get(mt, mrb, h, mid);\n    if (k != kh_end(h)) {\n      kh_del(mt, mrb, h, k);\n      mrb_funcall(mrb, mod, \"method_removed\", 1, mrb_symbol_value(mid));\n      return;\n    }\n  }\n\n  mrb_name_error(mrb, mid, \"method '%S' not defined in %S\",\n    mrb_sym2str(mrb, mid), mod);  /* <--- Raise an error */\n}\n```\n\nLater on, mruby tries to convert the symbol in order to print it which is what causes the crash.\n\n## Proposed fix\n\nAs the arguments for `remove_method()` should at least be a method type symbol. I propose the following check at `mrb_mod_remove_method()`\n```diff\ndiff --git a/src/class.c b/src/class.c\nindex 47a6c84..a898b46 100644\n--- a/src/class.c\n+++ b/src/class.c\n@@ -2003,6 +2003,11 @@ mrb_mod_remove_method(mrb_state *mrb, mrb_value mod)\n\n   mrb_get_args(mrb, \"*\", &argv, &argc);\n   while (argc--) {\n+\n+    /* Crash fix. Ignore invalid types */\n+    if ((!argv->value.sym) || (argv->value.sym_flag != MRB_SYMBOL_FLAG))\n+      mrb_raise(mrb, E_TYPE_ERROR, \"Invalid type for remove_method\");\n+\n     remove_method(mrb, mod, mrb_symbol(*argv));\n     argv++;\n   }\n```\n\nmruby with the fix applied stops the crash:\n```\n$ bin/sandbox /tmp/crasher.rb\nbin/sandbox:20:in `sandbox_eval': Invalid type for remove_method (MRubyEngine::EngineRuntimeError)\n        from bin/sandbox:20:in `<main>'\n```\n\n## Impact\nThis is not exploitable and its impact its limited to DoS of the service running the ruby sandbox.", 
    "activity_page_count": 1, 
    "severity": {
        "rating": "high", 
        "author_type": "Team"
    }, 
    "title": "SIGSEGV when invalid argument on remove_method", 
    "is_member_of_team?": null, 
    "vote_count": 9, 
    "summaries": [
        {
            "category": "team", 
            "can_create?": false, 
            "can_view?": true
        }, 
        {
            "category": "researcher", 
            "can_create?": false, 
            "can_view?": true
        }
    ], 
    "structured_scope": null, 
    "allow_singular_disclosure_at": "2017-01-15T19:51:25.252Z", 
    "state": "Closed", 
    "cve_ids": [], 
    "activity_page_number": 1, 
    "readable_substate": "Resolved", 
    "public": true, 
    "formatted_bounty": "$10,000", 
    "attachments": [
        {
            "file_name": "crasher.rb", 
            "type": "text/x-c++", 
            "id": 134419, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/134/419/875cc25b77a18c61df16d11f9bc6df2903421862/crasher.rb?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T224542Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=a0a4f838f1014cc9b58dd0ffb8c36aaf3858cfaf4142715a1283cd7ee1ed919c"
        }, 
        {
            "file_name": "full-crash.log", 
            "type": "text/plain", 
            "id": 134420, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/134/420/d89cc0e09814c1af6048e3b0e89819dbc69d6853/full-crash.log?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T224542Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=1435f73e500f6cdfea0d278c85f33d7824a39f5a6ceaa2617e89019b2747b72a"
        }, 
        {
            "file_name": "proposed-fix.patch", 
            "type": "text/x-diff", 
            "id": 134422, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/134/422/c190a0e6cac0e6f3716c04a3ce56e552e0d7e089/proposed-fix.patch?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T224542Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=e25999549b39b19eca99173d77598ca88bb9308e9ca9afc1686c1e6b5a87144a"
        }
    ], 
    "singular_disclosure_disabled": false, 
    "activities": [
        {
            "automated_response": false, 
            "created_at": "2016-11-14T22:43:53.046Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-14T22:43:53.046Z", 
            "actor": {
                "username": "bvdbijl", 
                "url": "/bvdbijl", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Thank you for your report! We've reproduced the issue, and our engineering team is investigating.", 
            "markdown_message": "<p>Thank you for your report! We&#39;ve reproduced the issue, and our engineering team is investigating.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1299454, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-14T22:47:36.109Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-14T22:47:36.109Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Thank you for your report! We've reproduced the issue, and our engineering team is investigating.", 
            "markdown_message": "<p>Thank you for your report! We&#39;ve reproduced the issue, and our engineering team is investigating.</p>\n", 
            "type": "Activities::BugTriaged", 
            "id": 1299462, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-14T22:47:42.973Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-14T22:47:42.973Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "additional_data": {
                "new_severity": "High", 
                "old_severity": null
            }, 
            "team_handle": "shopify-scripts", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportSeverityUpdated", 
            "id": 1299463, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "reporter": {
                "username": "jpenalbae", 
                "url": "/jpenalbae"
            }, 
            "created_at": "2016-11-16T21:16:13.956Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-16T21:16:13.956Z", 
            "actor": {
                "username": "francoischagnon", 
                "url": "/francoischagnon", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/168/3b5130025fbf90eaeb1c9234baa340dfead68f44_medium.jpg?1429126005"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Hi @jpenalbae, thanks again for the report and the patch. We've deployed a fix for this in our production environment as of earlier today.\n\nI'm marking this issue as resolved now but we still need to fix this bug upstream before we can assess the impact & determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.", 
            "markdown_message": "<p>Hi <a href=\"/jpenalbae\">@jpenalbae</a>, thanks again for the report and the patch. We&#39;ve deployed a fix for this in our production environment as of earlier today.</p>\n\n<p>I&#39;m marking this issue as resolved now but we still need to fix this bug upstream before we can assess the impact &amp; determine a final bounty amount. This may take a few weeks since we received a large number of valid issues and we want to calibrate our payouts across all of them.</p>\n", 
            "type": "Activities::BugResolved", 
            "id": 1303161, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-25T15:43:23.941Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-25T15:43:23.941Z", 
            "actor": {
                "username": "francoischagnon", 
                "url": "/francoischagnon", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/168/3b5130025fbf90eaeb1c9234baa340dfead68f44_medium.jpg?1429126005"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "The fix for this issue has been merged upstream: https://github.com/mruby/mruby/pull/3284/files", 
            "markdown_message": "<p>The fix for this issue has been merged upstream: <a title=\"https://github.com/mruby/mruby/pull/3284/files\" href=\"/redirect?signature=62634f383dc84eb2fba04ab172f5df904f7789e0&amp;url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fpull%2F3284%2Ffiles\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://github.com/mruby/mruby/pull/3284/files</span><i class=\"icon-external-link\"></i></a></p>\n", 
            "type": "Activities::Comment", 
            "id": 1319225, 
            "genius_execution_id": null
        }, 
        {
            "bounty_currency": "usd", 
            "automated_response": false, 
            "created_at": "2016-12-16T19:51:19.037Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-16T19:51:19.037Z", 
            "actor": {
                "url": "/shopify-scripts", 
                "profile": {
                    "name": "shopify-scripts"
                }, 
                "ibb": false, 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/015/668/b50db49e93f656e202ae6f94b4c0821d1184134b_medium.jpg?1475592254"
                }
            }, 
            "team_handle": "shopify-scripts", 
            "bounty_amount": "10000.0", 
            "collaborator": {
                "username": "jpenalbae", 
                "url": "/jpenalbae"
            }, 
            "message": "Thanks for helping improve the security of Shopify Scripts and the mruby project!", 
            "markdown_message": "<p>Thanks for helping improve the security of Shopify Scripts and the mruby project!</p>\n", 
            "type": "Activities::BountyAwarded", 
            "id": 1370030, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-12-16T19:51:25.230Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-16T19:51:25.230Z", 
            "actor": {
                "username": "andrewdunbar", 
                "url": "/andrewdunbar", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/164/cd46f5270ea41c5f0da3bea93e2eca7a95858caf_medium.jpg?1427927985"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "first_to_agree": true, 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1370031, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-12-17T02:30:48.728Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-17T02:30:48.728Z", 
            "actor": {
                "username": "jpenalbae", 
                "url": "/jpenalbae", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1370767, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-12-17T02:30:48.782Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-17T02:30:48.782Z", 
            "actor": {
                "username": "jpenalbae", 
                "url": "/jpenalbae", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportBecamePublic", 
            "id": 1370768, 
            "genius_execution_id": null
        }
    ], 
    "in_validation?": false, 
    "is_participant": false, 
    "singular_disclosure_allowed": true, 
    "reporter": {
        "username": "jpenalbae", 
        "hacker_mediation": false, 
        "hackerone_triager": false, 
        "disabled": false, 
        "url": "/jpenalbae", 
        "profile_picture_urls": {
            "small": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
        }, 
        "is_me?": false
    }, 
    "weakness": {
        "id": 48, 
        "name": "Denial of Service"
    }, 
    "is_external_bug": false, 
    "visibility": "full", 
    "allow_singular_disclosure_after": -59626456.945503086, 
    "disclosed_at": "2016-12-17T02:30:48.759Z", 
    "stage": 4, 
    "url": "https://hackerone.com/reports/181874", 
    "created_at": "2016-11-13T05:35:56.082Z", 
    "original_report_url": null, 
    "vulnerability_information_html": "<p>There is an invalid memory read on mruby when calling to <code>remove_method</code> with invalid arguments which causes a SIGSEGV which leads into denial of service.</p>\n\n<h2 id=\"sample\">Sample</h2>\n\n<p>The following code tries to remove a method using a <code>nil</code> as argument</p>\n<pre class=\"highlight ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">Child</span>\n   <span class=\"n\">remove_method</span> <span class=\"kp\">nil</span>\n<span class=\"k\">end</span>\n</code></pre>\n<p>There are many other variants, such as using a float, an integer, a string, a Class, etc... Which obviously are non valid method symbols.</p>\n<pre class=\"highlight ruby\"><code><span class=\"k\">class</span> <span class=\"nc\">Child</span>\n   <span class=\"n\">remove_method</span> <span class=\"mi\">1</span>\n   <span class=\"n\">remove_method</span> <span class=\"mi\">2</span><span class=\"o\">.</span><span class=\"mi\">123</span>\n   <span class=\"n\">remove_method</span> <span class=\"s1\">&#39;aaaa&#39;</span>\n   <span class=\"n\">remove_method</span> <span class=\"no\">Child</span>\n<span class=\"k\">end</span>\n</code></pre>\n<h2 id=\"crash\">Crash</h2>\n\n<p>Here we can see the crash (full crash output attached)</p>\n<pre class=\"highlight plaintext\"><code>$ ruby bin/sandbox ../triage/uniq/min/segv/mrb_type &gt; /tmp/full-crash.log\nbin/sandbox:20: [BUG] Segmentation fault at 0x0000000000000e\nruby 2.3.1p112 (2016-04-26) [x86_64-linux-gnu]\n\n-- Control frame information -----------------------------------------------\nc:0003 p:---- s:0010 e:000009 CFUNC  :sandbox_eval\nc:0002 p:0201 s:0005 E:001e48 EVAL   bin/sandbox:20 [FINISH]\nc:0001 p:0000 s:0002 E:001e00 (none) [FINISH]\n\n-- Ruby level backtrace information ----------------------------------------\nbin/sandbox:20:in `&lt;main&gt;&#39;\nbin/sandbox:20:in `sandbox_eval&#39;\n\n-- Machine register context ------------------------------------------------\n RIP: 0x00007f8c4d77d554 RBP: 0x00007f8c4c2fe4e0 RSP: 0x00007f8c4c2fc898\n RAX: 0x000000000000008f RBX: 0x0000000000000006 RCX: 0x00007f8c4d7fbf83\n RDX: 0x000000000000008f RDI: 0x00007f8c4c2fe4e0 RSI: 0x0000000000000006\n  R8: 0x00007f8c4d7f842f  R9: 0x00007f8c4c2fe010 R10: 0x0000000000000191\n R11: 0x00007f8c4d77d540 R12: 0x0000000000000010 R13: 0x000000000000008f\n R14: 0x00007f8c4c306160 R15: 0x00007f8c4c306100 EFL: 0x0000000000010246\n\n-- C level backtrace information -------------------------------------------\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a96ea5]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a970dc]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51971364]\n/usr/lib/x86_64-linux-gnu/libruby-2.3.so.2.3 [0x7f8c51a22dbe]\n/lib/x86_64-linux-gnu/libpthread.so.0 [0x7f8c516f5ed0]\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_respond_to+0x14) [0x7f8c4d77d554] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/boxing_word.h:71\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_check_convert_type+0x6b) [0x7f8c4d78c63b] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:310\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_check_string_type+0x1c) [0x7f8c4d7897cc] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/string.c:1743\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(join_ary+0xad) [0x7f8c4d78fe0d] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1007\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_ary_join+0x2e) [0x7f8c4d790dbe] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1031\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vformat+0x14b) [0x7f8c4d7a28cb] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:345\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_name_error+0x92) [0x7f8c4d7a2ae2] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:382\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_mod_remove_method+0x137) [0x7f8c4d77c3c7] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1985\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vm_exec+0x762) [0x7f8c4d795cf2] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1165\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mrb_vm_run+0x57) [0x7f8c4d79b567] /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:766\n/home/jaime/research/shopy/mruby-engine/lib/mruby_engine/mruby_engine.so(mruby_engine_monitored_eval+0x113) [0x7f8c4d76f173] ../../../../ext/mruby_engine/eval_monitored.c:68\n/lib/x86_64-linux-gnu/libpthread.so.0 [0x7f8c516ec464]\n/lib/x86_64-linux-gnu/libc.so.6(__clone+0x6d) [0x7f8c50a6830d]\n\n</code></pre>\n<h2 id=\"crash-debug\">Crash debug</h2>\n<pre class=\"highlight plaintext\"><code>(gdb) r\nStarting program: /usr/bin/ruby bin/sandbox /tmp/crasher.rb\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.\n[New Thread 0x7ffff7ff5700 (LWP 21707)]\n[New Thread 0x7ffff2348700 (LWP 21758)]\n\nProgram received signal SIGSEGV, Segmentation fault.\n[Switching to Thread 0x7ffff2348700 (LWP 21758)]\nmrb_class (v=..., mrb=mrb@entry=0x7ffff23494e0) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/class.h:50\n50          return mrb_obj_ptr(v)-&gt;c;\n(gdb) x/1i $rip\n=&gt; 0x7ffff37c8554 &lt;mrb_respond_to+20&gt;:  mov    rsi,QWORD PTR [rsi+0x8]\n(gdb) i r rsi\nrsi            0x6      6\n(gdb) x/1xg $rsi+0x8\n0xe:    Cannot access memory at address 0xe\n</code></pre>\n<p>The crash happens at <code>ext/mruby_engine/mruby/include/mruby/class.h:50</code></p>\n<pre class=\"highlight c\"><code><span class=\"k\">static</span> <span class=\"kr\">inline</span> <span class=\"k\">struct</span> <span class=\"n\">RClass</span><span class=\"o\">*</span>\n<span class=\"nf\">mrb_class</span><span class=\"p\">(</span><span class=\"n\">mrb_state</span> <span class=\"o\">*</span><span class=\"n\">mrb</span><span class=\"p\">,</span> <span class=\"n\">mrb_value</span> <span class=\"n\">v</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n  <span class=\"k\">switch</span> <span class=\"p\">(</span><span class=\"n\">mrb_type</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">))</span> <span class=\"p\">{</span>\n  <span class=\"k\">case</span> <span class=\"n\">MRB_TT_FALSE</span><span class=\"p\">:</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">mrb_fixnum</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">))</span>\n      <span class=\"k\">return</span> <span class=\"n\">mrb</span><span class=\"o\">-&gt;</span><span class=\"n\">false_class</span><span class=\"p\">;</span>\n    <span class=\"k\">return</span> <span class=\"n\">mrb</span><span class=\"o\">-&gt;</span><span class=\"n\">nil_class</span><span class=\"p\">;</span>\n  <span class=\"k\">case</span> <span class=\"n\">MRB_TT_TRUE</span><span class=\"p\">:</span>\n    <span class=\"k\">return</span> <span class=\"n\">mrb</span><span class=\"o\">-&gt;</span><span class=\"n\">true_class</span><span class=\"p\">;</span>\n  <span class=\"k\">case</span> <span class=\"n\">MRB_TT_SYMBOL</span><span class=\"p\">:</span>\n    <span class=\"k\">return</span> <span class=\"n\">mrb</span><span class=\"o\">-&gt;</span><span class=\"n\">symbol_class</span><span class=\"p\">;</span>\n  <span class=\"k\">case</span> <span class=\"n\">MRB_TT_FIXNUM</span><span class=\"p\">:</span>\n    <span class=\"k\">return</span> <span class=\"n\">mrb</span><span class=\"o\">-&gt;</span><span class=\"n\">fixnum_class</span><span class=\"p\">;</span>\n  <span class=\"k\">case</span> <span class=\"n\">MRB_TT_FLOAT</span><span class=\"p\">:</span>\n    <span class=\"k\">return</span> <span class=\"n\">mrb</span><span class=\"o\">-&gt;</span><span class=\"n\">float_class</span><span class=\"p\">;</span>\n  <span class=\"k\">case</span> <span class=\"n\">MRB_TT_CPTR</span><span class=\"p\">:</span>\n    <span class=\"k\">return</span> <span class=\"n\">mrb</span><span class=\"o\">-&gt;</span><span class=\"n\">object_class</span><span class=\"p\">;</span>\n  <span class=\"k\">case</span> <span class=\"n\">MRB_TT_ENV</span><span class=\"p\">:</span>\n    <span class=\"k\">return</span> <span class=\"nb\">NULL</span><span class=\"p\">;</span>\n  <span class=\"nl\">default:</span>\n    <span class=\"k\">return</span> <span class=\"n\">mrb_obj_ptr</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">c</span><span class=\"p\">;</span>  <span class=\"cm\">/* BUG: Bad memory access */</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre>\n<p>If we check the vale <code>v</code>:</p>\n<pre class=\"highlight plaintext\"><code>(gdb) print v\n$1 = {\n  value = {\n    p = 0x6,\n    {\n      i_flag = 0,\n      i = 3\n    },\n    {\n      sym_flag = 6,\n      sym = 0\n    },\n    bp = 0x6,\n    fp = 0x6,\n    vp = 0x6\n  },\n  w = 6\n}\n</code></pre>\n<p><code>mrb_obj_ptr</code> is the following macro</p>\n<pre class=\"highlight c\"><code><span class=\"cp\">#define mrb_obj_ptr(v)   ((struct RObject*)(mrb_ptr(v)))\n</span></code></pre>\n<p>So <code>mrb_obj_ptr(v)-&gt;c</code> would be equivalent to this:</p>\n<pre class=\"highlight plaintext\"><code>(gdb) print ((struct RObject*)v)-&gt;c\nCannot access memory at address 0xe\n(gdb) print &amp;((struct RObject*)v)-&gt;c\n$2 = (struct RClass **) 0xe\n</code></pre>\n<p>If we check the backtrace:</p>\n<pre class=\"highlight plaintext\"><code>(gdb) bt\n#0  mrb_class (v=..., mrb=mrb@entry=0x7ffff23494e0) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/include/mruby/class.h:50\n#1  mrb_respond_to (mrb=mrb@entry=0x7ffff23494e0, obj=obj@entry=..., mid=mid@entry=143)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1492\n#2  0x00007ffff37d763b in convert_type (raise=0 &#39;\\000&#39;, method=0x7ffff384342f &quot;to_str&quot;, tname=0x7ffff3844446 &quot;String&quot;, val=..., mrb=0x7ffff23494e0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:310\n#3  mrb_check_convert_type (mrb=mrb@entry=0x7ffff23494e0, val=..., type=type@entry=MRB_TT_STRING, tname=tname@entry=0x7ffff3844446 &quot;String&quot;,\n    method=method@entry=0x7ffff384342f &quot;to_str&quot;) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/object.c:352\n#4  0x00007ffff37d47cc in mrb_check_string_type (mrb=mrb@entry=0x7ffff23494e0, str=..., str@entry=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/string.c:1743\n#5  0x00007ffff37dae0d in join_ary (mrb=mrb@entry=0x7ffff23494e0, ary=ary@entry=..., sep=sep@entry=..., list=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1007\n#6  0x00007ffff37dbdbe in mrb_ary_join (mrb=mrb@entry=0x7ffff23494e0, ary=ary@entry=..., sep=...)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/array.c:1031\n#7  0x00007ffff37ed8cb in mrb_vformat (mrb=mrb@entry=0x7ffff23494e0, format=0x7ffff3843547 &quot;method &#39;%S&#39; not defined in %S&quot;, ap=ap@entry=0x7ffff23479a8)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:345\n#8  0x00007ffff37edae2 in mrb_name_error (mrb=mrb@entry=0x7ffff23494e0, id=id@entry=0, fmt=fmt@entry=0x7ffff3843547 &quot;method &#39;%S&#39; not defined in %S&quot;)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/error.c:382\n#9  0x00007ffff37c73c7 in remove_method (mid=0, mod=..., mrb=0x7ffff23494e0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:1985\n#10 mrb_mod_remove_method (mrb=0x7ffff23494e0, mod=...) at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/class.c:2006\n#11 0x00007ffff37e0cf2 in mrb_vm_exec (mrb=mrb@entry=0x7ffff23494e0, proc=&lt;optimized out&gt;, proc@entry=0x7ffff2351520, pc=&lt;optimized out&gt;)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:1165\n#12 0x00007ffff37e6567 in mrb_vm_run (mrb=0x7ffff23494e0, proc=0x7ffff2351520, self=..., stack_keep=stack_keep@entry=0)\n    at /home/jaime/research/shopy/mruby-engine/ext/mruby_engine/mruby/src/vm.c:766\n#13 0x00007ffff37ba173 in mruby_engine_monitored_eval (data=0x7ffff23493e0) at ../../../../ext/mruby_engine/eval_monitored.c:68\n#14 0x00007ffff7737464 in start_thread (arg=0x7ffff2348700) at pthread_create.c:333\n#15 0x00007ffff6ab330d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109\n(gdb)\n</code></pre>\n<p>We can see that whenever the desired method to delete is not found, mruby will raise an error. This is handled by <code>remove_method()</code> at <code>ext/mruby_engine/mruby/src/class.c:1985</code>:</p>\n<pre class=\"highlight c\"><code><span class=\"k\">static</span> <span class=\"kt\">void</span>\n<span class=\"nf\">remove_method</span><span class=\"p\">(</span><span class=\"n\">mrb_state</span> <span class=\"o\">*</span><span class=\"n\">mrb</span><span class=\"p\">,</span> <span class=\"n\">mrb_value</span> <span class=\"n\">mod</span><span class=\"p\">,</span> <span class=\"n\">mrb_sym</span> <span class=\"n\">mid</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n  <span class=\"k\">struct</span> <span class=\"n\">RClass</span> <span class=\"o\">*</span><span class=\"n\">c</span> <span class=\"o\">=</span> <span class=\"n\">mrb_class_ptr</span><span class=\"p\">(</span><span class=\"n\">mod</span><span class=\"p\">);</span>\n  <span class=\"n\">khash_t</span><span class=\"p\">(</span><span class=\"n\">mt</span><span class=\"p\">)</span> <span class=\"o\">*</span><span class=\"n\">h</span> <span class=\"o\">=</span> <span class=\"n\">find_origin</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">)</span><span class=\"o\">-&gt;</span><span class=\"n\">mt</span><span class=\"p\">;</span>\n  <span class=\"n\">khiter_t</span> <span class=\"n\">k</span><span class=\"p\">;</span>\n\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">h</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"n\">k</span> <span class=\"o\">=</span> <span class=\"n\">kh_get</span><span class=\"p\">(</span><span class=\"n\">mt</span><span class=\"p\">,</span> <span class=\"n\">mrb</span><span class=\"p\">,</span> <span class=\"n\">h</span><span class=\"p\">,</span> <span class=\"n\">mid</span><span class=\"p\">);</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">k</span> <span class=\"o\">!=</span> <span class=\"n\">kh_end</span><span class=\"p\">(</span><span class=\"n\">h</span><span class=\"p\">))</span> <span class=\"p\">{</span>\n      <span class=\"n\">kh_del</span><span class=\"p\">(</span><span class=\"n\">mt</span><span class=\"p\">,</span> <span class=\"n\">mrb</span><span class=\"p\">,</span> <span class=\"n\">h</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">);</span>\n      <span class=\"n\">mrb_funcall</span><span class=\"p\">(</span><span class=\"n\">mrb</span><span class=\"p\">,</span> <span class=\"n\">mod</span><span class=\"p\">,</span> <span class=\"s\">&quot;method_removed&quot;</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">mrb_symbol_value</span><span class=\"p\">(</span><span class=\"n\">mid</span><span class=\"p\">));</span>\n      <span class=\"k\">return</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"n\">mrb_name_error</span><span class=\"p\">(</span><span class=\"n\">mrb</span><span class=\"p\">,</span> <span class=\"n\">mid</span><span class=\"p\">,</span> <span class=\"s\">&quot;method &#39;%S&#39; not defined in %S&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">mrb_sym2str</span><span class=\"p\">(</span><span class=\"n\">mrb</span><span class=\"p\">,</span> <span class=\"n\">mid</span><span class=\"p\">),</span> <span class=\"n\">mod</span><span class=\"p\">);</span>  <span class=\"cm\">/* &lt;--- Raise an error */</span>\n<span class=\"p\">}</span>\n</code></pre>\n<p>Later on, mruby tries to convert the symbol in order to print it which is what causes the crash.</p>\n\n<h2 id=\"proposed-fix\">Proposed fix</h2>\n\n<p>As the arguments for <code>remove_method()</code> should at least be a method type symbol. I propose the following check at <code>mrb_mod_remove_method()</code></p>\n<pre class=\"highlight diff\"><code><span class=\"gh\">diff --git a/src/class.c b/src/class.c\nindex 47a6c84..a898b46 100644\n</span><span class=\"gd\">--- a/src/class.c\n</span><span class=\"gi\">+++ b/src/class.c\n</span><span class=\"gu\">@@ -2003,6 +2003,11 @@ mrb_mod_remove_method(mrb_state *mrb, mrb_value mod)\n</span>\n   mrb_get_args(mrb, &quot;*&quot;, &amp;argv, &amp;argc);\n   while (argc--) {\n<span class=\"gi\">+\n+    /* Crash fix. Ignore invalid types */\n+    if ((!argv-&gt;value.sym) || (argv-&gt;value.sym_flag != MRB_SYMBOL_FLAG))\n+      mrb_raise(mrb, E_TYPE_ERROR, &quot;Invalid type for remove_method&quot;);\n+\n</span>     remove_method(mrb, mod, mrb_symbol(*argv));\n     argv++;\n   }\n</code></pre>\n<p>mruby with the fix applied stops the crash:</p>\n<pre class=\"highlight plaintext\"><code>$ bin/sandbox /tmp/crasher.rb\nbin/sandbox:20:in `sandbox_eval&#39;: Invalid type for remove_method (MRubyEngine::EngineRuntimeError)\n        from bin/sandbox:20:in `&lt;main&gt;&#39;\n</code></pre>\n<h2 id=\"impact\">Impact</h2>\n\n<p>This is not exploitable and its impact its limited to DoS of the service running the ruby sandbox.</p>\n", 
    "severity_rating": "high", 
    "team_private?": false, 
    "team": {
        "profile": {
            "website": "https://www.mruby.science", 
            "about": "", 
            "twitter_handle": "", 
            "name": "shopify-scripts"
        }, 
        "handle": "shopify-scripts", 
        "url": "https://hackerone.com/shopify-scripts", 
        "state": "public_mode", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/015/668/9f47d94cbd9e4311b57f1ab05f67fb5c26fd2e78_small.jpg?1475592254", 
            "medium": "https://profile-photos.hackerone-user-content.com/000/015/668/b50db49e93f656e202ae6f94b4c0821d1184134b_medium.jpg?1475592254"
        }, 
        "awards_miles": false, 
        "permissions": [], 
        "id": 15668, 
        "default_currency": "usd"
    }, 
    "is_published": false
}