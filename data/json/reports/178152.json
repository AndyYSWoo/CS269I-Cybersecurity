{
    "abilities": {
        "can_manage_common_responses?": false, 
        "can_manage_collaborators?": false, 
        "can_reopen?": false, 
        "can_ban_researcher?": false, 
        "can_create_severity?": false, 
        "can_assign_to_h1_triage?": false, 
        "can_agree_on_going_public?": false, 
        "assignable_team_member_groups": [], 
        "can_view_credential_account_details?": false, 
        "can_export?": false, 
        "can_create_retest?": false, 
        "can_assign_to_user?": false, 
        "can_use_common_responses?": false, 
        "can_hide_timeline?": false, 
        "can_be_manually_disclosed?": false, 
        "assignable_team_members": [], 
        "can_clone?": false, 
        "can_be_publicly_disclosed?": false, 
        "can_close_comments?": false, 
        "can_view_bounty_weights?": false, 
        "can_suggest_bounty_amount?": false, 
        "can_cancel_disclosure_request?": false, 
        "can_redact?": false, 
        "can_change_structured_scope?": false, 
        "can_post_internal_comments?": false, 
        "can_change_state?": false, 
        "can_change_weakness?": false, 
        "can_add_comment?": false, 
        "can_reassign_to_team?": false, 
        "can_change_title?": false, 
        "can_award_bounty?": false, 
        "can_award_swag?": false, 
        "can_close?": false, 
        "can_manage?": false
    }, 
    "comments_closed?": false, 
    "substate": "resolved", 
    "bug_reporter_agreed_on_going_public_at": "2016-11-02T18:37:40.826Z", 
    "voters": [
        "lukasreschke", 
        "zhchbin", 
        "tomdev", 
        "d1m0ck", 
        "smiegles", 
        "derision", 
        "michiel", 
        "spam404", 
        "troubleshooter", 
        "gerben_javado", 
        "and 95 more..."
    ], 
    "facebook_team?": false, 
    "has_bounty?": false, 
    "rejected_anc_report_that_can_be_sent_back_to_anc_triagers?": false, 
    "original_report_id": null, 
    "id": 178152, 
    "can_view_team": true, 
    "team_member_agreed_on_going_public_at": "2016-11-03T00:35:28.669Z", 
    "vulnerability_information": "The GitLab export upload feature contains a vulnerability that allows an attacker to read arbitrary files on a GitLab instance. This vulnerability is caused by the behaviour of `JSON.parse`, your error handling, and the possibility to reference a symbolic link in a GitLab export. When I started looking into this functionality, I created a demo repository and created a GitLab export through the project's admin panel. GitLab exports can be imported when creating a new project, for example at https://gitlab.com/projects/new (click GitLab export). Anyway, a simple, extracted GitLab export file contains the following files:\n\n```\nexport $ ls -lash\ntotal 48\n 8 -rw-r--r--@   1 jobert  staff     5B Oct 25 19:52 VERSION\n 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json\n```\n\nWhen the export file is uploaded again, a few things happen. The first three are, in this order: it waits until the file has been written to disk (for big repositories), a version check based on the `VERSION` file, and creating a new `Project` model instance based on `project.json`. The first step isn't important. Lets look at the code that's being executed for the second step (line 12-18 from `Gitlab::ImportExport::VersionChecker`):\n\n```ruby\ndef check!\n  version = File.open(version_file, &:readline)\n  verify_version!(version)\nrescue => e\n  shared.error(e)\n  false\nend\n```\n\nPay attention to line 13. It will open the file and call the method `readline`, which will return the first line of the file. Now, on line 16 any exception is caught and the message is pushed onto the `errors` array. All these errors are returned to the frontend. Take a look at line 27-31 of the same file:\n\n```ruby\nif Gem::Version.new(version) != Gem::Version.new(Gitlab::ImportExport.version)\n  raise Gitlab::ImportExport::Error.new(\"Import version mismatch: Required #{Gitlab::ImportExport.version} but was #{version}\")\nelse\n  true\nend\n```\n\nThis means if the version isn't correct, an exception is returned that contains the provided version from the GitLab export. Lets untar the GitLab export, replace the `VERSION` file with a symbolic link, and tar the GitLab export again. The structure of the tar will look like this:\n\n```\nexport $ ls -lash\n 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 VERSION -> /etc/passwd\n 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json\n```\n\nAfter creating a new GitLab export (run `tar -czvf test.tar.gz .` in the export directory), the new GitLab export can be uploaded. By doing so, the GitLab instance will return the first line of the error because the version matcher raises an exception:\n\n{F130235}\n\nHowever, with this only the first line of a file can be read. This is interesting, but much harder to exploit than if an entire file can be read. I kept digging to see if there was a way to read an entire file. Like I pointed out earlier, the third step in the import process is creating a new instance of the `Project` model. It executes the following code (line 11-22 from `Gitlab::ImportExport::ProjectTreeRestorer`):\n\n```ruby\ndef restore\n  json = IO.read(@path)\n  tree_hash = ActiveSupport::JSON.decode(json)\n  project_members = tree_hash.delete('project_members')\n\n  ActiveRecord::Base.no_touching do\n    create_relations\n  end\nrescue => e\n  shared.error(e)\n  false\nend\n```\n\nA similar code structure as the version check is implemented: any exception that is thrown in line 13-18 is caught and the error message is pushed onto the errors array. It isn't immediately clear from the code, but the ActiveSupport implementation of JSON decoding uses `JSON.parse`, which returns the contents of the entire string to be decoded in the error message when it fails to decode. This means that if we can let the decoder raise an exception, we can read the contents of a file. This isn't so hard. Consider this file structure:\n\n```\nexport $ ls -lash\n 8 -rw-r--r--@   1 jobert  staff    11B Oct 25 20:43 VERSION\n 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json -> /etc/passwd\n```\n\nIn this example, the `project.json` file is a symlink to `/etc/passwd`. The `IO.read` call on line 14 will follow a symlink to read the contents of a file. Obviously, the `/etc/passwd` file doesn't contain valid JSON, thus it will result in an exception with the contents of `/etc/passwd`. Use tar to compress the files again to prepare it for upload. An example file is attached: F130233. When this file gets imported, it'll show the contents of the linked file in the error message:\n\n{F130234}\n\nTo proof that this isn't my own `/etc/passwd` file that was accidentally compressed with the file, here are the last 5 lines of the `/etc/passwd` of gitlab.com.\n\n```\nalejandro:x:1117:1117::/home/alejandro:/bin/bash\nprometheus:x:999:999::/opt/prometheus:/bin/false\ngitlab-monitor:x:998:998::/opt/gitlab-monitor:/bin/false\npostgres:x:116:121:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash\nbrian:x:1118:1118::/home/brian:/bin/bash\n```\n\nWith this issue, the secrets of the GitLab rails project can be read, too. This results in an RCE because cookies can be marshalled and resigned again. It seems to also give access to the internal GitLab shell tokens, which give access to all repositories.\n\nLet me know if you need any more information!", 
    "activity_page_count": 1, 
    "severity": {
        "metrics": {
            "confidentiality": "high", 
            "privileges_required": "low", 
            "user_interaction": "required", 
            "attack_vector": "network", 
            "attack_complexity": "low", 
            "scope": "changed", 
            "integrity": "high", 
            "availability": "high"
        }, 
        "rating": "critical", 
        "score": 9.0, 
        "author_type": "User"
    }, 
    "title": "Read files on application server, leads to RCE", 
    "is_member_of_team?": null, 
    "vote_count": 105, 
    "summaries": [
        {
            "category": "team", 
            "can_create?": false, 
            "can_view?": true
        }, 
        {
            "category": "researcher", 
            "can_view?": true, 
            "can_edit?": false, 
            "id": 2869, 
            "content": "GitLab CE/EE versions 8.9, 8.10, 8.11, 8.12, and 8.13 are vulnerable to an arbitrary file read vulnerability. The vulnerability could be exploited to gain access to the application's secrets. These secrets could be used to gain command execution access on the application server. \n\nThe CVSS for the vulnerability in versions 8.9, 8.10, 8.11, and 8.12 is determined to be 8.4 (CVSS:3.0/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:H). The CVSS for the same vulnerability in version 8.13 was determined to be 9.0, because the admin privilege was not necessary anymore to exploit the vulnerability (CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H). For all scenarios, the GitLab instance needs to have the import feature of GitLab export files enabled.", 
            "content_html": "<p>GitLab CE/EE versions 8.9, 8.10, 8.11, 8.12, and 8.13 are vulnerable to an arbitrary file read vulnerability. The vulnerability could be exploited to gain access to the application&#39;s secrets. These secrets could be used to gain command execution access on the application server. </p>\n\n<p>The CVSS for the vulnerability in versions 8.9, 8.10, 8.11, and 8.12 is determined to be 8.4 (CVSS:3.0/AV:N/AC:L/PR:H/UI:R/S:C/C:H/I:H/A:H). The CVSS for the same vulnerability in version 8.13 was determined to be 9.0, because the admin privilege was not necessary anymore to exploit the vulnerability (CVSS:3.0/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:H). For all scenarios, the GitLab instance needs to have the import feature of GitLab export files enabled.</p>\n"
        }
    ], 
    "structured_scope": null, 
    "allow_singular_disclosure_at": "2016-12-02T18:37:40.852Z", 
    "state": "Closed", 
    "cve_ids": [
        "CVE-2016-9086"
    ], 
    "activity_page_number": 1, 
    "readable_substate": "Resolved", 
    "public": true, 
    "attachments": [
        {
            "file_name": "test.tar.gz", 
            "type": "application/gzip", 
            "id": 130233, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/130/233/1a62bf87c15a273b1ff8f5a5b257169a8e44e88e/test.tar.gz?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T224715Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=809dc513e58778dd32796ebbae4bf624f7fdab9a8558bbe2babd949df2e84d65"
        }, 
        {
            "file_name": "Screen_Shot_2016-10-25_at_20.55.36.png", 
            "type": "image/png", 
            "id": 130234, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/130/234/3835c6918f985b21fee93e9f9c3401a399c0fd06/Screen_Shot_2016-10-25_at_20.55.36.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T224715Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=ac5e17a2089e8e5632bd279e7bedf3dd90330a9ecb2dc55a074c03ad4b1f29b2"
        }, 
        {
            "file_name": "Screen_Shot_2016-10-25_at_19.28.51.png", 
            "type": "image/png", 
            "id": 130235, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/130/235/eda5af808482da6f95d04416ba92d08c11f516d1/Screen_Shot_2016-10-25_at_19.28.51.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T224715Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=fcbe3bf8a7dc7560674178acfc1233b888374b7a2eb00878d9dc6bfff409e1b5"
        }
    ], 
    "singular_disclosure_disabled": false, 
    "activities": [
        {
            "automated_response": false, 
            "created_at": "2016-10-26T18:46:43.261Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-10-26T18:46:43.261Z", 
            "actor": {
                "username": "rspeicher", 
                "url": "/rspeicher", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/070/800/71ae869ab45b05d47a2118c159952ebe3ceca17e_medium.jpg?1519748506"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "@jobert Thanks for the detailed report. We opened an internal issue earlier today to discuss it, and a fix is in the works. We'll keep you updated here on the progress as always.", 
            "markdown_message": "<p><a href=\"/jobert\">@jobert</a> Thanks for the detailed report. We opened an internal issue earlier today to discuss it, and a fix is in the works. We&#39;ll keep you updated here on the progress as always.</p>\n", 
            "type": "Activities::BugTriaged", 
            "id": 1269201, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-01T19:55:15.661Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-01T19:55:15.661Z", 
            "actor": {
                "username": "rspeicher", 
                "url": "/rspeicher", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/070/800/71ae869ab45b05d47a2118c159952ebe3ceca17e_medium.jpg?1519748506"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "A fix has gone through review and been merged into the stable branches for 8.9 through 8.13. We're currently building packages for each version and if everything goes well, we plan to release all patches on Wednesday November 2, 2016 at 4:59pm PDT (23:59 GMT).\n\nWe've been assigned CVE-2016-9086 for this issue. A pre-disclosure announcement was sent to our security newsletter and [posted on our blog](https://about.gitlab.com/2016/10/31/gitlab-major-security-update-for-cve-2016-9086/).", 
            "markdown_message": "<p>A fix has gone through review and been merged into the stable branches for 8.9 through 8.13. We&#39;re currently building packages for each version and if everything goes well, we plan to release all patches on Wednesday November 2, 2016 at 4:59pm PDT (23:59 GMT).</p>\n\n<p>We&#39;ve been assigned CVE-2016-9086 for this issue. A pre-disclosure announcement was sent to our security newsletter and <a href=\"/redirect?signature=b05b77c4eaf9e7b98edf377e33791333dbbb2975&amp;url=https%3A%2F%2Fabout.gitlab.com%2F2016%2F10%2F31%2Fgitlab-major-security-update-for-cve-2016-9086%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>posted on our blog</span><i class=\"icon-external-link\"></i></a>.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1279180, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-01T20:12:38.521Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-01T20:12:38.521Z", 
            "actor": {
                "username": "rspeicher", 
                "url": "/rspeicher", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/070/800/71ae869ab45b05d47a2118c159952ebe3ceca17e_medium.jpg?1519748506"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "Below is (the relevant part of) the fix we've applied, if you'd like to verify it:\n\n```\ndiff --git a/lib/gitlab/import_export/file_importer.rb b/lib/gitlab/import_export/file_importer.rb\nindex 113895b..ffd1711 100644\n--- a/lib/gitlab/import_export/file_importer.rb\n+++ b/lib/gitlab/import_export/file_importer.rb\n@@ -43,6 +43,14 @@ module Gitlab\n \n         raise Projects::ImportService::Error.new(\"Unable to decompress #{@archive_file} into #{@shared.export_path}\") unless result\n \n+        remove_symlinks!\n+      end\n+\n+      def remove_symlinks!\n+        Dir[\"#{@shared.export_path}/**/*\"].each do |path|\n+          FileUtils.rm(path) if File.lstat(path).symlink?\n+        end\n+\n         true\n       end\n     end\ndiff --git a/lib/gitlab/import_export/project_tree_restorer.rb b/lib/gitlab/import_export/project_tree_restorer.rb\nindex 7cdba88..c551321 100644\n--- a/lib/gitlab/import_export/project_tree_restorer.rb\n+++ b/lib/gitlab/import_export/project_tree_restorer.rb\n@@ -9,8 +9,14 @@ module Gitlab\n       end\n \n       def restore\n-        json = IO.read(@path)\n-        @tree_hash = ActiveSupport::JSON.decode(json)\n+        begin\n+          json = IO.read(@path)\n+          @tree_hash = ActiveSupport::JSON.decode(json)\n+        rescue => e\n+          Rails.logger.error(\"Import/Export error: #{e.message}\")\n+          raise Gitlab::ImportExport::Error.new('Incorrect JSON format')\n+        end\n+\n         @project_members = @tree_hash.delete('project_members')\n \n         ActiveRecord::Base.no_touching do\ndiff --git a/lib/gitlab/import_export/version_checker.rb b/lib/gitlab/import_export/version_checker.rb\nindex fc08082..bd3c3ee 100644\n--- a/lib/gitlab/import_export/version_checker.rb\n+++ b/lib/gitlab/import_export/version_checker.rb\n@@ -24,12 +24,19 @@ module Gitlab\n       end\n \n       def verify_version!(version)\n-        if Gem::Version.new(version) != Gem::Version.new(Gitlab::ImportExport.version)\n+        if different_version?(version)\n           raise Gitlab::ImportExport::Error.new(\"Import version mismatch: Required #{Gitlab::ImportExport.version} but was #{version}\")\n         else\n           true\n         end\n       end\n+\n+      def different_version?(version)\n+        Gem::Version.new(version) != Gem::Version.new(Gitlab::ImportExport.version)\n+      rescue => e\n+        Rails.logger.error(\"Import/Export error: #{e.message}\")\n+        raise Gitlab::ImportExport::Error.new('Incorrect VERSION format')\n+      end\n     end\n   end\n end\n```", 
            "markdown_message": "<p>Below is (the relevant part of) the fix we&#39;ve applied, if you&#39;d like to verify it:</p>\n<pre class=\"highlight diff\"><code><span class=\"gh\">diff --git a/lib/gitlab/import_export/file_importer.rb b/lib/gitlab/import_export/file_importer.rb\nindex 113895b..ffd1711 100644\n</span><span class=\"gd\">--- a/lib/gitlab/import_export/file_importer.rb\n</span><span class=\"gi\">+++ b/lib/gitlab/import_export/file_importer.rb\n</span><span class=\"gu\">@@ -43,6 +43,14 @@ module Gitlab\n</span>\n         raise Projects::ImportService::Error.new(&quot;Unable to decompress #{@archive_file} into #{@shared.export_path}&quot;) unless result\n\n<span class=\"gi\">+        remove_symlinks!\n+      end\n+\n+      def remove_symlinks!\n+        Dir[&quot;#{@shared.export_path}/**/*&quot;].each do |path|\n+          FileUtils.rm(path) if File.lstat(path).symlink?\n+        end\n+\n</span>         true\n       end\n     end\n<span class=\"gh\">diff --git a/lib/gitlab/import_export/project_tree_restorer.rb b/lib/gitlab/import_export/project_tree_restorer.rb\nindex 7cdba88..c551321 100644\n</span><span class=\"gd\">--- a/lib/gitlab/import_export/project_tree_restorer.rb\n</span><span class=\"gi\">+++ b/lib/gitlab/import_export/project_tree_restorer.rb\n</span><span class=\"gu\">@@ -9,8 +9,14 @@ module Gitlab\n</span>       end\n\n       def restore\n<span class=\"gd\">-        json = IO.read(@path)\n-        [@tree_hash](/tree_hash) = ActiveSupport::JSON.decode(json)\n</span><span class=\"gi\">+        begin\n+          json = IO.read(@path)\n+          [@tree_hash](/tree_hash) = ActiveSupport::JSON.decode(json)\n+        rescue =&gt; e\n+          Rails.logger.error(&quot;Import/Export error: #{e.message}&quot;)\n+          raise Gitlab::ImportExport::Error.new(&#39;Incorrect JSON format&#39;)\n+        end\n+\n</span>         [@project_members](/project_members) = [@tree_hash](/tree_hash).delete(&#39;project_members&#39;)\n\n         ActiveRecord::Base.no_touching do\n<span class=\"gh\">diff --git a/lib/gitlab/import_export/version_checker.rb b/lib/gitlab/import_export/version_checker.rb\nindex fc08082..bd3c3ee 100644\n</span><span class=\"gd\">--- a/lib/gitlab/import_export/version_checker.rb\n</span><span class=\"gi\">+++ b/lib/gitlab/import_export/version_checker.rb\n</span><span class=\"gu\">@@ -24,12 +24,19 @@ module Gitlab\n</span>       end\n\n       def verify_version!(version)\n<span class=\"gd\">-        if Gem::Version.new(version) != Gem::Version.new(Gitlab::ImportExport.version)\n</span><span class=\"gi\">+        if different_version?(version)\n</span>           raise Gitlab::ImportExport::Error.new(&quot;Import version mismatch: Required #{Gitlab::ImportExport.version} but was #{version}&quot;)\n         else\n           true\n         end\n       end\n<span class=\"gi\">+\n+      def different_version?(version)\n+        Gem::Version.new(version) != Gem::Version.new(Gitlab::ImportExport.version)\n+      rescue =&gt; e\n+        Rails.logger.error(&quot;Import/Export error: #{e.message}&quot;)\n+        raise Gitlab::ImportExport::Error.new(&#39;Incorrect VERSION format&#39;)\n+      end\n</span>     end\n   end\n end\n</code></pre>", 
            "type": "Activities::Comment", 
            "id": 1279216, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-01T20:41:07.896Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-01T20:41:07.896Z", 
            "actor": {
                "username": "jobert", 
                "url": "/jobert", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/002/35cc46a21b3756f9df61d6269d287b9dc53d5b27_medium.png?1410255083"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "Thanks, @rspeicher! With the upcoming security release, I wanted to document a few more problems that will be addressed. There are two more restore scripts that have similar problems, namely the avatar restorer and the uploads restorer.\n\nThe likelihood of exploiting the avatar restore script is limited, because the project avatar is being validated before it's saved. This means that it can only be used to copy potentially confidential files on the application server, but only when it's a valid image. Because the entropy of the uploads directories in other namespaces, this is less likely to be exploited. Because you're using bare repositories, files from other repositories cannot be extracted.\n\nThe similar vulnerability in the upload restorer is more severe. When the tar file contains an `uploads` directory, its subdirectories will be copied to the new namespace. This will copy the symlink to the attacker's namespace. When that happens, the linked file can be obtained through two ways. The attacker can download the original file by simply downloading the file through the web application, but it can also be obtained by downloading a new GitLab export. The export feature will copy the linked file to the tar instead of the symlink itself.\n\nThe proposed fix seems to take care of all vulnerabilities pointed out in this report so far. I'm looking forward to the release. Thanks again, @rspeicher!", 
            "markdown_message": "<p>Thanks, <a href=\"/rspeicher\">@rspeicher</a>! With the upcoming security release, I wanted to document a few more problems that will be addressed. There are two more restore scripts that have similar problems, namely the avatar restorer and the uploads restorer.</p>\n\n<p>The likelihood of exploiting the avatar restore script is limited, because the project avatar is being validated before it&#39;s saved. This means that it can only be used to copy potentially confidential files on the application server, but only when it&#39;s a valid image. Because the entropy of the uploads directories in other namespaces, this is less likely to be exploited. Because you&#39;re using bare repositories, files from other repositories cannot be extracted.</p>\n\n<p>The similar vulnerability in the upload restorer is more severe. When the tar file contains an <code>uploads</code> directory, its subdirectories will be copied to the new namespace. This will copy the symlink to the attacker&#39;s namespace. When that happens, the linked file can be obtained through two ways. The attacker can download the original file by simply downloading the file through the web application, but it can also be obtained by downloading a new GitLab export. The export feature will copy the linked file to the tar instead of the symlink itself.</p>\n\n<p>The proposed fix seems to take care of all vulnerabilities pointed out in this report so far. I&#39;m looking forward to the release. Thanks again, <a href=\"/rspeicher\">@rspeicher</a>!</p>\n", 
            "type": "Activities::Comment", 
            "id": 1279280, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-02T13:54:29.509Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-02T13:54:29.509Z", 
            "actor": {
                "username": "rspeicher", 
                "url": "/rspeicher", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/070/800/71ae869ab45b05d47a2118c159952ebe3ceca17e_medium.jpg?1519748506"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "Minor update: the fix did not apply cleanly to 8.9 due to a number of changes in the Import/Export code since that version's release. Because the import feature requires administrator access in that version, we feel the exploit is less severe and will only be releasing patches for 8.10 through 8.13.\n\nVersions 8.10 through 8.12 also had the administrator requirement, but because the patch applied cleanly we plan to release patches for those versions as an extra precaution.", 
            "markdown_message": "<p>Minor update: the fix did not apply cleanly to 8.9 due to a number of changes in the Import/Export code since that version&#39;s release. Because the import feature requires administrator access in that version, we feel the exploit is less severe and will only be releasing patches for 8.10 through 8.13.</p>\n\n<p>Versions 8.10 through 8.12 also had the administrator requirement, but because the patch applied cleanly we plan to release patches for those versions as an extra precaution.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1280398, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-02T15:26:11.085Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-02T15:26:11.085Z", 
            "actor": {
                "username": "jobert", 
                "url": "/jobert", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/002/35cc46a21b3756f9df61d6269d287b9dc53d5b27_medium.png?1410255083"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "To clarify, the required administrator access is that the import of GitLab export files has to be enabled on the GitLab instance by an administrator. Once that has been done, anyone that can create a project can exploit the reported vulnerabilities. The recommendation you could give to people using 8.9 is to disable the ability to import GitLab exports for now.", 
            "markdown_message": "<p>To clarify, the required administrator access is that the import of GitLab export files has to be enabled on the GitLab instance by an administrator. Once that has been done, anyone that can create a project can exploit the reported vulnerabilities. The recommendation you could give to people using 8.9 is to disable the ability to import GitLab exports for now.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1280524, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-02T16:25:04.758Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-02T16:56:00.970Z", 
            "actor": {
                "username": "rspeicher", 
                "url": "/rspeicher", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/070/800/71ae869ab45b05d47a2118c159952ebe3ceca17e_medium.jpg?1519748506"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "@jobert The *import* controller actually performs an admin check itself before any action. We added this as a precaution against the second part of your report in #158330 and only disabled the check going into 8.13's release.\n\n- https://gitlab.com/gitlab-org/gitlab-ce/blob/8-9-stable/app/controllers/import/gitlab_projects_controller.rb#L3\n- https://gitlab.com/gitlab-org/gitlab-ce/blob/8-10-stable/app/controllers/import/gitlab_projects_controller.rb#L3\n- https://gitlab.com/gitlab-org/gitlab-ce/blob/8-11-stable/app/controllers/import/gitlab_projects_controller.rb#L3 \n- https://gitlab.com/gitlab-org/gitlab-ce/blob/8-12-stable/app/controllers/import/gitlab_projects_controller.rb#L3", 
            "markdown_message": "<p><a href=\"/jobert\">@jobert</a> The <em>import</em> controller actually performs an admin check itself before any action. We added this as a precaution against the second part of your report in <a href=\"/reports/158330\">#158330</a> and only disabled the check going into 8.13&#39;s release.</p>\n\n<ul>\n<li><a title=\"https://gitlab.com/gitlab-org/gitlab-ce/blob/8-9-stable/app/controllers/import/gitlab_projects_controller.rb#L3\" href=\"/redirect?signature=b20858827e5b65494f595a1ceb7f6d4d0e12dd89&amp;url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab-ce%2Fblob%2F8-9-stable%2Fapp%2Fcontrollers%2Fimport%2Fgitlab_projects_controller.rb%23L3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://gitlab.com/gitlab-org/gitlab-ce/blob/8-9-stable/app/controllers/import/gitlab_projects_controller.rb#L3</span><i class=\"icon-external-link\"></i></a></li>\n<li><a title=\"https://gitlab.com/gitlab-org/gitlab-ce/blob/8-10-stable/app/controllers/import/gitlab_projects_controller.rb#L3\" href=\"/redirect?signature=9feaa5f6c537b1763b7791a86e197df0396e1236&amp;url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab-ce%2Fblob%2F8-10-stable%2Fapp%2Fcontrollers%2Fimport%2Fgitlab_projects_controller.rb%23L3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://gitlab.com/gitlab-org/gitlab-ce/blob/8-10-stable/app/controllers/import/gitlab_projects_controller.rb#L3</span><i class=\"icon-external-link\"></i></a></li>\n<li>\n<a title=\"https://gitlab.com/gitlab-org/gitlab-ce/blob/8-11-stable/app/controllers/import/gitlab_projects_controller.rb#L3\" href=\"/redirect?signature=f4287f8c7efed4e510434d6e6ff73a5f65e7da30&amp;url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab-ce%2Fblob%2F8-11-stable%2Fapp%2Fcontrollers%2Fimport%2Fgitlab_projects_controller.rb%23L3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://gitlab.com/gitlab-org/gitlab-ce/blob/8-11-stable/app/controllers/import/gitlab_projects_controller.rb#L3</span><i class=\"icon-external-link\"></i></a> </li>\n<li><a title=\"https://gitlab.com/gitlab-org/gitlab-ce/blob/8-12-stable/app/controllers/import/gitlab_projects_controller.rb#L3\" href=\"/redirect?signature=fb8574e5098f23481522d8dbb6914da29ddd0f6f&amp;url=https%3A%2F%2Fgitlab.com%2Fgitlab-org%2Fgitlab-ce%2Fblob%2F8-12-stable%2Fapp%2Fcontrollers%2Fimport%2Fgitlab_projects_controller.rb%23L3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://gitlab.com/gitlab-org/gitlab-ce/blob/8-12-stable/app/controllers/import/gitlab_projects_controller.rb#L3</span><i class=\"icon-external-link\"></i></a></li>\n</ul>\n", 
            "type": "Activities::Comment", 
            "id": 1280662, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "reporter": {
                "username": "jobert", 
                "url": "/jobert"
            }, 
            "created_at": "2016-11-02T18:33:17.841Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-02T18:33:17.841Z", 
            "actor": {
                "username": "rspeicher", 
                "url": "/rspeicher", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/070/800/71ae869ab45b05d47a2118c159952ebe3ceca17e_medium.jpg?1519748506"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "@jobert Going to mark this as resolved. You can request disclosure (and on #158330 as well) and we'll approve both once our blog post for the patch releases is live.\n\nThanks again!", 
            "markdown_message": "<p><a href=\"/jobert\">@jobert</a> Going to mark this as resolved. You can request disclosure (and on <a href=\"/reports/158330\">#158330</a> as well) and we&#39;ll approve both once our blog post for the patch releases is live.</p>\n\n<p>Thanks again!</p>\n", 
            "type": "Activities::BugResolved", 
            "id": 1280896, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-02T18:37:40.840Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-02T18:37:40.840Z", 
            "actor": {
                "username": "jobert", 
                "url": "/jobert", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/002/35cc46a21b3756f9df61d6269d287b9dc53d5b27_medium.png?1410255083"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "first_to_agree": true, 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1280903, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-03T00:35:28.684Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-03T00:35:28.684Z", 
            "actor": {
                "username": "briann", 
                "url": "/briann", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "Our patch and security announcement have gone live! \n\nhttps://about.gitlab.com/2016/11/02/cve-2016-9086-patches/\n\nThanks so much, Jobert.", 
            "markdown_message": "<p>Our patch and security announcement have gone live! </p>\n\n<p><a title=\"https://about.gitlab.com/2016/11/02/cve-2016-9086-patches/\" href=\"/redirect?signature=67a0ae7048e61339b2c9826b582cbe61814834b2&amp;url=https%3A%2F%2Fabout.gitlab.com%2F2016%2F11%2F02%2Fcve-2016-9086-patches%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://about.gitlab.com/2016/11/02/cve-2016-9086-patches/</span><i class=\"icon-external-link\"></i></a></p>\n\n<p>Thanks so much, Jobert.</p>\n", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1281491, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-03T00:35:28.722Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-03T00:35:28.722Z", 
            "actor": {
                "username": "briann", 
                "url": "/briann", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "gitlab", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportBecamePublic", 
            "id": 1281492, 
            "genius_execution_id": null
        }
    ], 
    "in_validation?": false, 
    "is_participant": false, 
    "singular_disclosure_allowed": true, 
    "reporter": {
        "username": "jobert", 
        "hacker_mediation": false, 
        "hackerone_triager": false, 
        "disabled": false, 
        "url": "/jobert", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/000/002/15c798072d48f06507cde4b11352a3338ae973fc_small.png?1410255083"
        }, 
        "is_me?": false
    }, 
    "weakness": {
        "id": 18, 
        "name": "Information Disclosure"
    }, 
    "is_external_bug": false, 
    "visibility": "full", 
    "allow_singular_disclosure_after": -63432574.30476654, 
    "disclosed_at": "2016-11-03T00:35:28.706Z", 
    "stage": 4, 
    "url": "https://hackerone.com/reports/178152", 
    "created_at": "2016-10-26T04:30:29.824Z", 
    "original_report_url": null, 
    "vulnerability_information_html": "<p>The GitLab export upload feature contains a vulnerability that allows an attacker to read arbitrary files on a GitLab instance. This vulnerability is caused by the behaviour of <code>JSON.parse</code>, your error handling, and the possibility to reference a symbolic link in a GitLab export. When I started looking into this functionality, I created a demo repository and created a GitLab export through the project&#39;s admin panel. GitLab exports can be imported when creating a new project, for example at <a title=\"https://gitlab.com/projects/new\" href=\"/redirect?signature=11a5244802b8df8d9a9ae51fc8761897c4655a2b&amp;url=https%3A%2F%2Fgitlab.com%2Fprojects%2Fnew\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://gitlab.com/projects/new</span><i class=\"icon-external-link\"></i></a> (click GitLab export). Anyway, a simple, extracted GitLab export file contains the following files:</p>\n<pre class=\"highlight plaintext\"><code>export $ ls -lash\ntotal 48\n 8 -rw-r--r--@   1 jobert  staff     5B Oct 25 19:52 VERSION\n 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json\n</code></pre>\n<p>When the export file is uploaded again, a few things happen. The first three are, in this order: it waits until the file has been written to disk (for big repositories), a version check based on the <code>VERSION</code> file, and creating a new <code>Project</code> model instance based on <code>project.json</code>. The first step isn&#39;t important. Lets look at the code that&#39;s being executed for the second step (line 12-18 from <code>Gitlab::ImportExport::VersionChecker</code>):</p>\n<pre class=\"highlight ruby\"><code><span class=\"k\">def</span> <span class=\"nf\">check!</span>\n  <span class=\"n\">version</span> <span class=\"o\">=</span> <span class=\"no\">File</span><span class=\"p\">.</span><span class=\"nf\">open</span><span class=\"p\">(</span><span class=\"n\">version_file</span><span class=\"p\">,</span> <span class=\"o\">&amp;</span><span class=\"ss\">:readline</span><span class=\"p\">)</span>\n  <span class=\"n\">verify_version!</span><span class=\"p\">(</span><span class=\"n\">version</span><span class=\"p\">)</span>\n<span class=\"k\">rescue</span> <span class=\"o\">=&gt;</span> <span class=\"n\">e</span>\n  <span class=\"n\">shared</span><span class=\"p\">.</span><span class=\"nf\">error</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n  <span class=\"kp\">false</span>\n<span class=\"k\">end</span>\n</code></pre>\n<p>Pay attention to line 13. It will open the file and call the method <code>readline</code>, which will return the first line of the file. Now, on line 16 any exception is caught and the message is pushed onto the <code>errors</code> array. All these errors are returned to the frontend. Take a look at line 27-31 of the same file:</p>\n<pre class=\"highlight ruby\"><code><span class=\"k\">if</span> <span class=\"no\">Gem</span><span class=\"o\">::</span><span class=\"no\">Version</span><span class=\"p\">.</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"n\">version</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"no\">Gem</span><span class=\"o\">::</span><span class=\"no\">Version</span><span class=\"p\">.</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"no\">Gitlab</span><span class=\"o\">::</span><span class=\"no\">ImportExport</span><span class=\"p\">.</span><span class=\"nf\">version</span><span class=\"p\">)</span>\n  <span class=\"k\">raise</span> <span class=\"no\">Gitlab</span><span class=\"o\">::</span><span class=\"no\">ImportExport</span><span class=\"o\">::</span><span class=\"no\">Error</span><span class=\"p\">.</span><span class=\"nf\">new</span><span class=\"p\">(</span><span class=\"s2\">&quot;Import version mismatch: Required </span><span class=\"si\">#{</span><span class=\"no\">Gitlab</span><span class=\"o\">::</span><span class=\"no\">ImportExport</span><span class=\"p\">.</span><span class=\"nf\">version</span><span class=\"si\">}</span><span class=\"s2\"> but was </span><span class=\"si\">#{</span><span class=\"n\">version</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span>\n<span class=\"k\">else</span>\n  <span class=\"kp\">true</span>\n<span class=\"k\">end</span>\n</code></pre>\n<p>This means if the version isn&#39;t correct, an exception is returned that contains the provided version from the GitLab export. Lets untar the GitLab export, replace the <code>VERSION</code> file with a symbolic link, and tar the GitLab export again. The structure of the tar will look like this:</p>\n<pre class=\"highlight plaintext\"><code>export $ ls -lash\n 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 VERSION -&gt; /etc/passwd\n 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json\n</code></pre>\n<p>After creating a new GitLab export (run <code>tar -czvf test.tar.gz .</code> in the export directory), the new GitLab export can be uploaded. By doing so, the GitLab instance will return the first line of the error because the version matcher raises an exception:</p>\n\n<p><a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2016-10-25_at_19.28.51.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/130/235/eda5af808482da6f95d04416ba92d08c11f516d1/Screen_Shot_2016-10-25_at_19.28.51.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T224715Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=fcbe3bf8a7dc7560674178acfc1233b888374b7a2eb00878d9dc6bfff409e1b5\" data-attachment-type=\"image/png\"><img src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/130/235/eda5af808482da6f95d04416ba92d08c11f516d1/Screen_Shot_2016-10-25_at_19.28.51.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T224715Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=fcbe3bf8a7dc7560674178acfc1233b888374b7a2eb00878d9dc6bfff409e1b5\" class=\"markdown-inline-image\"></a></p>\n\n<p>However, with this only the first line of a file can be read. This is interesting, but much harder to exploit than if an entire file can be read. I kept digging to see if there was a way to read an entire file. Like I pointed out earlier, the third step in the import process is creating a new instance of the <code>Project</code> model. It executes the following code (line 11-22 from <code>Gitlab::ImportExport::ProjectTreeRestorer</code>):</p>\n<pre class=\"highlight ruby\"><code><span class=\"k\">def</span> <span class=\"nf\">restore</span>\n  <span class=\"n\">json</span> <span class=\"o\">=</span> <span class=\"no\">IO</span><span class=\"p\">.</span><span class=\"nf\">read</span><span class=\"p\">(</span><span class=\"vi\">@path</span><span class=\"p\">)</span>\n  <span class=\"n\">tree_hash</span> <span class=\"o\">=</span> <span class=\"no\">ActiveSupport</span><span class=\"o\">::</span><span class=\"no\">JSON</span><span class=\"p\">.</span><span class=\"nf\">decode</span><span class=\"p\">(</span><span class=\"n\">json</span><span class=\"p\">)</span>\n  <span class=\"n\">project_members</span> <span class=\"o\">=</span> <span class=\"n\">tree_hash</span><span class=\"p\">.</span><span class=\"nf\">delete</span><span class=\"p\">(</span><span class=\"s1\">&#39;project_members&#39;</span><span class=\"p\">)</span>\n\n  <span class=\"no\">ActiveRecord</span><span class=\"o\">::</span><span class=\"no\">Base</span><span class=\"p\">.</span><span class=\"nf\">no_touching</span> <span class=\"k\">do</span>\n    <span class=\"n\">create_relations</span>\n  <span class=\"k\">end</span>\n<span class=\"k\">rescue</span> <span class=\"o\">=&gt;</span> <span class=\"n\">e</span>\n  <span class=\"n\">shared</span><span class=\"p\">.</span><span class=\"nf\">error</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n  <span class=\"kp\">false</span>\n<span class=\"k\">end</span>\n</code></pre>\n<p>A similar code structure as the version check is implemented: any exception that is thrown in line 13-18 is caught and the error message is pushed onto the errors array. It isn&#39;t immediately clear from the code, but the ActiveSupport implementation of JSON decoding uses <code>JSON.parse</code>, which returns the contents of the entire string to be decoded in the error message when it fails to decode. This means that if we can let the decoder raise an exception, we can read the contents of a file. This isn&#39;t so hard. Consider this file structure:</p>\n<pre class=\"highlight plaintext\"><code>export $ ls -lash\n 8 -rw-r--r--@   1 jobert  staff    11B Oct 25 20:43 VERSION\n 8 -rw-r--r--@   1 jobert  staff   341B Oct 25 19:53 project.bundle\n 8 lrwxr-xr-x    1 jobert  staff    11B Oct 25 20:43 project.json -&gt; /etc/passwd\n</code></pre>\n<p>In this example, the <code>project.json</code> file is a symlink to <code>/etc/passwd</code>. The <code>IO.read</code> call on line 14 will follow a symlink to read the contents of a file. Obviously, the <code>/etc/passwd</code> file doesn&#39;t contain valid JSON, thus it will result in an exception with the contents of <code>/etc/passwd</code>. Use tar to compress the files again to prepare it for upload. An example file is attached: <a href=\"#\" class=\"markdown-attachment-link markdown-attachment-reference\" data-attachment-filename=\"test.tar.gz\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/130/233/1a62bf87c15a273b1ff8f5a5b257169a8e44e88e/test.tar.gz?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T224715Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=809dc513e58778dd32796ebbae4bf624f7fdab9a8558bbe2babd949df2e84d65\" data-attachment-type=\"application/gzip\">test.tar.gz (F130233)</a>. When this file gets imported, it&#39;ll show the contents of the linked file in the error message:</p>\n\n<p><a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2016-10-25_at_20.55.36.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/130/234/3835c6918f985b21fee93e9f9c3401a399c0fd06/Screen_Shot_2016-10-25_at_20.55.36.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T224715Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=ac5e17a2089e8e5632bd279e7bedf3dd90330a9ecb2dc55a074c03ad4b1f29b2\" data-attachment-type=\"image/png\"><img src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/130/234/3835c6918f985b21fee93e9f9c3401a399c0fd06/Screen_Shot_2016-10-25_at_20.55.36.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T224715Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=ac5e17a2089e8e5632bd279e7bedf3dd90330a9ecb2dc55a074c03ad4b1f29b2\" class=\"markdown-inline-image\"></a></p>\n\n<p>To proof that this isn&#39;t my own <code>/etc/passwd</code> file that was accidentally compressed with the file, here are the last 5 lines of the <code>/etc/passwd</code> of gitlab.com.</p>\n<pre class=\"highlight plaintext\"><code>alejandro:x:1117:1117::/home/alejandro:/bin/bash\nprometheus:x:999:999::/opt/prometheus:/bin/false\ngitlab-monitor:x:998:998::/opt/gitlab-monitor:/bin/false\npostgres:x:116:121:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash\nbrian:x:1118:1118::/home/brian:/bin/bash\n</code></pre>\n<p>With this issue, the secrets of the GitLab rails project can be read, too. This results in an RCE because cookies can be marshalled and resigned again. It seems to also give access to the internal GitLab shell tokens, which give access to all repositories.</p>\n\n<p>Let me know if you need any more information!</p>\n", 
    "severity_rating": "critical", 
    "team_private?": false, 
    "team": {
        "profile": {
            "website": "https://about.gitlab.com", 
            "about": "Open source software to collaborate on code", 
            "twitter_handle": "gitlab", 
            "name": "GitLab"
        }, 
        "handle": "gitlab", 
        "url": "https://hackerone.com/gitlab", 
        "state": "public_mode", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/000/264/338ec4b43393873324e3f1911f2f107d025d13f1_small.png?1454722206", 
            "medium": "https://profile-photos.hackerone-user-content.com/000/000/264/f40e550269de1c8aef9adbdfe728c9aa8163a7e5_medium.png?1454722206"
        }, 
        "awards_miles": false, 
        "permissions": [], 
        "id": 264, 
        "default_currency": "usd"
    }, 
    "is_published": false
}