{
    "abilities": {
        "can_manage_common_responses?": false, 
        "can_manage_collaborators?": false, 
        "can_reopen?": false, 
        "can_ban_researcher?": false, 
        "can_create_severity?": false, 
        "can_assign_to_h1_triage?": false, 
        "can_agree_on_going_public?": false, 
        "assignable_team_member_groups": [], 
        "can_view_credential_account_details?": false, 
        "can_export?": false, 
        "can_create_retest?": false, 
        "can_assign_to_user?": false, 
        "can_use_common_responses?": false, 
        "can_hide_timeline?": false, 
        "can_be_manually_disclosed?": false, 
        "assignable_team_members": [], 
        "can_clone?": false, 
        "can_be_publicly_disclosed?": false, 
        "can_close_comments?": false, 
        "can_view_bounty_weights?": false, 
        "can_suggest_bounty_amount?": false, 
        "can_cancel_disclosure_request?": false, 
        "can_redact?": false, 
        "can_change_structured_scope?": false, 
        "can_post_internal_comments?": false, 
        "can_change_state?": false, 
        "can_change_weakness?": false, 
        "can_add_comment?": false, 
        "can_reassign_to_team?": false, 
        "can_change_title?": false, 
        "can_award_bounty?": false, 
        "can_award_swag?": false, 
        "can_close?": false, 
        "can_manage?": false
    }, 
    "comments_closed?": false, 
    "substate": "resolved", 
    "bug_reporter_agreed_on_going_public_at": "2016-12-17T20:12:15.128Z", 
    "voters": [
        "eveeez", 
        "youssefmahmoud", 
        "c1231665", 
        "japz", 
        "spetr0x", 
        "xcom"
    ], 
    "facebook_team?": false, 
    "has_bounty?": true, 
    "bounty_amount": "1000.0", 
    "rejected_anc_report_that_can_be_sent_back_to_anc_triagers?": false, 
    "original_report_id": null, 
    "id": 185899, 
    "can_view_team": true, 
    "team_member_agreed_on_going_public_at": "2016-12-18T13:23:23.903Z", 
    "vulnerability_information": "Ok, here is a weird one!\n\nIt only crashes in mruby, and can't be made to crash in mruby-engine as max memory possible to extend to is 256M which this requires more.\n\nThe file is:\n\n```\nvalues = [3,5,8]\ntest = [1,6]\nresults,= [1.2]\nvalues.each do |value|\n  case value\n    when *test\n      results << value\n    when *test*= results <<=value\n  end\nend\n```\n\n```\n$ ./dev/bin/mruby crash.rb\nSegmentation fault: 11\n```\n\n```\n$ lldb ./dev/bin/mruby crash.rb\n(lldb) target create \"./dev/bin/mruby\"\nCurrent executable set to './dev/bin/mruby' (x86_64).\n(lldb) settings set -- target.run-args  \"crash.rb\"\n(lldb) r\nProcess 93838 launched: './dev/bin/mruby' (x86_64)\nProcess 93838 stopped\n* thread #1: tid = 0x78effc5, 0x000000010000222d mruby`array_copy + 61, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x16f000000)\n    frame #0: 0x000000010000222d mruby`array_copy + 61\nmruby`array_copy:\n->  0x10000222d <+61>: movq   %rdx, (%rax)\n    0x100002230 <+64>: movq   0x8(%rcx), %rcx\n    0x100002234 <+68>: movq   %rcx, 0x8(%rax)\n    0x100002238 <+72>: movl   -0x18(%rbp), %eax\n(lldb) bt\n* thread #1: tid = 0x78effc5, 0x000000010000222d mruby`array_copy + 61, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x16f000000)\n  * frame #0: 0x000000010000222d mruby`array_copy + 61\n    frame #1: 0x0000000100004437 mruby`mrb_ary_times + 295\n    frame #2: 0x000000010003fc13 mruby`mrb_vm_exec + 6739\n    frame #3: 0x000000010003e1a7 mruby`mrb_vm_run + 135\n    frame #4: 0x0000000100046604 mruby`mrb_top_run + 100\n    frame #5: 0x0000000100071adf mruby`load_exec + 1183\n    frame #6: 0x0000000100071623 mruby`mrb_load_file_cxt + 67\n    frame #7: 0x00000001000017d8 mruby`main + 904\n    frame #8: 0x00007fff8a9db5ad libdyld.dylib`start + 1\n(lldb) register read\nGeneral Purpose Registers:\n       rax = 0x000000016f000000\n       rbx = 0x0000000000000000\n       rcx = 0x000000010082a600\n       rdx = 0x0000000000000001\n       rdi = 0x000000016eff6800\n       rsi = 0x0000000100820e00\n       rbp = 0x00007fff5fbfc9d0\n       rsp = 0x00007fff5fbfc9d0\n        r8 = 0x0000000100110000\n        r9 = 0x0000000000000003\n       r10 = 0x0000000000000000\n       r11 = 0x0000000000000246\n       r12 = 0x0000000000000000\n       r13 = 0x0000000000000000\n       r14 = 0x0000000000000000\n       r15 = 0x0000000000000000\n       rip = 0x000000010000222d  mruby`array_copy + 61\n    rflags = 0x0000000000010206\n        cs = 0x000000000000002b\n        fs = 0x0000000000000000\n        gs = 0x0000000000000000\n\n(lldb) q\nQuitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n\n```\n\nA lldb process that we have symbols compiled in:\n\n```\n$ lldb ./mruby/bin/mruby crash.rb\n(lldb) target create \"./mruby/bin/mruby\"\nCurrent executable set to './mruby/bin/mruby' (x86_64).\n(lldb) settings set -- target.run-args  \"crash.rb\"\n(lldb) r\nProcess 30719 launched: './mruby/bin/mruby' (x86_64)\nProcess 30719 stopped\n* thread #1: tid = 0x78f948b, 0x0000000100001c5d mruby`array_copy(dst=0x000000016e7f6800, src=0x0000000101825c00, size=5184) + 61 at array.c:74, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x16e800000)\n    frame #0: 0x0000000100001c5d mruby`array_copy(dst=0x000000016e7f6800, src=0x0000000101825c00, size=5184) + 61 at array.c:74\n   71     mrb_int i;\n   72\n   73     for (i = 0; i < size; i++) {\n-> 74       dst[i] = src[i];\n   75     }\n   76   }\n   77\n(lldb) up\nframe #1: 0x0000000100003e67 mruby`mrb_ary_times(mrb=0x0000000100300390, self=mrb_value @ 0x00007fff5fbfca10) + 295 at array.c:350\n   347    a2 = ary_new_capa(mrb, a1->len * times);\n   348    ptr = a2->ptr;\n   349    while (times--) {\n-> 350      array_copy(ptr, a1->ptr, a1->len);\n   351      ptr += a1->len;\n   352      a2->len += a1->len;\n   353    }\n(lldb) p times\n(mrb_int) $0 = 51781\n(lldb) bt\n* thread #1: tid = 0x78f948b, 0x0000000100001c5d mruby`array_copy(dst=0x000000016e7f6800, src=0x0000000101825c00, size=5184) + 61 at array.c:74, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x16e800000)\n    frame #0: 0x0000000100001c5d mruby`array_copy(dst=0x000000016e7f6800, src=0x0000000101825c00, size=5184) + 61 at array.c:74\n  * frame #1: 0x0000000100003e67 mruby`mrb_ary_times(mrb=0x0000000100300390, self=mrb_value @ 0x00007fff5fbfca10) + 295 at array.c:350\n    frame #2: 0x000000010003f643 mruby`mrb_vm_exec(mrb=0x0000000100300390, proc=0x0000000101004df0, pc=0x000000010060f530) + 6739 at vm.c:1165\n    frame #3: 0x000000010003dbd7 mruby`mrb_vm_run(mrb=0x0000000100300390, proc=0x0000000101004e80, self=mrb_value @ 0x00007fff5fbfd6b0, stack_keep=0) + 135 at vm.c:766\n    frame #4: 0x0000000100046034 mruby`mrb_top_run(mrb=0x0000000100300390, proc=0x0000000101004e80, self=mrb_value @ 0x00007fff5fbfd720, stack_keep=0) + 100 at vm.c:2458\n    frame #5: 0x000000010007150f mruby`load_exec(mrb=0x0000000100300390, p=0x0000000101811420, c=0x000000010060ed90) + 1183 at parse.y:5747\n    frame #6: 0x0000000100071053 mruby`mrb_load_file_cxt(mrb=0x0000000100300390, f=0x00007fff7cda6050, c=0x000000010060ed90) + 67 at parse.y:5756\n    frame #7: 0x0000000100001208 mruby`main(argc=2, argv=0x00007fff5fbfdb40) + 904 at mruby.c:226\n    frame #8: 0x00007fff8a9db5ad libdyld.dylib`start + 1\n(lldb) q\nQuitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n\n```\n\nSo this is showing that we are trying to write to `0x16e800000`, which is within the bounds of the allocation. I added the following patch temporarily to further debug:\n\n```\ndiff --git a/src/array.c b/src/array.c\nindex 106353c..a880c61 100644\n--- a/src/array.c\n+++ b/src/array.c\n@@ -346,6 +346,7 @@ mrb_ary_times(mrb_state *mrb, mrb_value self)\n   }\n   a2 = ary_new_capa(mrb, a1->len * times);\n   ptr = a2->ptr;\n+  printf(\"ptr = %p, ptr + len*times = %p\\n\", ptr, ptr + a1->len * times);\n   while (times--) {\n     array_copy(ptr, a1->ptr, a1->len);\n     ptr += a1->len;\n\n```\n\nwhich gives the output of `ptr = 0x106aee000, ptr + len*times = 0x2732ee000` just before the segfault, which clearly shows that the allocation includes the address it is failing on.\n\nSo here is where I get lost, as I was confused why realloc didn't fail when it couldn't allocate the memory... BUT I figured out what was wrong. When checking possible size, we are using the `ARY_MAX_SIZE` macro, which is set to either `SIZE_MAX / sizeof(mrb_value)` or `MRB_INT_MAX`, whichever is smallest. Now you can see here that one divides by the size of `mrb_value`, and one doesn't. On my system (64bit), the MRB_INT_MAX is smaller, so it is using that. I suggest the following patch to fix this, by dividing that by the size of `mrb_value` as well. \n\n```\ndiff --git a/src/array.c b/src/array.c\nindex 106353c..ed2b346 100644\n--- a/src/array.c\n+++ b/src/array.c\n@@ -14,7 +14,8 @@\n #define ARY_DEFAULT_LEN   4\n #define ARY_SHRINK_RATIO  5 /* must be larger than 2 */\n #define ARY_C_MAX_SIZE (SIZE_MAX / sizeof(mrb_value))\n-#define ARY_MAX_SIZE ((ARY_C_MAX_SIZE < (size_t)MRB_INT_MAX) ? (mrb_int)ARY_C_MAX_SIZE : MRB_INT_MAX-1)\n+#define ARY_INT_MAX_SIZE ((size_t)MRB_INT_MAX / sizeof(mrb_value))\n+#define ARY_MAX_SIZE ((ARY_C_MAX_SIZE < ARY_INT_MAX_SIZE) ? (mrb_int)ARY_C_MAX_SIZE : (mrb_int)ARY_INT_MAX_SIZE)\n \n static struct RArray*\n ary_new_capa(mrb_state *mrb, mrb_int capa)\n```\n\nApplying this patch no longer crashes, and instead complains that the array size is too big.\n\n```\ntrace:\n        [0] crash.rb:8:in Object.call\n        [1] /Users/<snip>/mruby-engine/mruby/mrblib/array.rb:17:in Array.each\n        [2] crash.rb:4\ncrash.rb:8: array size too big (ArgumentError)\n```\n\nCheers,\n\nHugh", 
    "activity_page_count": 1, 
    "severity": {
        "rating": "low", 
        "author_type": "Team"
    }, 
    "title": "Invalid memory write caused by incorrect upper bound in array_copy", 
    "is_member_of_team?": null, 
    "vote_count": 6, 
    "summaries": [
        {
            "category": "team", 
            "can_create?": false, 
            "can_view?": true
        }, 
        {
            "category": "researcher", 
            "can_create?": false, 
            "can_view?": true
        }
    ], 
    "structured_scope": null, 
    "allow_singular_disclosure_at": "2017-01-16T20:12:15.170Z", 
    "state": "Closed", 
    "cve_ids": [], 
    "activity_page_number": 1, 
    "readable_substate": "Resolved", 
    "public": true, 
    "formatted_bounty": "$1,000", 
    "singular_disclosure_disabled": false, 
    "activities": [
        {
            "attachments": [
                {
                    "url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/137/671/54dc9398196f5a877c535e32cc267dbc5ee65a7b/crash-185899.rb?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T224533Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=2f91eb3fd8d3f0d16d7a53a139d8a449a0dd1b2658639416b7f50baf6d3f512b", 
                    "type": "text/plain", 
                    "id": 137671, 
                    "filename": "crash-185899.rb"
                }, 
                {
                    "url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/137/670/20a0358271996ee1ee49bdd140b42c77a129df6f/bug-185899.patch?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQTRM4X5HG%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T224533Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDDs%2B%2FH8tFp9eaL3SuyK3A4v0Gz1Pk4vLeyx%2Fa%2BOUYIBLln%2BHhEjo8aKsDgcWA0AVPWHQ1CqE69K0fwPJtemp0NnMHwpItZaKfQu2ndzpg6QamoxmJU6CxIEWtJEY3Xtdf2COsdrDtLDojEJ9Bsgq2dXSYC00tKxrlTs4yvW6oAYTu01sZU0MCDpTX84p3oRDZuLOTobhBvHMBRwkOe5yM9PnearXzpjHD9w6d9G0IdijQ15s%2Br%2FCrRq1RQ6%2FGlZaDOuMAFvLZ%2BDU%2BQ4elR42FJO7oqNOhTb7xFUKWMGUZD2l9vrtaQYBWgy8vLJL1PHKNL79uTgKO2gWJuruy5%2FR7g8iF%2F%2BDA%2FXyg6nD5MjJy8mSf4BsfZTsJ7bQ%2BmI19CRcsvBZU%2BD1gUjQkVgOsXdeI4LcCwhSIkIHIAnZLc3YhPCinZgj4lT9UYAmI6j6Ig003H%2B2wt4Gf4YVmv60G6zU1H8wWbJ%2Fm9tXcPEMDdtt2yoQpjl%2FLHFVDNhvjZwxcRsctZU64Qaim%2FPjSts6oYmu4TCHG6yWfeMPRxHXWIQV8xe%2BCLaMnof047dAbkRq5Dx8XgGLGEXX%2FVUX%2F8kf%2FiekmYRSZTqEyMUolrmm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=8c056940910d684a63cc03c3e613bd41050596556d2dd428dc446e9f0e4fdfa0", 
                    "type": "text/x-diff", 
                    "id": 137670, 
                    "filename": "bug-185899.patch"
                }
            ], 
            "automated_response": false, 
            "created_at": "2016-11-28T00:33:17.045Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-28T00:33:17.045Z", 
            "actor": {
                "username": "haquaman", 
                "url": "/haquaman", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/017/646/00e8f30e9c2903d8cd0fc7e31caadc141a3a9841_medium.png?1424925238"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Crashfile and patch.", 
            "markdown_message": "<p>Crashfile and patch.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1322087, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-29T15:42:18.886Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-29T15:42:18.886Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "additional_data": {
                "new_severity": "Low", 
                "old_severity": null
            }, 
            "team_handle": "shopify-scripts", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportSeverityUpdated", 
            "id": 1326528, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-29T15:48:37.990Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-29T15:48:37.990Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Hi @haquaman, and thanks for your report! It turns out that this issue does not affect mruby-engine because we build it with 64-bit integers:\n\nhttps://github.com/Shopify/mruby-engine/blob/53591f75fcfcddef30900820023c1a243b3d3240/ext/mruby_engine/flag_helper.rb#L22\n\nHowever, we would like to get bugs in MRuby fixed even if they don't currently affect mruby-engine, so we've submitted a patch: https://github.com/mruby/mruby/pull/3304", 
            "markdown_message": "<p>Hi <a href=\"/haquaman\">@haquaman</a>, and thanks for your report! It turns out that this issue does not affect mruby-engine because we build it with 64-bit integers:</p>\n\n<p><a title=\"https://github.com/Shopify/mruby-engine/blob/53591f75fcfcddef30900820023c1a243b3d3240/ext/mruby_engine/flag_helper.rb#L22\" href=\"/redirect?signature=8c2d5d2233687199d75132a458498baab5bf978e&amp;url=https%3A%2F%2Fgithub.com%2FShopify%2Fmruby-engine%2Fblob%2F53591f75fcfcddef30900820023c1a243b3d3240%2Fext%2Fmruby_engine%2Fflag_helper.rb%23L22\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://github.com/Shopify/mruby-engine/blob/53591f75fcfcddef30900820023c1a243b3d3240/ext/mruby_engine/flag_helper.rb#L22</span><i class=\"icon-external-link\"></i></a></p>\n\n<p>However, we would like to get bugs in MRuby fixed even if they don&#39;t currently affect mruby-engine, so we&#39;ve submitted a patch: <a title=\"https://github.com/mruby/mruby/pull/3304\" href=\"/redirect?signature=a8c48e1e1800557525429ac49d36761b7f27bacf&amp;url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fpull%2F3304\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://github.com/mruby/mruby/pull/3304</span><i class=\"icon-external-link\"></i></a></p>\n", 
            "type": "Activities::BugTriaged", 
            "id": 1326556, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-29T23:58:05.543Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-29T23:58:05.543Z", 
            "actor": {
                "username": "haquaman", 
                "url": "/haquaman", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/017/646/00e8f30e9c2903d8cd0fc7e31caadc141a3a9841_medium.png?1424925238"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Hi,\n\nNot sure that patch is quite correct, though it doesn't segfault for me anymore, but instead just runs forever (most likely allocating memory). That second check would be the only thing to take advantage of the type change, so changing the type would just change what is sent to realloc, and doesn't look like that is ever checked for bounds after that point.\n\nI really think the important part to change here is the test against ARY_MAX_SIZE, which would be incorrect in same cases, as that check is used in other places, like `ary_expand_capa`, and indirectly in `mrb_ary_plus` and `mrb_ary_times` (both of which just end up calling `ara_new_capa`). I'm sure that I could find a case that would affect `ary_expand_capa`, potentially with `mrb_ary_resize`, after this current patch is applied.\n\nHope that helps.\n\nCheers,\n\nHugh", 
            "markdown_message": "<p>Hi,</p>\n\n<p>Not sure that patch is quite correct, though it doesn&#39;t segfault for me anymore, but instead just runs forever (most likely allocating memory). That second check would be the only thing to take advantage of the type change, so changing the type would just change what is sent to realloc, and doesn&#39;t look like that is ever checked for bounds after that point.</p>\n\n<p>I really think the important part to change here is the test against ARY_MAX_SIZE, which would be incorrect in same cases, as that check is used in other places, like <code>ary_expand_capa</code>, and indirectly in <code>mrb_ary_plus</code> and <code>mrb_ary_times</code> (both of which just end up calling <code>ara_new_capa</code>). I&#39;m sure that I could find a case that would affect <code>ary_expand_capa</code>, potentially with <code>mrb_ary_resize</code>, after this current patch is applied.</p>\n\n<p>Hope that helps.</p>\n\n<p>Cheers,</p>\n\n<p>Hugh</p>\n", 
            "type": "Activities::Comment", 
            "id": 1328127, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-30T15:21:45.799Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-30T15:21:45.799Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "@haquaman It seems to me that the check against `MRB_INT_MAX` is only there because the array is indexed by an `mrb_int`, not because the allocated memory size needs to be less than `MRB_INT_MAX`.\n\nMost of the other malloc / realloc calls are already using a `size_t` but I did just notice that this one is using an `mrb_int`, so it likely needs to be patched: https://github.com/mruby/mruby/blob/8461a31cb491f272524d14a9e54fcc9fae7a22c1/src/array.c#L124-L128\n\nI'll check into that and open a second pull request if appropriate.", 
            "markdown_message": "<p><a href=\"/haquaman\">@haquaman</a> It seems to me that the check against <code>MRB_INT_MAX</code> is only there because the array is indexed by an <code>mrb_int</code>, not because the allocated memory size needs to be less than <code>MRB_INT_MAX</code>.</p>\n\n<p>Most of the other malloc / realloc calls are already using a <code>size_t</code> but I did just notice that this one is using an <code>mrb_int</code>, so it likely needs to be patched: <a title=\"https://github.com/mruby/mruby/blob/8461a31cb491f272524d14a9e54fcc9fae7a22c1/src/array.c#L124-L128\" href=\"/redirect?signature=99f18b77b75e3b400f9549011354c41299659cc9&amp;url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fblob%2F8461a31cb491f272524d14a9e54fcc9fae7a22c1%2Fsrc%2Farray.c%23L124-L128\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://github.com/mruby/mruby/blob/8461a31cb491f272524d14a9e54fcc9fae7a22c1/src/array.c#L124-L128</span><i class=\"icon-external-link\"></i></a></p>\n\n<p>I&#39;ll check into that and open a second pull request if appropriate.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1329944, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-30T15:23:33.135Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-30T15:23:33.135Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Oops, wrong lines. I meant to point here: https://github.com/mruby/mruby/blob/8461a31cb491f272524d14a9e54fcc9fae7a22c1/src/array.c#L121-L125", 
            "markdown_message": "<p>Oops, wrong lines. I meant to point here: <a title=\"https://github.com/mruby/mruby/blob/8461a31cb491f272524d14a9e54fcc9fae7a22c1/src/array.c#L121-L125\" href=\"/redirect?signature=c6ce2f76fb9f336e6d0ea57c76c8ba3bdc68d38e&amp;url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fblob%2F8461a31cb491f272524d14a9e54fcc9fae7a22c1%2Fsrc%2Farray.c%23L121-L125\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://github.com/mruby/mruby/blob/8461a31cb491f272524d14a9e54fcc9fae7a22c1/src/array.c#L121-L125</span><i class=\"icon-external-link\"></i></a></p>\n", 
            "type": "Activities::Comment", 
            "id": 1329956, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-30T19:31:29.016Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-30T19:31:29.016Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "This PR covers that bug, plus another overflow: https://github.com/mruby/mruby/pull/3309", 
            "markdown_message": "<p>This PR covers that bug, plus another overflow: <a title=\"https://github.com/mruby/mruby/pull/3309\" href=\"/redirect?signature=f5fb0fb99c193a2b84a26b369d7cfa77720dcf60&amp;url=https%3A%2F%2Fgithub.com%2Fmruby%2Fmruby%2Fpull%2F3309\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://github.com/mruby/mruby/pull/3309</span><i class=\"icon-external-link\"></i></a></p>\n", 
            "type": "Activities::Comment", 
            "id": 1330971, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-11-30T19:38:29.800Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-11-30T19:38:29.800Z", 
            "actor": {
                "username": "haquaman", 
                "url": "/haquaman", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/017/646/00e8f30e9c2903d8cd0fc7e31caadc141a3a9841_medium.png?1424925238"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Cool, will test that against a crash i just found yesterday against concat, may be that", 
            "markdown_message": "<p>Cool, will test that against a crash i just found yesterday against concat, may be that</p>\n", 
            "type": "Activities::Comment", 
            "id": 1331008, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "reporter": {
                "username": "haquaman", 
                "url": "/haquaman"
            }, 
            "created_at": "2016-12-07T21:54:04.513Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-07T21:54:04.513Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "Hi again. The integer overflow issues have now been resolved upstream. Since the issues never affected Shopify it might not be eligible for a bounty. We'll get back to you once we make a final decision.", 
            "markdown_message": "<p>Hi again. The integer overflow issues have now been resolved upstream. Since the issues never affected Shopify it might not be eligible for a bounty. We&#39;ll get back to you once we make a final decision.</p>\n", 
            "type": "Activities::BugResolved", 
            "id": 1348961, 
            "genius_execution_id": null
        }, 
        {
            "bounty_currency": "usd", 
            "automated_response": false, 
            "created_at": "2016-12-16T20:07:43.803Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-16T20:07:43.803Z", 
            "actor": {
                "url": "/shopify-scripts", 
                "profile": {
                    "name": "shopify-scripts"
                }, 
                "ibb": false, 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/015/668/b50db49e93f656e202ae6f94b4c0821d1184134b_medium.jpg?1475592254"
                }
            }, 
            "team_handle": "shopify-scripts", 
            "bounty_amount": "1000.0", 
            "collaborator": {
                "username": "haquaman", 
                "url": "/haquaman"
            }, 
            "message": "Thanks for helping improve the security of Shopify Scripts and the mruby project!", 
            "markdown_message": "<p>Thanks for helping improve the security of Shopify Scripts and the mruby project!</p>\n", 
            "type": "Activities::BountyAwarded", 
            "id": 1370104, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-12-17T20:12:15.146Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-17T20:12:15.146Z", 
            "actor": {
                "username": "haquaman", 
                "url": "/haquaman", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/017/646/00e8f30e9c2903d8cd0fc7e31caadc141a3a9841_medium.png?1424925238"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "first_to_agree": true, 
            "message": "Thanks for the bounty! Disclose?", 
            "markdown_message": "<p>Thanks for the bounty! Disclose?</p>\n", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1371662, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-12-18T13:23:23.921Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-18T13:23:23.921Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1372522, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-12-18T13:23:23.955Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-12-18T13:23:23.955Z", 
            "actor": {
                "username": "clayton", 
                "url": "/clayton", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/019/166/6d366b567e9fef1c476c1505c0016e3031a74a34_medium.jpg?1493127129"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "shopify-scripts", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportBecamePublic", 
            "id": 1372523, 
            "genius_execution_id": null
        }
    ], 
    "in_validation?": false, 
    "is_participant": false, 
    "singular_disclosure_allowed": true, 
    "reporter": {
        "username": "haquaman", 
        "hacker_mediation": false, 
        "hackerone_triager": false, 
        "disabled": false, 
        "url": "/haquaman", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/017/646/dc284cea5e3d18b7d17719465c17723a8349a967_small.png?1424925238"
        }, 
        "is_me?": false
    }, 
    "weakness": {
        "id": 48, 
        "name": "Denial of Service"
    }, 
    "is_external_bug": false, 
    "visibility": "full", 
    "allow_singular_disclosure_after": -59538797.88806634, 
    "disclosed_at": "2016-12-18T13:23:23.939Z", 
    "stage": 4, 
    "url": "https://hackerone.com/reports/185899", 
    "created_at": "2016-11-28T00:31:39.611Z", 
    "original_report_url": null, 
    "vulnerability_information_html": "<p>Ok, here is a weird one!</p>\n\n<p>It only crashes in mruby, and can&#39;t be made to crash in mruby-engine as max memory possible to extend to is 256M which this requires more.</p>\n\n<p>The file is:</p>\n<pre class=\"highlight plaintext\"><code>values = [3,5,8]\ntest = [1,6]\nresults,= [1.2]\nvalues.each do |value|\n  case value\n    when *test\n      results &lt;&lt; value\n    when *test*= results &lt;&lt;=value\n  end\nend\n</code></pre><pre class=\"highlight plaintext\"><code>$ ./dev/bin/mruby crash.rb\nSegmentation fault: 11\n</code></pre><pre class=\"highlight plaintext\"><code>$ lldb ./dev/bin/mruby crash.rb\n(lldb) target create &quot;./dev/bin/mruby&quot;\nCurrent executable set to &#39;./dev/bin/mruby&#39; (x86_64).\n(lldb) settings set -- target.run-args  &quot;crash.rb&quot;\n(lldb) r\nProcess 93838 launched: &#39;./dev/bin/mruby&#39; (x86_64)\nProcess 93838 stopped\n* thread #1: tid = 0x78effc5, 0x000000010000222d mruby`array_copy + 61, queue = &#39;com.apple.main-thread&#39;, stop reason = EXC_BAD_ACCESS (code=1, address=0x16f000000)\n    frame #0: 0x000000010000222d mruby`array_copy + 61\nmruby`array_copy:\n-&gt;  0x10000222d &lt;+61&gt;: movq   %rdx, (%rax)\n    0x100002230 &lt;+64&gt;: movq   0x8(%rcx), %rcx\n    0x100002234 &lt;+68&gt;: movq   %rcx, 0x8(%rax)\n    0x100002238 &lt;+72&gt;: movl   -0x18(%rbp), %eax\n(lldb) bt\n* thread #1: tid = 0x78effc5, 0x000000010000222d mruby`array_copy + 61, queue = &#39;com.apple.main-thread&#39;, stop reason = EXC_BAD_ACCESS (code=1, address=0x16f000000)\n  * frame #0: 0x000000010000222d mruby`array_copy + 61\n    frame #1: 0x0000000100004437 mruby`mrb_ary_times + 295\n    frame #2: 0x000000010003fc13 mruby`mrb_vm_exec + 6739\n    frame #3: 0x000000010003e1a7 mruby`mrb_vm_run + 135\n    frame #4: 0x0000000100046604 mruby`mrb_top_run + 100\n    frame #5: 0x0000000100071adf mruby`load_exec + 1183\n    frame #6: 0x0000000100071623 mruby`mrb_load_file_cxt + 67\n    frame #7: 0x00000001000017d8 mruby`main + 904\n    frame #8: 0x00007fff8a9db5ad libdyld.dylib`start + 1\n(lldb) register read\nGeneral Purpose Registers:\n       rax = 0x000000016f000000\n       rbx = 0x0000000000000000\n       rcx = 0x000000010082a600\n       rdx = 0x0000000000000001\n       rdi = 0x000000016eff6800\n       rsi = 0x0000000100820e00\n       rbp = 0x00007fff5fbfc9d0\n       rsp = 0x00007fff5fbfc9d0\n        r8 = 0x0000000100110000\n        r9 = 0x0000000000000003\n       r10 = 0x0000000000000000\n       r11 = 0x0000000000000246\n       r12 = 0x0000000000000000\n       r13 = 0x0000000000000000\n       r14 = 0x0000000000000000\n       r15 = 0x0000000000000000\n       rip = 0x000000010000222d  mruby`array_copy + 61\n    rflags = 0x0000000000010206\n        cs = 0x000000000000002b\n        fs = 0x0000000000000000\n        gs = 0x0000000000000000\n\n(lldb) q\nQuitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n\n</code></pre>\n<p>A lldb process that we have symbols compiled in:</p>\n<pre class=\"highlight plaintext\"><code>$ lldb ./mruby/bin/mruby crash.rb\n(lldb) target create &quot;./mruby/bin/mruby&quot;\nCurrent executable set to &#39;./mruby/bin/mruby&#39; (x86_64).\n(lldb) settings set -- target.run-args  &quot;crash.rb&quot;\n(lldb) r\nProcess 30719 launched: &#39;./mruby/bin/mruby&#39; (x86_64)\nProcess 30719 stopped\n* thread #1: tid = 0x78f948b, 0x0000000100001c5d mruby`array_copy(dst=0x000000016e7f6800, src=0x0000000101825c00, size=5184) + 61 at array.c:74, queue = &#39;com.apple.main-thread&#39;, stop reason = EXC_BAD_ACCESS (code=1, address=0x16e800000)\n    frame #0: 0x0000000100001c5d mruby`array_copy(dst=0x000000016e7f6800, src=0x0000000101825c00, size=5184) + 61 at array.c:74\n   71     mrb_int i;\n   72\n   73     for (i = 0; i &lt; size; i++) {\n-&gt; 74       dst[i] = src[i];\n   75     }\n   76   }\n   77\n(lldb) up\nframe #1: 0x0000000100003e67 mruby`mrb_ary_times(mrb=0x0000000100300390, self=mrb_value @ 0x00007fff5fbfca10) + 295 at array.c:350\n   347    a2 = ary_new_capa(mrb, a1-&gt;len * times);\n   348    ptr = a2-&gt;ptr;\n   349    while (times--) {\n-&gt; 350      array_copy(ptr, a1-&gt;ptr, a1-&gt;len);\n   351      ptr += a1-&gt;len;\n   352      a2-&gt;len += a1-&gt;len;\n   353    }\n(lldb) p times\n(mrb_int) $0 = 51781\n(lldb) bt\n* thread #1: tid = 0x78f948b, 0x0000000100001c5d mruby`array_copy(dst=0x000000016e7f6800, src=0x0000000101825c00, size=5184) + 61 at array.c:74, queue = &#39;com.apple.main-thread&#39;, stop reason = EXC_BAD_ACCESS (code=1, address=0x16e800000)\n    frame #0: 0x0000000100001c5d mruby`array_copy(dst=0x000000016e7f6800, src=0x0000000101825c00, size=5184) + 61 at array.c:74\n  * frame #1: 0x0000000100003e67 mruby`mrb_ary_times(mrb=0x0000000100300390, self=mrb_value @ 0x00007fff5fbfca10) + 295 at array.c:350\n    frame #2: 0x000000010003f643 mruby`mrb_vm_exec(mrb=0x0000000100300390, proc=0x0000000101004df0, pc=0x000000010060f530) + 6739 at vm.c:1165\n    frame #3: 0x000000010003dbd7 mruby`mrb_vm_run(mrb=0x0000000100300390, proc=0x0000000101004e80, self=mrb_value @ 0x00007fff5fbfd6b0, stack_keep=0) + 135 at vm.c:766\n    frame #4: 0x0000000100046034 mruby`mrb_top_run(mrb=0x0000000100300390, proc=0x0000000101004e80, self=mrb_value @ 0x00007fff5fbfd720, stack_keep=0) + 100 at vm.c:2458\n    frame #5: 0x000000010007150f mruby`load_exec(mrb=0x0000000100300390, p=0x0000000101811420, c=0x000000010060ed90) + 1183 at parse.y:5747\n    frame #6: 0x0000000100071053 mruby`mrb_load_file_cxt(mrb=0x0000000100300390, f=0x00007fff7cda6050, c=0x000000010060ed90) + 67 at parse.y:5756\n    frame #7: 0x0000000100001208 mruby`main(argc=2, argv=0x00007fff5fbfdb40) + 904 at mruby.c:226\n    frame #8: 0x00007fff8a9db5ad libdyld.dylib`start + 1\n(lldb) q\nQuitting LLDB will kill one or more processes. Do you really want to proceed: [Y/n] y\n\n</code></pre>\n<p>So this is showing that we are trying to write to <code>0x16e800000</code>, which is within the bounds of the allocation. I added the following patch temporarily to further debug:</p>\n<pre class=\"highlight diff\"><code><span class=\"gh\">diff --git a/src/array.c b/src/array.c\nindex 106353c..a880c61 100644\n</span><span class=\"gd\">--- a/src/array.c\n</span><span class=\"gi\">+++ b/src/array.c\n</span><span class=\"gu\">@@ -346,6 +346,7 @@ mrb_ary_times(mrb_state *mrb, mrb_value self)\n</span>   }\n   a2 = ary_new_capa(mrb, a1-&gt;len * times);\n   ptr = a2-&gt;ptr;\n<span class=\"gi\">+  printf(&quot;ptr = %p, ptr + len*times = %p\\n&quot;, ptr, ptr + a1-&gt;len * times);\n</span>   while (times--) {\n     array_copy(ptr, a1-&gt;ptr, a1-&gt;len);\n     ptr += a1-&gt;len;\n\n</code></pre>\n<p>which gives the output of <code>ptr = 0x106aee000, ptr + len*times = 0x2732ee000</code> just before the segfault, which clearly shows that the allocation includes the address it is failing on.</p>\n\n<p>So here is where I get lost, as I was confused why realloc didn&#39;t fail when it couldn&#39;t allocate the memory... BUT I figured out what was wrong. When checking possible size, we are using the <code>ARY_MAX_SIZE</code> macro, which is set to either <code>SIZE_MAX / sizeof(mrb_value)</code> or <code>MRB_INT_MAX</code>, whichever is smallest. Now you can see here that one divides by the size of <code>mrb_value</code>, and one doesn&#39;t. On my system (64bit), the MRB_INT_MAX is smaller, so it is using that. I suggest the following patch to fix this, by dividing that by the size of <code>mrb_value</code> as well. </p>\n<pre class=\"highlight diff\"><code><span class=\"gh\">diff --git a/src/array.c b/src/array.c\nindex 106353c..ed2b346 100644\n</span><span class=\"gd\">--- a/src/array.c\n</span><span class=\"gi\">+++ b/src/array.c\n</span><span class=\"gu\">@@ -14,7 +14,8 @@\n</span> #define ARY_DEFAULT_LEN   4\n #define ARY_SHRINK_RATIO  5 /* must be larger than 2 */\n #define ARY_C_MAX_SIZE (SIZE_MAX / sizeof(mrb_value))\n<span class=\"gd\">-#define ARY_MAX_SIZE ((ARY_C_MAX_SIZE &lt; (size_t)MRB_INT_MAX) ? (mrb_int)ARY_C_MAX_SIZE : MRB_INT_MAX-1)\n</span><span class=\"gi\">+#define ARY_INT_MAX_SIZE ((size_t)MRB_INT_MAX / sizeof(mrb_value))\n+#define ARY_MAX_SIZE ((ARY_C_MAX_SIZE &lt; ARY_INT_MAX_SIZE) ? (mrb_int)ARY_C_MAX_SIZE : (mrb_int)ARY_INT_MAX_SIZE)\n</span>\n static struct RArray*\n ary_new_capa(mrb_state *mrb, mrb_int capa)\n</code></pre>\n<p>Applying this patch no longer crashes, and instead complains that the array size is too big.</p>\n<pre class=\"highlight plaintext\"><code>trace:\n        [0] crash.rb:8:in Object.call\n        [1] /Users/&lt;snip&gt;/mruby-engine/mruby/mrblib/array.rb:17:in Array.each\n        [2] crash.rb:4\ncrash.rb:8: array size too big (ArgumentError)\n</code></pre>\n<p>Cheers,</p>\n\n<p>Hugh</p>\n", 
    "severity_rating": "low", 
    "team_private?": false, 
    "team": {
        "profile": {
            "website": "https://www.mruby.science", 
            "about": "", 
            "twitter_handle": "", 
            "name": "shopify-scripts"
        }, 
        "handle": "shopify-scripts", 
        "url": "https://hackerone.com/shopify-scripts", 
        "state": "public_mode", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/015/668/9f47d94cbd9e4311b57f1ab05f67fb5c26fd2e78_small.jpg?1475592254", 
            "medium": "https://profile-photos.hackerone-user-content.com/000/015/668/b50db49e93f656e202ae6f94b4c0821d1184134b_medium.jpg?1475592254"
        }, 
        "awards_miles": false, 
        "permissions": [], 
        "id": 15668, 
        "default_currency": "usd"
    }, 
    "is_published": false
}