{
    "abilities": {
        "can_manage_common_responses?": false, 
        "can_manage_collaborators?": false, 
        "can_reopen?": false, 
        "can_ban_researcher?": false, 
        "can_create_severity?": false, 
        "can_assign_to_h1_triage?": false, 
        "can_agree_on_going_public?": false, 
        "assignable_team_member_groups": [], 
        "can_view_credential_account_details?": false, 
        "can_export?": false, 
        "can_create_retest?": false, 
        "can_assign_to_user?": false, 
        "can_use_common_responses?": false, 
        "can_hide_timeline?": false, 
        "can_be_manually_disclosed?": false, 
        "assignable_team_members": [], 
        "can_clone?": false, 
        "can_be_publicly_disclosed?": false, 
        "can_close_comments?": false, 
        "can_view_bounty_weights?": false, 
        "can_suggest_bounty_amount?": false, 
        "can_cancel_disclosure_request?": false, 
        "can_redact?": false, 
        "can_change_structured_scope?": false, 
        "can_post_internal_comments?": false, 
        "can_change_state?": false, 
        "can_change_weakness?": false, 
        "can_add_comment?": false, 
        "can_reassign_to_team?": false, 
        "can_change_title?": false, 
        "can_award_bounty?": false, 
        "can_award_swag?": false, 
        "can_close?": false, 
        "can_manage?": false
    }, 
    "comments_closed?": false, 
    "substate": "resolved", 
    "bug_reporter_agreed_on_going_public_at": "2017-10-19T10:15:23.372Z", 
    "voters": [
        "eveeez", 
        "geeknik", 
        "mr_r3boot", 
        "spetr0x", 
        "hthomison1078"
    ], 
    "facebook_team?": false, 
    "has_bounty?": true, 
    "bounty_amount": "100.0", 
    "rejected_anc_report_that_can_be_sent_back_to_anc_triagers?": false, 
    "original_report_id": null, 
    "id": 163459, 
    "can_view_team": true, 
    "team_member_agreed_on_going_public_at": "2017-10-19T09:40:01.930Z", 
    "activity_page_count": 1, 
    "activity_page_number": 1, 
    "title": "potential memory corruption in or/buffers.c (particularly on 32 bit)", 
    "is_member_of_team?": null, 
    "vote_count": 5, 
    "summaries": [
        {
            "category": "team", 
            "can_create?": false, 
            "can_view?": true
        }, 
        {
            "category": "researcher", 
            "can_create?": false, 
            "can_view?": true
        }
    ], 
    "structured_scope": null, 
    "allow_singular_disclosure_at": "2017-11-18T09:40:01.986Z", 
    "state": "Closed", 
    "cve_ids": [], 
    "readable_substate": "Resolved", 
    "public": true, 
    "formatted_bounty": "$100", 
    "singular_disclosure_disabled": false, 
    "activities": [
        {
            "automated_response": false, 
            "created_at": "2016-09-04T22:17:41.251Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-04T22:17:41.251Z", 
            "actor": {
                "username": "guido", 
                "url": "/guido", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/002/983/055f2e31c3b25e230eeb37461df974006ba7b0bd_medium.jpg?1403536399"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "Hey, could you please let me know your thoughts? I understand that it's only a hypothetical vulnerability at this point so if it's not eligible then that's that but please let me know, thanks.", 
            "markdown_message": "<p>Hey, could you please let me know your thoughts? I understand that it&#39;s only a hypothetical vulnerability at this point so if it&#39;s not eligible then that&#39;s that but please let me know, thanks.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1172805, 
            "genius_execution_id": null
        }, 
        {
            "bounty_currency": "usd", 
            "automated_response": false, 
            "created_at": "2016-09-06T10:46:36.895Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-06T10:46:36.895Z", 
            "actor": {
                "url": "/torproject", 
                "profile": {
                    "name": "Tor"
                }, 
                "ibb": false, 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/001/800/f60c4e0509668a31fcd9604fc653ef8a43f2e5c4_medium.jpg?1453239375"
                }
            }, 
            "team_handle": "torproject", 
            "bounty_amount": "100.0", 
            "collaborator": {
                "username": "guido", 
                "url": "/guido"
            }, 
            "message": "Greetings Guido,\n\nsorry for the late reply. It's been a busy summer!\n\nAfter discussion with the dev team, we decided to award $100 to this bug. We also didn't find an exploitable attack vector for the bug, but it's still a code error that needs to be fixed.\n\nDo you have a suggested patch?\n\nThanks for the report!", 
            "markdown_message": "<p>Greetings Guido,</p>\n\n<p>sorry for the late reply. It&#39;s been a busy summer!</p>\n\n<p>After discussion with the dev team, we decided to award $100 to this bug. We also didn&#39;t find an exploitable attack vector for the bug, but it&#39;s still a code error that needs to be fixed.</p>\n\n<p>Do you have a suggested patch?</p>\n\n<p>Thanks for the report!</p>\n", 
            "type": "Activities::BountyAwarded", 
            "id": 1176663, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-09-12T09:05:36.138Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-12T09:05:36.138Z", 
            "actor": {
                "username": "guido", 
                "url": "/guido", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/002/983/055f2e31c3b25e230eeb37461df974006ba7b0bd_medium.jpg?1403536399"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "Thanks!\n\nHow about this?\n\n```diff\ndiff --git a/d.c b/d.c\nindex 045a678..1a50261 100644\n--- a/d.c\n+++ b/d.c\n@@ -29,8 +29,11 @@ static inline size_t\n preferred_chunk_size(size_t target)\n {\n   size_t sz = MIN_CHUNK_ALLOC;\n+  size_t prev = 0;\n   while (CHUNK_SIZE_WITH_ALLOC(sz) < target) {\n     sz <<= 1;\n+    tor_assert(sz > prev);\n+    prev = sz;\n   }\n   return sz;\n }\n```\n\nIt's agnostic as to whether the system is 32 or 64 bit, deals with the core problem (preventing the actual overflow), and lets other functions (such as ```tor_malloc```) deal with outrageous allocatiion sizes if applicable. If you want proper error handling instead of a hard abort through ```tor_assert()``` then more changes are necessarily, but I'd say that since Tor's general memory consumption is at present relatively frugal, attempts to allocate 2+ GB's of memory are an indication that something is already amiss so an abort is the way to go.", 
            "markdown_message": "<p>Thanks!</p>\n\n<p>How about this?</p>\n<pre class=\"highlight diff\"><code><span class=\"gh\">diff --git a/d.c b/d.c\nindex 045a678..1a50261 100644\n</span><span class=\"gd\">--- a/d.c\n</span><span class=\"gi\">+++ b/d.c\n</span><span class=\"gu\">@@ -29,8 +29,11 @@ static inline size_t\n</span> preferred_chunk_size(size_t target)\n {\n   size_t sz = MIN_CHUNK_ALLOC;\n<span class=\"gi\">+  size_t prev = 0;\n</span>   while (CHUNK_SIZE_WITH_ALLOC(sz) &lt; target) {\n     sz &lt;&lt;= 1;\n<span class=\"gi\">+    tor_assert(sz &gt; prev);\n+    prev = sz;\n</span>   }\n   return sz;\n }\n</code></pre>\n<p>It&#39;s agnostic as to whether the system is 32 or 64 bit, deals with the core problem (preventing the actual overflow), and lets other functions (such as <code>tor_malloc</code>) deal with outrageous allocatiion sizes if applicable. If you want proper error handling instead of a hard abort through <code>tor_assert()</code> then more changes are necessarily, but I&#39;d say that since Tor&#39;s general memory consumption is at present relatively frugal, attempts to allocate 2+ GB&#39;s of memory are an indication that something is already amiss so an abort is the way to go.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1188151, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-09-12T09:14:08.932Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-12T09:14:08.932Z", 
            "actor": {
                "username": "guido", 
                "url": "/guido", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/002/983/055f2e31c3b25e230eeb37461df974006ba7b0bd_medium.jpg?1403536399"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "By the way, if you happen to value my services, and you'd like me to scrutinize any other Tor software written in C under the same terms as this bug bounty program (only pay upon submission of valuable security-enhancing information), whether within the HackerOne program or under a private arrangement, I'd gladly agree to that.. Let me know.", 
            "markdown_message": "<p>By the way, if you happen to value my services, and you&#39;d like me to scrutinize any other Tor software written in C under the same terms as this bug bounty program (only pay upon submission of valuable security-enhancing information), whether within the HackerOne program or under a private arrangement, I&#39;d gladly agree to that.. Let me know.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1188162, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "reporter": {
                "username": "guido", 
                "url": "/guido"
            }, 
            "created_at": "2016-09-13T13:10:44.888Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-13T13:10:44.888Z", 
            "actor": {
                "username": "asn", 
                "url": "/asn", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "Hello Guido,\n\nwe are almost ready to merge a fix to this bug. Please see https://trac.torproject.org/projects/tor/ticket/20081 for a discussion on the patch.\n\nClosing issue.", 
            "markdown_message": "<p>Hello Guido,</p>\n\n<p>we are almost ready to merge a fix to this bug. Please see <a title=\"https://trac.torproject.org/projects/tor/ticket/20081\" href=\"/redirect?signature=4aa0ccaa10a6bf18ec556bfcfcd91bcd9bb4a473&amp;url=https%3A%2F%2Ftrac.torproject.org%2Fprojects%2Ftor%2Fticket%2F20081\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://trac.torproject.org/projects/tor/ticket/20081</span><i class=\"icon-external-link\"></i></a> for a discussion on the patch.</p>\n\n<p>Closing issue.</p>\n", 
            "type": "Activities::BugResolved", 
            "id": 1190873, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-09-13T17:00:07.792Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-13T17:00:07.792Z", 
            "actor": {
                "username": "guido", 
                "url": "/guido", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/002/983/055f2e31c3b25e230eeb37461df974006ba7b0bd_medium.jpg?1403536399"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "Cool.\n\nAny thoughts on my offer?", 
            "markdown_message": "<p>Cool.</p>\n\n<p>Any thoughts on my offer?</p>\n", 
            "type": "Activities::Comment", 
            "id": 1191411, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-09-13T17:07:32.700Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-13T17:07:32.700Z", 
            "actor": {
                "username": "asn", 
                "url": "/asn", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "Hey Guido. I can't think of other Tor software in C that would require auditing. Which one are you thinking of?", 
            "markdown_message": "<p>Hey Guido. I can&#39;t think of other Tor software in C that would require auditing. Which one are you thinking of?</p>\n", 
            "type": "Activities::Comment", 
            "id": 1191424, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-09-13T17:24:17.328Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-13T17:24:17.328Z", 
            "actor": {
                "username": "guido", 
                "url": "/guido", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/002/983/055f2e31c3b25e230eeb37461df974006ba7b0bd_medium.jpg?1403536399"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "torsocks\ntor messenger seems to have C dependencies (libgcrypt etc) https://gitweb.torproject.org/tor-messenger-build.git/tree/projects\nOrbot too https://github.com/n8fr8/orbot/tree/master/external\nPython projects with C dependencies such as pycrpto https://gitweb.torproject.org/stem.git/tree/requirements.txt\netcetera.\n\nOnly vulnerabilities that 1) directly, remotely and severely (heap corruption and worse) affect the Tor software and 2) are not covered by another bounty program, of course.", 
            "markdown_message": "<p>torsocks<br>\ntor messenger seems to have C dependencies (libgcrypt etc) <a title=\"https://gitweb.torproject.org/tor-messenger-build.git/tree/projects\" href=\"/redirect?signature=fda2c1c513ab5f8301034b78384bf77fedb76f44&amp;url=https%3A%2F%2Fgitweb.torproject.org%2Ftor-messenger-build.git%2Ftree%2Fprojects\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://gitweb.torproject.org/tor-messenger-build.git/tree/projects</span><i class=\"icon-external-link\"></i></a><br>\nOrbot too <a title=\"https://github.com/n8fr8/orbot/tree/master/external\" href=\"/redirect?signature=b07575c353ba4743f380411e92bae5921781c57a&amp;url=https%3A%2F%2Fgithub.com%2Fn8fr8%2Forbot%2Ftree%2Fmaster%2Fexternal\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://github.com/n8fr8/orbot/tree/master/external</span><i class=\"icon-external-link\"></i></a><br>\nPython projects with C dependencies such as pycrpto <a title=\"https://gitweb.torproject.org/stem.git/tree/requirements.txt\" href=\"/redirect?signature=fd989c8c738f79d20a5cfdf721df16403508602f&amp;url=https%3A%2F%2Fgitweb.torproject.org%2Fstem.git%2Ftree%2Frequirements.txt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><span>https://gitweb.torproject.org/stem.git/tree/requirements.txt</span><i class=\"icon-external-link\"></i></a><br>\netcetera.</p>\n\n<p>Only vulnerabilities that 1) directly, remotely and severely (heap corruption and worse) affect the Tor software and 2) are not covered by another bounty program, of course.</p>\n", 
            "type": "Activities::Comment", 
            "id": 1191451, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-09-14T16:59:54.470Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-14T16:59:54.470Z", 
            "actor": {
                "username": "asn", 
                "url": "/asn", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "Hello Guido.\n\nI discussed this with other Tor hackerone admins and we came to the conclusion that it's too early for us to expand to those projects as well.\n\nWe are already spread quite thin by the current bug bounty project, and we think that adding additional software will overload us even more. Let alone we will have to find people from each project to do the bug review.\n\nAll in all, we are still in testing phase of the bug bounty program so we can't take you up on your offer. We plan to improve our hackerone scalability in the future (by getting more people to be responsible for it), but we are still super busy putting out other fires.\n\nCheers :)", 
            "markdown_message": "<p>Hello Guido.</p>\n\n<p>I discussed this with other Tor hackerone admins and we came to the conclusion that it&#39;s too early for us to expand to those projects as well.</p>\n\n<p>We are already spread quite thin by the current bug bounty project, and we think that adding additional software will overload us even more. Let alone we will have to find people from each project to do the bug review.</p>\n\n<p>All in all, we are still in testing phase of the bug bounty program so we can&#39;t take you up on your offer. We plan to improve our hackerone scalability in the future (by getting more people to be responsible for it), but we are still super busy putting out other fires.</p>\n\n<p>Cheers :)</p>\n", 
            "type": "Activities::Comment", 
            "id": 1193928, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2016-09-14T17:31:58.326Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2016-09-14T17:31:58.326Z", 
            "actor": {
                "username": "guido", 
                "url": "/guido", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/002/983/055f2e31c3b25e230eeb37461df974006ba7b0bd_medium.jpg?1403536399"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "Understood. Thank you very much for considering it!", 
            "markdown_message": "<p>Understood. Thank you very much for considering it!</p>\n", 
            "type": "Activities::Comment", 
            "id": 1193998, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-10-19T09:40:01.959Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-10-19T09:40:01.959Z", 
            "actor": {
                "username": "geko", 
                "url": "/geko", 
                "profile_picture_urls": {
                    "medium": "/assets/avatars/default-71a302d706457f3d3a31eb30fa3e73e6cf0b1d677b8fa218eaeaffd67ae97918.png"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "first_to_agree": true, 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 2083677, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-10-19T10:15:23.394Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-10-19T10:15:23.394Z", 
            "actor": {
                "username": "guido", 
                "url": "/guido", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/002/983/055f2e31c3b25e230eeb37461df974006ba7b0bd_medium.jpg?1403536399"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::AgreedOnGoingPublic", 
            "id": 2083735, 
            "genius_execution_id": null
        }, 
        {
            "automated_response": false, 
            "created_at": "2017-10-19T10:15:23.453Z", 
            "is_internal": false, 
            "editable": false, 
            "updated_at": "2017-10-19T10:15:23.453Z", 
            "actor": {
                "username": "guido", 
                "url": "/guido", 
                "profile_picture_urls": {
                    "medium": "https://profile-photos.hackerone-user-content.com/000/002/983/055f2e31c3b25e230eeb37461df974006ba7b0bd_medium.jpg?1403536399"
                }, 
                "hackerone_triager": false
            }, 
            "team_handle": "torproject", 
            "message": "", 
            "markdown_message": "", 
            "type": "Activities::ReportBecamePublic", 
            "id": 2083736, 
            "genius_execution_id": null
        }
    ], 
    "in_validation?": false, 
    "is_participant": false, 
    "singular_disclosure_allowed": true, 
    "reporter": {
        "username": "guido", 
        "hacker_mediation": false, 
        "hackerone_triager": false, 
        "disabled": false, 
        "url": "/guido", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/002/983/bc1fffcbbb736a8fa94816a1961b7b76725881eb_small.jpg?1403536399"
        }, 
        "is_me?": false
    }, 
    "weakness": {
        "id": 2, 
        "name": "Memory Corruption - Generic"
    }, 
    "is_external_bug": false, 
    "visibility": "full", 
    "allow_singular_disclosure_after": -33137476.171543367, 
    "disclosed_at": "2017-10-19T10:15:23.431Z", 
    "stage": 4, 
    "url": "https://hackerone.com/reports/163459", 
    "created_at": "2016-08-26T01:06:27.016Z", 
    "original_report_url": null, 
    "vulnerability_information_html": "<p>In <code>or/buffer.s.c</code>:</p>\n<pre class=\"highlight c\"><code><span class=\"cm\">/** Return the allocation size we&#39;d like to use to hold &lt;b&gt;target&lt;/b&gt;\n * bytes. */</span>\n<span class=\"k\">static</span> <span class=\"kr\">inline</span> <span class=\"kt\">size_t</span>\n<span class=\"nf\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"kt\">size_t</span> <span class=\"n\">target</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n  <span class=\"kt\">size_t</span> <span class=\"n\">sz</span> <span class=\"o\">=</span> <span class=\"n\">MIN_CHUNK_ALLOC</span><span class=\"p\">;</span>\n  <span class=\"k\">while</span> <span class=\"p\">(</span><span class=\"n\">CHUNK_SIZE_WITH_ALLOC</span><span class=\"p\">(</span><span class=\"n\">sz</span><span class=\"p\">)</span> <span class=\"o\">&lt;</span> <span class=\"n\">target</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"n\">sz</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">return</span> <span class=\"n\">sz</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre><pre class=\"highlight c\"><code><span class=\"cp\">#define MIN_CHUNK_ALLOC 256\n#define CHUNK_SIZE_WITH_ALLOC(memlen) ((memlen) - CHUNK_HEADER_LEN)\n</span></code></pre>\n<p>CHUNK_HEADER_LEN is usually around 30 bytes or so.</p>\n\n<p>The problem with <code>preferred_chunk_size</code> is that for a large <code>size_t target</code>, the function will return 0.</p>\n\n<p>If you compile this program with <code>-m32</code>:</p>\n<pre class=\"highlight c\"><code><span class=\"cp\">#include &lt;stdio.h&gt;\n#include &lt;stdint.h&gt;\n#define FLEXIBLE_ARRAY_MEMBER </span><span class=\"cm\">/**/</span><span class=\"cp\">\n#define DEBUG_CHUNK_ALLOC\n</span><span class=\"cm\">/** A single chunk on a buffer. */</span>\n<span class=\"k\">typedef</span> <span class=\"k\">struct</span> <span class=\"n\">chunk_t</span> <span class=\"p\">{</span>\n  <span class=\"k\">struct</span> <span class=\"n\">chunk_t</span> <span class=\"o\">*</span><span class=\"n\">next</span><span class=\"p\">;</span> <span class=\"cm\">/**&lt; The next chunk on the buffer. */</span>\n  <span class=\"kt\">size_t</span> <span class=\"n\">datalen</span><span class=\"p\">;</span> <span class=\"cm\">/**&lt; The number of bytes stored in this chunk */</span>\n  <span class=\"kt\">size_t</span> <span class=\"n\">memlen</span><span class=\"p\">;</span> <span class=\"cm\">/**&lt; The number of usable bytes of storage in &lt;b&gt;mem&lt;/b&gt;. */</span>\n<span class=\"cp\">#ifdef DEBUG_CHUNK_ALLOC\n</span>  <span class=\"kt\">size_t</span> <span class=\"n\">DBG_alloc</span><span class=\"p\">;</span>\n<span class=\"cp\">#endif\n</span>  <span class=\"kt\">char</span> <span class=\"o\">*</span><span class=\"n\">data</span><span class=\"p\">;</span> <span class=\"cm\">/**&lt; A pointer to the first byte of data stored in &lt;b&gt;mem&lt;/b&gt;. */</span>\n  <span class=\"kt\">uint32_t</span> <span class=\"n\">inserted_time</span><span class=\"p\">;</span> <span class=\"cm\">/**&lt; Timestamp in truncated ms since epoch\n                           * when this chunk was inserted. */</span>\n  <span class=\"kt\">char</span> <span class=\"n\">mem</span><span class=\"p\">[</span><span class=\"n\">FLEXIBLE_ARRAY_MEMBER</span><span class=\"p\">];</span> <span class=\"cm\">/**&lt; The actual memory used for storage in\n                * this chunk. */</span>\n<span class=\"p\">}</span> <span class=\"n\">chunk_t</span><span class=\"p\">;</span>\n<span class=\"cp\">#if defined(__GNUC__) &amp;&amp; __GNUC__ &gt; 3\n#define STRUCT_OFFSET(tp, member) __builtin_offsetof(tp, member)\n#else\n</span> <span class=\"cp\">#define STRUCT_OFFSET(tp, member) \\\n   ((off_t) (((char*)&amp;((tp*)0)-&gt;member)-(char*)0))\n#endif\n#define MIN_CHUNK_ALLOC 256\n#define CHUNK_HEADER_LEN STRUCT_OFFSET(chunk_t, mem[0])\n#define CHUNK_SIZE_WITH_ALLOC(memlen) ((memlen) - CHUNK_HEADER_LEN)\n</span><span class=\"k\">static</span> <span class=\"kr\">inline</span> <span class=\"kt\">size_t</span>\n<span class=\"nf\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"kt\">size_t</span> <span class=\"n\">target</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n  <span class=\"kt\">size_t</span> <span class=\"n\">sz</span> <span class=\"o\">=</span> <span class=\"n\">MIN_CHUNK_ALLOC</span><span class=\"p\">;</span>\n  <span class=\"k\">while</span> <span class=\"p\">(</span><span class=\"n\">CHUNK_SIZE_WITH_ALLOC</span><span class=\"p\">(</span><span class=\"n\">sz</span><span class=\"p\">)</span> <span class=\"o\">&lt;</span> <span class=\"n\">target</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"n\">sz</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">return</span> <span class=\"n\">sz</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span> <span class=\"nf\">main</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"p\">)</span>\n<span class=\"p\">{</span>\n    <span class=\"kt\">size_t</span> <span class=\"n\">i</span> <span class=\"o\">=</span> <span class=\"mi\">1024</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">&quot;i is %08X, preferred_chunk_size is %08X</span><span class=\"se\">\\n</span><span class=\"s\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">));</span> <span class=\"n\">i</span> <span class=\"o\">&lt;&lt;=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"k\">return</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre>\n<p>the output is:</p>\n<pre class=\"highlight plaintext\"><code>i is 00000400, preferred_chunk_size is 00000800\ni is 00000800, preferred_chunk_size is 00001000\ni is 00001000, preferred_chunk_size is 00002000\ni is 00002000, preferred_chunk_size is 00004000\ni is 00004000, preferred_chunk_size is 00008000\ni is 00008000, preferred_chunk_size is 00010000\ni is 00010000, preferred_chunk_size is 00020000\ni is 00020000, preferred_chunk_size is 00040000\ni is 00040000, preferred_chunk_size is 00080000\ni is 00080000, preferred_chunk_size is 00100000\ni is 00100000, preferred_chunk_size is 00200000\ni is 00200000, preferred_chunk_size is 00400000\ni is 00400000, preferred_chunk_size is 00800000\ni is 00800000, preferred_chunk_size is 01000000\ni is 01000000, preferred_chunk_size is 02000000\ni is 02000000, preferred_chunk_size is 04000000\ni is 04000000, preferred_chunk_size is 08000000\ni is 08000000, preferred_chunk_size is 10000000\ni is 10000000, preferred_chunk_size is 20000000\ni is 20000000, preferred_chunk_size is 40000000\ni is 40000000, preferred_chunk_size is 80000000\ni is 80000000, preferred_chunk_size is 00000000\n</code></pre>\n<p>The danger is that the return value of <code>preferred_chunk_size</code> is always used as a parameter to <code>tor_malloc</code> or <code>tor_realloc</code>. It is called at these places:</p>\n\n<p>In <code>buf_pullup</code>:</p>\n<pre class=\"highlight c\"><code> <span class=\"mi\">210</span>     <span class=\"n\">newsize</span> <span class=\"o\">=</span> <span class=\"n\">CHUNK_SIZE_WITH_ALLOC</span><span class=\"p\">(</span><span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">capacity</span><span class=\"p\">));</span>\n <span class=\"mi\">211</span>     <span class=\"n\">newhead</span> <span class=\"o\">=</span> <span class=\"n\">chunk_grow</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"o\">-&gt;</span><span class=\"n\">head</span><span class=\"p\">,</span> <span class=\"n\">newsize</span><span class=\"p\">);</span>\n</code></pre>\n<p>In <code>buf_new_with_capacity</code>:</p>\n<pre class=\"highlight c\"><code> <span class=\"mi\">283</span> <span class=\"cm\">/** Create and return a new buf with default chunk capacity &lt;b&gt;size&lt;/b&gt;.\n 284  */</span>\n <span class=\"mi\">285</span> <span class=\"n\">buf_t</span> <span class=\"o\">*</span>\n <span class=\"mi\">286</span> <span class=\"n\">buf_new_with_capacity</span><span class=\"p\">(</span><span class=\"kt\">size_t</span> <span class=\"n\">size</span><span class=\"p\">)</span>\n <span class=\"mi\">287</span> <span class=\"p\">{</span>\n <span class=\"mi\">288</span>   <span class=\"n\">buf_t</span> <span class=\"o\">*</span><span class=\"n\">b</span> <span class=\"o\">=</span> <span class=\"n\">buf_new</span><span class=\"p\">();</span>\n <span class=\"mi\">289</span>   <span class=\"n\">b</span><span class=\"o\">-&gt;</span><span class=\"n\">default_chunk_size</span> <span class=\"o\">=</span> <span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">);</span>\n <span class=\"mi\">290</span>   <span class=\"k\">return</span> <span class=\"n\">b</span><span class=\"p\">;</span>\n <span class=\"mi\">291</span> <span class=\"p\">}</span>\n</code></pre>\n<p>In <code>buf_add_chunk_with_capacity</code>:</p>\n<pre class=\"highlight c\"><code> <span class=\"mi\">401</span> <span class=\"cm\">/** Append a new chunk with enough capacity to hold &lt;b&gt;capacity&lt;/b&gt; bytes to\n 402  * the tail of &lt;b&gt;buf&lt;/b&gt;.  If &lt;b&gt;capped&lt;/b&gt;, don&#39;t allocate a chunk bigger\n 403  * than MAX_CHUNK_ALLOC. */</span>\n <span class=\"mi\">404</span> <span class=\"k\">static</span> <span class=\"n\">chunk_t</span> <span class=\"o\">*</span>\n <span class=\"mi\">405</span> <span class=\"n\">buf_add_chunk_with_capacity</span><span class=\"p\">(</span><span class=\"n\">buf_t</span> <span class=\"o\">*</span><span class=\"n\">buf</span><span class=\"p\">,</span> <span class=\"kt\">size_t</span> <span class=\"n\">capacity</span><span class=\"p\">,</span> <span class=\"kt\">int</span> <span class=\"n\">capped</span><span class=\"p\">)</span>\n <span class=\"mi\">406</span> <span class=\"p\">{</span>\n <span class=\"mi\">407</span>   <span class=\"n\">chunk_t</span> <span class=\"o\">*</span><span class=\"n\">chunk</span><span class=\"p\">;</span>\n <span class=\"mi\">408</span> \n <span class=\"mi\">409</span>   <span class=\"nf\">if</span> <span class=\"p\">(</span><span class=\"n\">CHUNK_ALLOC_SIZE</span><span class=\"p\">(</span><span class=\"n\">capacity</span><span class=\"p\">)</span> <span class=\"o\">&lt;</span> <span class=\"n\">buf</span><span class=\"o\">-&gt;</span><span class=\"n\">default_chunk_size</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n <span class=\"mi\">410</span>     <span class=\"n\">chunk</span> <span class=\"o\">=</span> <span class=\"n\">chunk_new_with_alloc_size</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"o\">-&gt;</span><span class=\"n\">default_chunk_size</span><span class=\"p\">);</span>\n <span class=\"mi\">411</span>   <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"nf\">if</span> <span class=\"p\">(</span><span class=\"n\">capped</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">CHUNK_ALLOC_SIZE</span><span class=\"p\">(</span><span class=\"n\">capacity</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"n\">MAX_CHUNK_ALLOC</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n <span class=\"mi\">412</span>     <span class=\"n\">chunk</span> <span class=\"o\">=</span> <span class=\"n\">chunk_new_with_alloc_size</span><span class=\"p\">(</span><span class=\"n\">MAX_CHUNK_ALLOC</span><span class=\"p\">);</span>\n <span class=\"mi\">413</span>   <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n <span class=\"mi\">414</span>     <span class=\"n\">chunk</span> <span class=\"o\">=</span> <span class=\"n\">chunk_new_with_alloc_size</span><span class=\"p\">(</span><span class=\"n\">preferred_chunk_size</span><span class=\"p\">(</span><span class=\"n\">capacity</span><span class=\"p\">));</span>\n <span class=\"mi\">415</span>   <span class=\"p\">}</span>\n</code></pre>\n<p><code>buf_new_with_capacity</code> is currently called nowhere except for tests.<br>\n<code>buf_add_chunk_with_capacity</code> is called at various places but currently not with the <code>capped</code> parameter set to 0.</p>\n\n<p>However, <code>buf_pullup</code> is called at various places and the call to <code>preferred_chunk_size</code> is reachable. Whether it is reachable with a parameter large enough that it will return 0 I&#39;m not sure about.</p>\n<pre class=\"highlight c\"><code><span class=\"kt\">int</span>\n<span class=\"nf\">tor_main</span><span class=\"p\">(</span><span class=\"kt\">int</span> <span class=\"n\">argc</span><span class=\"p\">,</span> <span class=\"kt\">char</span> <span class=\"o\">*</span><span class=\"n\">argv</span><span class=\"p\">[])</span>\n<span class=\"p\">{</span>\n    <span class=\"n\">buf_t</span><span class=\"o\">*</span> <span class=\"n\">buf</span><span class=\"p\">;</span>\n    <span class=\"kt\">char</span><span class=\"o\">*</span> <span class=\"n\">string</span><span class=\"p\">;</span>\n    <span class=\"kt\">size_t</span> <span class=\"n\">string_len</span><span class=\"p\">;</span>\n    <span class=\"kt\">size_t</span> <span class=\"n\">i</span><span class=\"p\">;</span>\n\n    <span class=\"n\">buf</span> <span class=\"o\">=</span> <span class=\"n\">buf_new</span><span class=\"p\">();</span>\n    <span class=\"n\">string_len</span> <span class=\"o\">=</span> <span class=\"mh\">0x00001000</span><span class=\"p\">;</span>\n    <span class=\"n\">string</span> <span class=\"o\">=</span> <span class=\"n\">tor_malloc</span><span class=\"p\">(</span><span class=\"n\">string_len</span><span class=\"p\">);</span>\n    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"n\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"mi\">507904</span><span class=\"p\">;</span> <span class=\"n\">i</span><span class=\"o\">++</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n        <span class=\"n\">write_to_buf</span><span class=\"p\">(</span><span class=\"n\">string</span><span class=\"p\">,</span> <span class=\"n\">string_len</span><span class=\"p\">,</span> <span class=\"n\">buf</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n    <span class=\"n\">write_to_buf</span><span class=\"p\">(</span><span class=\"n\">string</span><span class=\"p\">,</span> <span class=\"mh\">0x3FFFFFA</span><span class=\"p\">,</span> <span class=\"n\">buf</span><span class=\"p\">);</span>\n    <span class=\"n\">free</span><span class=\"p\">(</span><span class=\"n\">string</span><span class=\"p\">);</span>\n    <span class=\"n\">buf_pullup</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">,</span> <span class=\"mh\">0x90000000</span><span class=\"p\">);</span> \n<span class=\"p\">}</span>\n</code></pre>\n<p>What will happen is that <code>buf_pullup</code> will call <code>chunk_grow</code></p>\n<pre class=\"highlight c\"><code> <span class=\"mi\">140</span> <span class=\"k\">static</span> <span class=\"kr\">inline</span> <span class=\"n\">chunk_t</span> <span class=\"o\">*</span>\n <span class=\"mi\">141</span> <span class=\"n\">chunk_grow</span><span class=\"p\">(</span><span class=\"n\">chunk_t</span> <span class=\"o\">*</span><span class=\"n\">chunk</span><span class=\"p\">,</span> <span class=\"kt\">size_t</span> <span class=\"n\">sz</span><span class=\"p\">)</span>\n <span class=\"mi\">142</span> <span class=\"p\">{</span>\n <span class=\"mi\">143</span>   <span class=\"kt\">off_t</span> <span class=\"n\">offset</span><span class=\"p\">;</span>\n <span class=\"mi\">144</span>   <span class=\"kt\">size_t</span> <span class=\"n\">memlen_orig</span> <span class=\"o\">=</span> <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">memlen</span><span class=\"p\">;</span>\n <span class=\"mi\">145</span>   <span class=\"n\">tor_assert</span><span class=\"p\">(</span><span class=\"n\">sz</span> <span class=\"o\">&gt;</span> <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">memlen</span><span class=\"p\">);</span>\n <span class=\"mi\">146</span>   <span class=\"n\">offset</span> <span class=\"o\">=</span> <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span> <span class=\"o\">-</span> <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">mem</span><span class=\"p\">;</span>\n <span class=\"mi\">147</span>   <span class=\"n\">chunk</span> <span class=\"o\">=</span> <span class=\"n\">tor_realloc</span><span class=\"p\">(</span><span class=\"n\">chunk</span><span class=\"p\">,</span> <span class=\"n\">CHUNK_ALLOC_SIZE</span><span class=\"p\">(</span><span class=\"n\">sz</span><span class=\"p\">));</span>\n <span class=\"mi\">148</span>   <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">memlen</span> <span class=\"o\">=</span> <span class=\"n\">sz</span><span class=\"p\">;</span>\n <span class=\"mi\">149</span>   <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">mem</span> <span class=\"o\">+</span> <span class=\"n\">offset</span><span class=\"p\">;</span>\n</code></pre>\n<p><code>tor_realloc</code> will in effect be called with a size parameter of 0. Whether and how much legitimate heap memory <code>realloc</code> will allocate might be implementation-dependent. The point is that the following lines might overwrite heap memory:</p>\n<pre class=\"highlight c\"><code> <span class=\"mi\">148</span>   <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">memlen</span> <span class=\"o\">=</span> <span class=\"n\">sz</span><span class=\"p\">;</span>\n <span class=\"mi\">149</span>   <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">chunk</span><span class=\"o\">-&gt;</span><span class=\"n\">mem</span> <span class=\"o\">+</span> <span class=\"n\">offset</span><span class=\"p\">;</span>\n</code></pre>\n<p>since <code>chunk</code> is a memory area that has just been allocated to 0 (or 1, after correction) bytes.</p>\n\n<p>The whole scenario is not very likely considering Tor&#39;s frugal memory consumption but it is nonetheless a programming fault in the buffers &quot;API&quot; that could lead to stability issues. Especially if you ever expand the use of <code>buf_pullup</code>, <code>buf_new_with_capacity</code>, and/or uncapped <code>buf_add_chunk_with_capacity</code>, it&#39;ll be wise to hard-limit the amounts of right-shifts in <code>preferred_chunk_size</code> (a single unintended negative integer -&gt; size_t can be conducive in establishing an exploitation path).</p>\n", 
    "vulnerability_information": "In ```or/buffer.s.c```:\n```c\n/** Return the allocation size we'd like to use to hold <b>target</b>\n * bytes. */\nstatic inline size_t\npreferred_chunk_size(size_t target)\n{\n  size_t sz = MIN_CHUNK_ALLOC;\n  while (CHUNK_SIZE_WITH_ALLOC(sz) < target) {\n    sz <<= 1;\n  }\n  return sz;\n}\n```\n\n```c\n#define MIN_CHUNK_ALLOC 256\n#define CHUNK_SIZE_WITH_ALLOC(memlen) ((memlen) - CHUNK_HEADER_LEN)\n```\n\nCHUNK_HEADER_LEN is usually around 30 bytes or so.\n\nThe problem with ```preferred_chunk_size``` is that for a large ```size_t target```, the function will return 0.\n\nIf you compile this program with ```-m32```:\n\n```c\n#include <stdio.h>\n#include <stdint.h>\n#define FLEXIBLE_ARRAY_MEMBER /**/\n#define DEBUG_CHUNK_ALLOC\n/** A single chunk on a buffer. */\ntypedef struct chunk_t {\n  struct chunk_t *next; /**< The next chunk on the buffer. */\n  size_t datalen; /**< The number of bytes stored in this chunk */\n  size_t memlen; /**< The number of usable bytes of storage in <b>mem</b>. */\n#ifdef DEBUG_CHUNK_ALLOC\n  size_t DBG_alloc;\n#endif\n  char *data; /**< A pointer to the first byte of data stored in <b>mem</b>. */\n  uint32_t inserted_time; /**< Timestamp in truncated ms since epoch\n                           * when this chunk was inserted. */\n  char mem[FLEXIBLE_ARRAY_MEMBER]; /**< The actual memory used for storage in\n                * this chunk. */\n} chunk_t;\n#if defined(__GNUC__) && __GNUC__ > 3\n#define STRUCT_OFFSET(tp, member) __builtin_offsetof(tp, member)\n#else\n #define STRUCT_OFFSET(tp, member) \\\n   ((off_t) (((char*)&((tp*)0)->member)-(char*)0))\n#endif\n#define MIN_CHUNK_ALLOC 256\n#define CHUNK_HEADER_LEN STRUCT_OFFSET(chunk_t, mem[0])\n#define CHUNK_SIZE_WITH_ALLOC(memlen) ((memlen) - CHUNK_HEADER_LEN)\nstatic inline size_t\npreferred_chunk_size(size_t target)\n{\n  size_t sz = MIN_CHUNK_ALLOC;\n  while (CHUNK_SIZE_WITH_ALLOC(sz) < target) {\n    sz <<= 1;\n  }\n  return sz;\n}\n\nint main(void)\n{\n    size_t i = 1024;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    printf(\"i is %08X, preferred_chunk_size is %08X\\n\", i, preferred_chunk_size(i)); i <<= 1;\n    return 0;\n}\n```\n\nthe output is:\n\n```\ni is 00000400, preferred_chunk_size is 00000800\ni is 00000800, preferred_chunk_size is 00001000\ni is 00001000, preferred_chunk_size is 00002000\ni is 00002000, preferred_chunk_size is 00004000\ni is 00004000, preferred_chunk_size is 00008000\ni is 00008000, preferred_chunk_size is 00010000\ni is 00010000, preferred_chunk_size is 00020000\ni is 00020000, preferred_chunk_size is 00040000\ni is 00040000, preferred_chunk_size is 00080000\ni is 00080000, preferred_chunk_size is 00100000\ni is 00100000, preferred_chunk_size is 00200000\ni is 00200000, preferred_chunk_size is 00400000\ni is 00400000, preferred_chunk_size is 00800000\ni is 00800000, preferred_chunk_size is 01000000\ni is 01000000, preferred_chunk_size is 02000000\ni is 02000000, preferred_chunk_size is 04000000\ni is 04000000, preferred_chunk_size is 08000000\ni is 08000000, preferred_chunk_size is 10000000\ni is 10000000, preferred_chunk_size is 20000000\ni is 20000000, preferred_chunk_size is 40000000\ni is 40000000, preferred_chunk_size is 80000000\ni is 80000000, preferred_chunk_size is 00000000\n```\n\nThe danger is that the return value of ```preferred_chunk_size``` is always used as a parameter to ```tor_malloc``` or ```tor_realloc```. It is called at these places:\n\nIn ```buf_pullup```:\n```c\n 210     newsize = CHUNK_SIZE_WITH_ALLOC(preferred_chunk_size(capacity));\n 211     newhead = chunk_grow(buf->head, newsize);\n```\n\nIn ```buf_new_with_capacity```:\n```c\n 283 /** Create and return a new buf with default chunk capacity <b>size</b>.\n 284  */\n 285 buf_t *\n 286 buf_new_with_capacity(size_t size)\n 287 {\n 288   buf_t *b = buf_new();\n 289   b->default_chunk_size = preferred_chunk_size(size);\n 290   return b;\n 291 }\n```\n\nIn ```buf_add_chunk_with_capacity```:\n```c\n 401 /** Append a new chunk with enough capacity to hold <b>capacity</b> bytes to\n 402  * the tail of <b>buf</b>.  If <b>capped</b>, don't allocate a chunk bigger\n 403  * than MAX_CHUNK_ALLOC. */\n 404 static chunk_t *\n 405 buf_add_chunk_with_capacity(buf_t *buf, size_t capacity, int capped)\n 406 {\n 407   chunk_t *chunk;\n 408 \n 409   if (CHUNK_ALLOC_SIZE(capacity) < buf->default_chunk_size) {\n 410     chunk = chunk_new_with_alloc_size(buf->default_chunk_size);\n 411   } else if (capped && CHUNK_ALLOC_SIZE(capacity) > MAX_CHUNK_ALLOC) {\n 412     chunk = chunk_new_with_alloc_size(MAX_CHUNK_ALLOC);\n 413   } else {\n 414     chunk = chunk_new_with_alloc_size(preferred_chunk_size(capacity));\n 415   }\n```\n\n```buf_new_with_capacity``` is currently called nowhere except for tests.\n```buf_add_chunk_with_capacity``` is called at various places but currently not with the ```capped``` parameter set to 0.\n\nHowever, ```buf_pullup``` is called at various places and the call to ```preferred_chunk_size``` is reachable. Whether it is reachable with a parameter large enough that it will return 0 I'm not sure about.\n\n```c\nint\ntor_main(int argc, char *argv[])\n{\n    buf_t* buf;\n    char* string;\n    size_t string_len;\n    size_t i;\n\n    buf = buf_new();\n    string_len = 0x00001000;\n    string = tor_malloc(string_len);\n    for (i = 0; i < 507904; i++)\n    {\n        write_to_buf(string, string_len, buf);\n    }\n    write_to_buf(string, 0x3FFFFFA, buf);\n    free(string);\n    buf_pullup(buf, 0x90000000); \n}\n```\n\nWhat will happen is that ```buf_pullup``` will call ```chunk_grow```\n```c\n 140 static inline chunk_t *\n 141 chunk_grow(chunk_t *chunk, size_t sz)\n 142 {\n 143   off_t offset;\n 144   size_t memlen_orig = chunk->memlen;\n 145   tor_assert(sz > chunk->memlen);\n 146   offset = chunk->data - chunk->mem;\n 147   chunk = tor_realloc(chunk, CHUNK_ALLOC_SIZE(sz));\n 148   chunk->memlen = sz;\n 149   chunk->data = chunk->mem + offset;\n```\n\n```tor_realloc``` will in effect be called with a size parameter of 0. Whether and how much legitimate heap memory ```realloc``` will allocate might be implementation-dependent. The point is that the following lines might overwrite heap memory:\n\n```c\n 148   chunk->memlen = sz;\n 149   chunk->data = chunk->mem + offset;\n```\n\nsince ```chunk``` is a memory area that has just been allocated to 0 (or 1, after correction) bytes.\n\nThe whole scenario is not very likely considering Tor's frugal memory consumption but it is nonetheless a programming fault in the buffers \"API\" that could lead to stability issues. Especially if you ever expand the use of ```buf_pullup```, ```buf_new_with_capacity```, and/or uncapped ```buf_add_chunk_with_capacity```, it'll be wise to hard-limit the amounts of right-shifts in ```preferred_chunk_size``` (a single unintended negative integer -> size_t can be conducive in establishing an exploitation path).", 
    "team_private?": false, 
    "team": {
        "profile": {
            "website": "https://www.torproject.org/", 
            "about": "Anonymity Online", 
            "twitter_handle": "torproject", 
            "name": "Tor"
        }, 
        "handle": "torproject", 
        "url": "https://hackerone.com/torproject", 
        "state": "public_mode", 
        "profile_picture_urls": {
            "small": "https://profile-photos.hackerone-user-content.com/000/001/800/fe36670e5f7b7381549279801c447ae8a3ee12b0_small.jpg?1453239375", 
            "medium": "https://profile-photos.hackerone-user-content.com/000/001/800/f60c4e0509668a31fcd9604fc653ef8a43f2e5c4_medium.jpg?1453239375"
        }, 
        "awards_miles": false, 
        "permissions": [], 
        "id": 1800, 
        "default_currency": "usd"
    }, 
    "is_published": false
}